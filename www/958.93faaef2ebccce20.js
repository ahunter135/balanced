"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[958],{3554:(N,U,f)=>{f.d(U,{e:()=>d});var e=f(6814),I=f(95),p=f(5548),l=f(6689);let d=(()=>{class s{}return s.\u0275fac=function(t){return new(t||s)},s.\u0275mod=l.oAB({type:s}),s.\u0275inj=l.cJS({imports:[e.ez,I.u5,p.Pc]}),s})()},1269:(N,U,f)=>{f.d(U,{O:()=>p});var e=f(6689),I=f(9862);let p=(()=>{class l{constructor(s){this.http=s}post(s,r){return this.http.post(s,r,{headers:this.getHeaders()})}getHeaders(){return{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}}}return l.\u0275fac=function(s){return new(s||l)(e.LFG(I.eN))},l.\u0275prov=e.Yz7({token:l,factory:l.\u0275fac,providedIn:"root"}),l})()},3990:(N,U,f)=>{f.d(U,{O:()=>P});var e=f(5861),I=f(6306),p=f(6973);function l(g,y){const _="object"==typeof y;return new Promise((S,A)=>{let v,b=!1;g.subscribe({next:D=>{v=D,b=!0},error:A,complete:()=>{b?S(v):_?S(y.defaultValue):A(new p.K)}})})}var d=f(553);const s=d.N.useFunctionsEmulator&&!d.N.production?"http://localhost:5001/balanced-budget-90f1f/us-central1/":"https://us-central1-balanced-budget-90f1f.cloudfunctions.net/",r=s+"getTransactionData",t=s+"createPlaidLinkToken",o=s+"exchangePublicToken";function c(g){const y=g.datetime?new Date(g.datetime):new Date(g.date);return{id:g.transaction_id,amount:g.amount,subcategoryId:"",date:y,merchant_name:g.merchant_name,name:g.name,pending:g.pending}}var n=f(6689),a=f(1269),u=f(4092),h=f(182),E=f(15);let m=(()=>{class g extends u.q{constructor(){super(h.lN)}get(_,S){var A=()=>super._get,b=this;return(0,e.Z)(function*(){const v=yield A().call(b,g.makeCollectionRef(_),S);return b.convertTimestampToDate(v)})()}getAll(){var _=()=>super._getAll,S=this;return(0,e.Z)(function*(){const A=yield _().call(S);return A.docs&&(A.docs=A.docs.map(b=>S.convertTimestampToDate(b))),A})()}getAllFromParent(_){var S=()=>super._getAllFromParent,A=this;return(0,e.Z)(function*(){const b=yield S().call(A,g.makeCollectionRef(_));return b.docs&&(b.docs=b.docs.map(v=>A.convertTimestampToDate(v))),b})()}getByQuery(_){var S=()=>super._getByQuery,A=this;return(0,e.Z)(function*(){const b=yield S().call(A,_);return b.docs&&(b.docs=b.docs.map(v=>A.convertTimestampToDate(v))),b})()}add(_,S,A){var b=()=>super._add,v=this;return(0,e.Z)(function*(){return b().call(v,g.makeCollectionRef(_),S,A)})()}update(_,S,A){var b=()=>super._update,v=this;return(0,e.Z)(function*(){return b().call(v,g.makeCollectionRef(_),S,A)})()}delete(_,S,A=!1){var b=()=>super._delete,v=this;return(0,e.Z)(function*(){return b().call(v,g.makeCollectionRef(_),S,A)})()}static makeCollectionRef(_){return(0,E.hJ)((0,E.ad)(),h.YP,_,h.lN)}convertTimestampToDate(_){if(!_)return _;const S=_.last_transaction_retrieval;return S&&(_.last_transaction_retrieval=S.toDate()),_}}return g.\u0275fac=function(_){return new(_||g)},g.\u0275prov=n.Yz7({token:g,factory:g.\u0275fac,providedIn:"root"}),g})();var R=f(7195),O=f(6635),T=f(5548);let P=(()=>{class g{constructor(_,S,A,b,v){this.http=_,this.linkedAccountsRepository=S,this.userRepository=A,this.transactionPublisher=b,this.loadingController=v}linkPlaidToUser(){var _=this;return(0,e.Z)(function*(){const S=yield _.loadingController.create();yield S.present(),_.http.post(t,{user_id:_.userRepository.getCurrentUserId()}).pipe((0,I.K)(A=>(console.log(A),S.dismiss(),A))).subscribe(A=>{console.log(A);const b=_.createPlaidHandler(A.link_token);S.dismiss(),b.open()})})()}syncPlaidTransactions(){var _=this;return(0,e.Z)(function*(){const S=_.userRepository.getCurrentUserId();if(!S)throw new Error("User is not logged in");const A=(yield _.linkedAccountsRepository.getAllFromParent(S)).docs;if(0===A.length)return;const b=[];for(let w of A)(yield _.shouldSyncTransactions(w))&&b.push(l(_.http.post(r,{userId:S,linkedAccount:w,linkedAccountId:w.id})));const v=yield Promise.all(b);let D=[],L=[],C=[];for(let w=0;w<v.length;w++){const M=v[w];D=D.concat(M.added),L=L.concat(M.removed),C=C.concat(M.modified)}_.plaidTransactionSyncHandler(D,L,C,!0)})()}createPlaidHandler(_){return Plaid.create({token:_,onSuccess:this.plaidHandlerOnSuccessCallback.bind(this),onExit:this.plaidHandlerOnExitCallback.bind(this),onLoad:this.plaidHandlerOnLoadCallback.bind(this),onEvent:this.plaidHandlerOnEventCallback.bind(this),receivedRedirectUri:null})}plaidHandlerOnSuccessCallback(_,S){this.http.post(o,{publicToken:_,institutionName:S.institution.name,userId:this.userRepository.getCurrentUserId()}).subscribe(A=>{console.log(A);const{added:b,removed:v,modified:D}=A;this.plaidTransactionSyncHandler(b,v,D,!0)})}plaidHandlerOnExitCallback(_,S){return(0,e.Z)(function*(){console.log(_)})()}plaidHandlerOnLoadCallback(){return(0,e.Z)(function*(){})()}plaidHandlerOnEventCallback(_,S){return(0,e.Z)(function*(){})()}plaidTransactionSyncHandler(_,S,A,b=!0){var v=this;return(0,e.Z)(function*(){const w={from:"plaid",addedTransactions:_.map(c),removedTransactions:S.map(c),modifiedTransactions:A.map(c)};return b&&v.transactionPublisher.publishEvent(w),w})()}shouldSyncTransactions(_){return(0,e.Z)(function*(){if(!_.last_transaction_retrieval)return!0;const A=_.last_transaction_retrieval;return(new Date).getTime()-A.getTime()>3e5})()}}return g.\u0275fac=function(_){return new(_||g)(n.LFG(a.O),n.LFG(m),n.LFG(R.E),n.LFG(O.u),n.LFG(T.HT))},g.\u0275prov=n.Yz7({token:g,factory:g.\u0275fac,providedIn:"root"}),g})()},6635:(N,U,f)=>{f.d(U,{u:()=>I});var e=f(6689);let I=(()=>{class p{constructor(){this.subscribers=new Set}publishEvent(d){console.log("Publishing event",d),this.subscribers.forEach(s=>{s.onTransactionEvent(d)})}subscribe(d){this.subscribers.add(d)}unsubscribe(d){this.subscribers.delete(d)}}return p.\u0275fac=function(d){return new(d||p)},p.\u0275prov=e.Yz7({token:p,factory:p.\u0275fac,providedIn:"root"}),p})()},958:(N,U,f)=>{f.r(U),f.d(U,{Tab3PageModule:()=>P});var e=f(5548),I=f(6814),p=f(95),l=f(3554),d=f(2607),s=f(5861),r=f(7826),t=f(6689),o=f(1776),i=f(3251),c=f(3990),n=f(3076);f(3382);let u=(()=>{class g{constructor(_,S,A,b){this.platform=_,this.loadingCtrl=S,this.userService=A,this.alertCtrl=b,this.products=[],this.premium_yearly_id=(this.platform.is("ios"),"premium_yearly"),this.premium_id=(this.platform.is("ios"),"premium_sub"),this.platform.ready().then(()=>{this.platform.is("mobile")?(this.store=CdvPurchase.store,this.registerProducts(),this.setupListeners(),this.store.initialize([this.platform.is("ios")?CdvPurchase.Platform.APPLE_APPSTORE:CdvPurchase.Platform.GOOGLE_PLAY]),this.store.ready(()=>{this.products=this.store.products})):this.platform.is("desktop")})}registerProducts(){this.store.register([{type:CdvPurchase.ProductType.PAID_SUBSCRIPTION,id:this.premium_id,platform:this.platform.is("ios")?CdvPurchase.Platform.APPLE_APPSTORE:CdvPurchase.Platform.GOOGLE_PLAY},{type:CdvPurchase.ProductType.PAID_SUBSCRIPTION,id:this.premium_yearly_id,platform:this.platform.is("ios")?CdvPurchase.Platform.APPLE_APPSTORE:CdvPurchase.Platform.GOOGLE_PLAY}])}setupListeners(){this.store.when().approved(_=>((_.products[0].id===this.premium_id||_.products[0].id===this.premium_yearly_id)&&this.userService.updatePremiumStatus(!0),_.verify())).verified(_=>_.finish()).unverified(_=>_.finish()).finished(()=>{this.loader&&this.loader.dismiss()})}startPurchase(_){var S=this;return(0,s.Z)(function*(){let A;for(let b=0;b<S.products.length;b++)if(S.products[b].id==_){A=S.products[b];break}S.purchase(A)})()}purchase(_){var S=this;return(0,s.Z)(function*(){S.loader=yield S.loadingCtrl.create({message:"Loading..."}),yield S.loader.present();let A=_.getOffer();A&&S.store.order(A).then(b=>{},b=>{S.loader.dismiss(),S.presentAlert("Failed",`Failed to purchase: ${b}`)}).finally(()=>{S.loader.dismiss()})})()}restore(){this.store.restorePurchases()}presentAlert(_,S){var A=this;return(0,s.Z)(function*(){yield(yield A.alertCtrl.create({header:_,message:S,buttons:["OK"]})).present()})()}}return g.\u0275fac=function(_){return new(_||g)(t.LFG(e.t4),t.LFG(e.HT),t.LFG(n.K),t.LFG(e.Br))},g.\u0275prov=t.Yz7({token:g,factory:g.\u0275fac,providedIn:"root"}),g})();function h(g,y){if(1&g&&(t.TgZ(0,"p",16),t._uU(1),t.qZA()),2&g){const _=t.oxw(2);t.xp6(1),t.hij(" ",_.inapp.products[0].raw.price,"/month ")}}function E(g,y){if(1&g&&(t.TgZ(0,"p",16),t._uU(1),t.qZA()),2&g){const _=t.oxw(2);t.xp6(1),t.hij(" ",_.inapp.products[1].raw.price,"/year ")}}function m(g,y){if(1&g){const _=t.EpF();t.TgZ(0,"ion-card")(1,"ion-card-content")(2,"div",7)(3,"header"),t._UZ(4,"lottie-player",8),t.qZA(),t.TgZ(5,"section",9)(6,"h2"),t._uU(7,"Why Go Pro?"),t.qZA(),t.TgZ(8,"ul")(9,"li"),t._uU(10,"\u{1f680} Automatic Transaction Imports"),t.qZA(),t.TgZ(11,"li"),t._uU(12,"\u{1f552} Save Time with No More Manual Entries"),t.qZA(),t.TgZ(13,"li"),t._uU(14,"\u{1f3a8} Change the app's overall theme"),t.qZA()()(),t.TgZ(15,"section",10)(16,"h2"),t._uU(17,"Choose Your Plan"),t.qZA(),t.TgZ(18,"span",11)(19,"div",12)(20,"h3"),t._uU(21,"Monthly Plan"),t.qZA(),t.YNc(22,h,2,1,"p",13),t.TgZ(23,"p"),t._uU(24,"After 7-day Free Trial"),t.qZA(),t.TgZ(25,"button",14),t.NdJ("click",function(){t.CHM(_);const A=t.oxw();return t.KtG(A.purchase("premium_sub"))}),t._uU(26,"Go Monthly"),t.qZA()(),t.TgZ(27,"div",15)(28,"h3"),t._uU(29,"Yearly Plan"),t.qZA(),t.YNc(30,E,2,1,"p",13),t.TgZ(31,"p"),t._uU(32,"After 7-day Free Trial"),t.qZA(),t.TgZ(33,"button",14),t.NdJ("click",function(){t.CHM(_);const A=t.oxw();return t.KtG(A.purchase("premium_yearly"))}),t._uU(34,"Go Yearly"),t.qZA()()()()()()()}if(2&g){const _=t.oxw();t.xp6(22),t.Q6J("ngIf",_.inapp.products.length>0),t.xp6(8),t.Q6J("ngIf",_.inapp.products.length>0)}}const O=[{path:"",component:(()=>{class g{constructor(_,S,A,b,v,D,L){this.authService=_,this.router=S,this.alertService=A,this.plaidService=b,this.userService=v,this.inapp=D,this.alertCtrl=L}link(){var _=this;return(0,s.Z)(function*(){_.plaidService.linkPlaidToUser()})()}signOut(){var _=this;return(0,s.Z)(function*(){(yield _.authService.logout())?_.router.navigateByUrl("login"):_.alertService.createAndShowToast("There was an error logging out")})()}purchase(_){this.inapp.startPurchase(_)}goToThemes(){this.router.navigateByUrl("tabs/tab3/themes")}deleteAccount(){var _=this;return(0,s.Z)(function*(){var A;(yield _.alertCtrl.create({header:"Are you sure you want to delete your account?",buttons:[{text:"Yes",role:"destructive",handler:(A=(0,s.Z)(function*(){const b=yield _.authService.getCurrentAuthUser();(0,r.h8)(b).then(()=>window.location.reload())}),function(){return A.apply(this,arguments)})},{text:"No",handler:function(){var A=(0,s.Z)(function*(){});return function(){return A.apply(this,arguments)}}()}]})).present()})()}}return g.\u0275fac=function(_){return new(_||g)(t.Y36(o.e),t.Y36(d.F0),t.Y36(i.c),t.Y36(c.O),t.Y36(n.K),t.Y36(u),t.Y36(e.Br))},g.\u0275cmp=t.Xpm({type:g,selectors:[["app-tab3"]],decls:25,vars:5,consts:[[3,"translucent"],[3,"fullscreen"],["collapse","condense"],["size","large"],[4,"ngIf"],["button","",3,"disabled","click"],["button","",3,"click"],[1,"container"],["slot","end","autoplay","","loop","","src","https://lottie.host/1a9b80ea-1cb9-4b02-929a-0a9d8e7fcee2/bdrGIZRYXV.json"],[1,"benefits"],[1,"pricing"],[1,"row"],["id","monthly",1,"plan"],["class","price",4,"ngIf"],[3,"click"],["id","yearly",1,"plan"],[1,"price"]],template:function(_,S){1&_&&(t.TgZ(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),t._uU(3," Accounts "),t.qZA()()(),t.TgZ(4,"ion-content",1)(5,"ion-header",2)(6,"ion-toolbar")(7,"ion-title",3),t._uU(8,"Accounts"),t.qZA()()(),t.YNc(9,m,35,2,"ion-card",4),t.TgZ(10,"ion-card")(11,"ion-card-content")(12,"ion-list")(13,"ion-item",5),t.NdJ("click",function(){return S.link()}),t.TgZ(14,"ion-label"),t._uU(15,"Link Account"),t.qZA()(),t.TgZ(16,"ion-item",5),t.NdJ("click",function(){return S.goToThemes()}),t.TgZ(17,"ion-label"),t._uU(18,"Change App Theme"),t.qZA()(),t.TgZ(19,"ion-item",6),t.NdJ("click",function(){return S.deleteAccount()}),t.TgZ(20,"ion-label"),t._uU(21,"Delete Account"),t.qZA()(),t.TgZ(22,"ion-item",6),t.NdJ("click",function(){return S.signOut()}),t.TgZ(23,"ion-label"),t._uU(24,"Sign Out"),t.qZA()()()()()()),2&_&&(t.Q6J("translucent",!0),t.xp6(4),t.Q6J("fullscreen",!0),t.xp6(5),t.Q6J("ngIf",!S.userService.isPremium),t.xp6(4),t.Q6J("disabled",!S.userService.isPremium),t.xp6(3),t.Q6J("disabled",!S.userService.isPremium))},dependencies:[e.PM,e.FN,e.W2,e.Gu,e.Ie,e.Q$,e.q_,e.wd,e.sr,I.O5],styles:["ion-title[_ngcontent-%COMP%]{background:#f3f3f3}ion-toolbar[_ngcontent-%COMP%]{padding:0!important}.container[_ngcontent-%COMP%]{max-width:800px;margin:20px auto;padding:20px;border-radius:8px}header[_ngcontent-%COMP%]{text-align:center;display:flex;flex-direction:row;justify-content:center}header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{color:#00eabb}.benefits[_ngcontent-%COMP%]{margin:20px 0}.benefits[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%], .pricing[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{text-align:center;color:#2980b9}.benefits[_ngcontent-%COMP%]   ul[_ngcontent-%COMP%]{list-style:none;padding:0}.benefits[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{margin:10px 0;font-size:18px}.pricing[_ngcontent-%COMP%]{text-align:center}.pricing[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]{display:flex;flex-direction:row;justify-content:center;flex-wrap:nowrap}.plan[_ngcontent-%COMP%]{display:flex;min-width:50%;max-width:50%;margin:10px;padding:20px;background:#f9f9f9;border:1px solid #ddd;border-radius:8px;flex-direction:column;flex-wrap:nowrap;align-items:center;justify-content:center}.plan[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{color:#2980b9}.price[_ngcontent-%COMP%]{font-size:20px;color:#000}button[_ngcontent-%COMP%]{width:100%;padding:10px;border:none;border-radius:5px;background-color:#00eabb;color:#fff;font-size:18px;cursor:pointer;margin-top:10px}button[_ngcontent-%COMP%]:hover{background-color:#00cea5}lottie-player[_ngcontent-%COMP%]{width:225px;margin-top:-90px;text-align:center}"]}),g})()},{path:"themes",loadChildren:()=>f.e(6344).then(f.bind(f,6344)).then(g=>g.ThemesPageModule)}];let T=(()=>{class g{}return g.\u0275fac=function(_){return new(_||g)},g.\u0275mod=t.oAB({type:g}),g.\u0275inj=t.cJS({imports:[d.Bz.forChild(O),d.Bz]}),g})(),P=(()=>{class g{}return g.\u0275fac=function(_){return new(_||g)},g.\u0275mod=t.oAB({type:g}),g.\u0275inj=t.cJS({imports:[e.Pc,I.ez,p.u5,l.e,T]}),g})()},3382:function(){var e,f,N=this&&this.__awaiter||function(e,I,p,l){return new(p||(p=Promise))(function(s,r){function t(c){try{i(l.next(c))}catch(n){r(n)}}function o(c){try{i(l.throw(c))}catch(n){r(n)}}function i(c){c.done?s(c.value):function d(s){return s instanceof p?s:new p(function(r){r(s)})}(c.value).then(t,o)}i((l=l.apply(e,I||[])).next())})};function U(){var e;console.log("Create CdvPurchase...");const I=null===(e=window.CdvPurchase)||void 0===e?void 0:e.store;window.CdvPurchase=f,window.CdvPurchase.store=I||new f.Store,Object.assign(window.CdvPurchase.store,f.LogLevel,f.ProductType,f.ErrorCode,f.Platform)}!function(e){let p;var d;(d=p=e.ErrorCode||(e.ErrorCode={}))[d.SETUP=6777001]="SETUP",d[d.LOAD=6777002]="LOAD",d[d.PURCHASE=6777003]="PURCHASE",d[d.LOAD_RECEIPTS=6777004]="LOAD_RECEIPTS",d[d.CLIENT_INVALID=6777005]="CLIENT_INVALID",d[d.PAYMENT_CANCELLED=6777006]="PAYMENT_CANCELLED",d[d.PAYMENT_INVALID=6777007]="PAYMENT_INVALID",d[d.PAYMENT_NOT_ALLOWED=6777008]="PAYMENT_NOT_ALLOWED",d[d.UNKNOWN=6777010]="UNKNOWN",d[d.REFRESH_RECEIPTS=6777011]="REFRESH_RECEIPTS",d[d.INVALID_PRODUCT_ID=6777012]="INVALID_PRODUCT_ID",d[d.FINISH=6777013]="FINISH",d[d.COMMUNICATION=6777014]="COMMUNICATION",d[d.SUBSCRIPTIONS_NOT_AVAILABLE=6777015]="SUBSCRIPTIONS_NOT_AVAILABLE",d[d.MISSING_TOKEN=6777016]="MISSING_TOKEN",d[d.VERIFICATION_FAILED=6777017]="VERIFICATION_FAILED",d[d.BAD_RESPONSE=6777018]="BAD_RESPONSE",d[d.REFRESH=6777019]="REFRESH",d[d.PAYMENT_EXPIRED=6777020]="PAYMENT_EXPIRED",d[d.DOWNLOAD=6777021]="DOWNLOAD",d[d.SUBSCRIPTION_UPDATE_NOT_AVAILABLE=6777022]="SUBSCRIPTION_UPDATE_NOT_AVAILABLE",d[d.PRODUCT_NOT_AVAILABLE=6777023]="PRODUCT_NOT_AVAILABLE",d[d.CLOUD_SERVICE_PERMISSION_DENIED=6777024]="CLOUD_SERVICE_PERMISSION_DENIED",d[d.CLOUD_SERVICE_NETWORK_CONNECTION_FAILED=6777025]="CLOUD_SERVICE_NETWORK_CONNECTION_FAILED",d[d.CLOUD_SERVICE_REVOKED=6777026]="CLOUD_SERVICE_REVOKED",d[d.PRIVACY_ACKNOWLEDGEMENT_REQUIRED=6777027]="PRIVACY_ACKNOWLEDGEMENT_REQUIRED",d[d.UNAUTHORIZED_REQUEST_DATA=6777028]="UNAUTHORIZED_REQUEST_DATA",d[d.INVALID_OFFER_IDENTIFIER=6777029]="INVALID_OFFER_IDENTIFIER",d[d.INVALID_OFFER_PRICE=6777030]="INVALID_OFFER_PRICE",d[d.INVALID_SIGNATURE=6777031]="INVALID_SIGNATURE",d[d.MISSING_OFFER_PARAMS=6777032]="MISSING_OFFER_PARAMS",d[d.VALIDATOR_SUBSCRIPTION_EXPIRED=6778003]="VALIDATOR_SUBSCRIPTION_EXPIRED",e.storeError=function l(d,s,r,t){return{isError:!0,code:d,message:s,platform:r,productId:t}}}(f||(f={})),(e=f||(f={})).Iaptic=class I{constructor(l,d){this.config=l,l.url||(l.url="https://validator.iaptic.com"),this.store=null!=d?d:e.store,this.log=this.store.log.child("Iaptic")}get braintreeClientTokenProvider(){return l=>{this.log.info("Calling Braintree clientTokenProvider"),e.Utils.ajax(this.log,{url:`${this.config.url}/v3/braintree/client-token?appName=${this.config.appName}&apiKey=${this.config.apiKey}`,method:"POST",data:{applicationUsername:e.store.getApplicationUsername(),customerId:e.Braintree.customerId},success:d=>{this.log.info("clientTokenProvider success: "+JSON.stringify(d)),l(d.clientToken)},error:d=>{this.log.info("clientTokenProvider error: "+JSON.stringify(d)),l(e.storeError(d,"ERROR "+d,e.Platform.BRAINTREE,null))}})}}get appStoreDiscountEligibilityDeterminer(){let l;this.log.debug("AppStore eligibility determiner is listening..."),this.store.when().verified(r=>{r.platform===e.Platform.APPLE_APPSTORE&&(this.log.debug("Got a verified AppStore receipt."),l=r)},"appStoreDiscountEligibilityDeterminer_listening");const d=(r,t,o)=>{if(this.log.debug("AppStore eligibility determiner"),l)return this.log.debug("Using cached receipt"),o(s(l,t));const i=c=>{c.platform===e.Platform.APPLE_APPSTORE&&(this.log.debug("Receipt is verified, let's analyze the content and respond."),this.store.off(i),o(s(c,t)))};this.log.debug("Waiting for receipt"),this.store.when().verified(i,"appStoreDiscountEligibilityDeterminer_waiting")};return d.cacheReceipt=function(r){l=r},d;function s(r,t){const o=r.raw.ineligible_for_intro_price;return t.map(i=>{var c;return!("Introductory"===i.discountType&&o&&o.find(n=>i.productId===n)||"Subscription"===i.discountType&&!(null===(c=r.raw.collection)||void 0===c?void 0:c.find(a=>a.id===i.productId)))})}}get validator(){return`${this.config.url}/v1/validate?appName=${this.config.appName}&apiKey=${this.config.apiKey}`}},function(e){let I;var r;(r=I=e.LogLevel||(e.LogLevel={}))[r.QUIET=0]="QUIET",r[r.ERROR=1]="ERROR",r[r.WARNING=2]="WARNING",r[r.INFO=3]="INFO",r[r.DEBUG=4]="DEBUG";class p{constructor(t,o=""){this.prefix="",this.store=t,this.prefix=o||"CdvPurchase"}child(t){return new p(this.store,this.prefix+"."+t)}error(t){s(this.store.verbosity,I.ERROR,this.prefix,t);try{throw new Error(function d(r){return"string"!=typeof r&&(r=JSON.stringify(r)),r}(t))}catch(o){s(this.store.verbosity,I.ERROR,this.prefix,o.stack)}}warn(t){s(this.store.verbosity,I.WARNING,this.prefix,t)}info(t){s(this.store.verbosity,I.INFO,this.prefix,t)}debug(t){s(this.store.verbosity,I.DEBUG,this.prefix,t)}logCallbackException(t,o){this.warn("A callback in '"+t+"' failed with an exception."),"string"==typeof o?this.warn("           "+o):o&&(o.fileName&&this.warn("           "+o.fileName+":"+o.lineNumber),o.message&&this.warn("           "+o.message),o.stack&&this.warn("           "+o.stack))}}p.console=window.console,e.Logger=p;const l=["QUIET","ERROR","WARNING","INFO","DEBUG"];function s(r,t,o,i){if(t>(!0===r?1:r))return;"string"!=typeof i&&(i=JSON.stringify(i));const n=o?`[${o}] `:"";(t===I.ERROR?u=>p.console.error(u):t===I.WARNING?u=>p.console.warn(u):u=>p.console.log(u))(l[t]?`${n}${l[t]}: ${i}`:`${n}${i}`)}}(f||(f={})),function(e){let I;(I=e.Utils||(e.Utils={})).nonEnumerable=(l,d,s)=>{if(s)return s.enumerable=!1,s;Object.defineProperty(l,d,{set(r){Object.defineProperty(this,d,{value:r,writable:!0,configurable:!0})},configurable:!0})}}(f||(f={})),function(e){e.Product=class I{constructor(l,d){this.className="Product",this.title="",this.description="",this.platform=l.platform,this.type=l.type,this.id=l.id,this.group=l.group,this.offers=[],Object.defineProperty(this,"pricing",{enumerable:!1,get:()=>{var s;return null===(s=this.offers[0])||void 0===s?void 0:s.pricingPhases[0]}}),Object.defineProperty(this,"canPurchase",{enumerable:!1,get:()=>d.canPurchase(this)}),Object.defineProperty(this,"owned",{enumerable:!1,get:()=>d.owned(this)})}get pricing(){var l;return null===(l=this.offers[0])||void 0===l?void 0:l.pricingPhases[0]}get canPurchase(){return!1}get owned(){return!1}getOffer(l=""){return l?this.offers.find(d=>d.id===l):this.offers[0]}addOffer(l){return this.getOffer(l.id)||this.offers.push(l),this}}}(f||(f={})),function(e){let I;(I=e.Utils||(e.Utils={})).objectValues=function l(d){const s=[];for(let r in d)d.hasOwnProperty(r)&&s.push(d[r]);return s}}(f||(f={})),function(e){let I;(I=e.Utils||(e.Utils={})).platformName=function l(d){switch(d){case e.Platform.APPLE_APPSTORE:return"App Store";case e.Platform.GOOGLE_PLAY:return"Google Play";case e.Platform.WINDOWS_STORE:return"Windows Store";case e.Platform.BRAINTREE:return"Braintree";case e.Platform.TEST:return"Test";default:return d}}}(f||(f={})),function(e){let I;!function(p){class l{constructor(){this.array=[]}get length(){return this.array.length}get(){return this.array.concat()}add(t){this.has(t)||this.array.push(t)}clear(){for(;0!==this.array.length;)this.array.pop()}has(t){return!!this.array.find(o=>o===t)}}p.ReceiptsToValidate=l,p.Validator=class d{constructor(t,o){this.receiptsToValidate=new l,this.verifiedReceipts=[],this.numRequests=0,this.numResponses=0,this.cache={},this.controller=t,this.log=o.child("Validator")}incrRequestsCounter(){this.numRequests=this.numRequests+1|0,this.log.debug(`Validation requests=${this.numRequests} responses=${this.numResponses}`)}incrResponsesCounter(){this.numResponses=this.numResponses+1|0,this.log.debug(`Validation requests=${this.numRequests} responses=${this.numResponses}`)}addVerifiedReceipt(t,o){for(const c of this.verifiedReceipts)if(c.platform===t.platform&&c.id===o.id)return this.log.debug("Updating existing receipt."),c.set(t,o),c;this.log.debug("Register a new verified receipt.");const i=new e.VerifiedReceipt(t,o,this.controller);return this.verifiedReceipts.push(i),i}add(t){this.log.debug("Schedule validation: "+JSON.stringify(t));const o=t instanceof e.Transaction?t.parentReceipt:t;this.receiptsToValidate.has(o)||(this.incrRequestsCounter(),this.receiptsToValidate.add(o))}run(){const t=this.receiptsToValidate.get();this.receiptsToValidate.clear();const o=i=>N(this,void 0,void 0,function*(){var c;const{receipt:n,payload:a}=i;this.incrResponsesCounter();try{const u=this.controller.adapters.find(n.platform);if(yield null==u?void 0:u.handleReceiptValidationResponse(n,a),a.ok){const h=this.addVerifiedReceipt(n,a.data);this.controller.verifiedCallbacks.trigger(h,"payload_ok")}else if(a.code===e.ErrorCode.VALIDATOR_SUBSCRIPTION_EXPIRED){const h=null===(c=n.lastTransaction())||void 0===c?void 0:c.transactionId,E=h?this.verifiedReceipts.find(m=>{var R;return(null===(R=m.collection[0])||void 0===R?void 0:R.transactionId)===h}):void 0;E?(null==E||E.collection.forEach(m=>{m.transactionId===h&&(m.isExpired=!0)}),this.controller.verifiedCallbacks.trigger(E,"payload_expired")):this.controller.unverifiedCallbacks.trigger({receipt:n,payload:a},"no_verified_receipt")}else this.controller.unverifiedCallbacks.trigger({receipt:n,payload:a},"validator_error")}catch(u){this.log.error("Exception probably caused by an invalid response from the validator."+u.message),this.controller.unverifiedCallbacks.trigger({receipt:n,payload:{ok:!1,code:e.ErrorCode.VERIFICATION_FAILED,message:u.message}},"validator_exception")}});t.forEach(i=>this.runOnReceipt(i,o))}runOnReceipt(t,o){return N(this,void 0,void 0,function*(){if(t.platform===e.Platform.TEST)return this.log.debug("Using Test Adapter mock verify function."),e.Test.Adapter.verify(t,o);if(!this.controller.validator)return this.incrResponsesCounter(),void o({receipt:t,payload:{ok:!0,data:{id:t.transactions[0].transactionId,latest_receipt:!0,transaction:{type:"test"}}}});const i=yield this.buildRequestBody(t);if(i)return"function"==typeof this.controller.validator?this.runValidatorFunction(this.controller.validator,t,i,o):this.runValidatorRequest("string"==typeof this.controller.validator?{url:this.controller.validator,timeout:2e4}:this.controller.validator,t,i,o);this.incrResponsesCounter()})}runValidatorFunction(t,o,i,c){try{t(i,n=>c({receipt:o,payload:n}))}catch(n){this.log.warn("user provided validator function failed with error: "+(null==n?void 0:n.stack))}}buildRequestBody(t){var o,i,c;return N(this,void 0,void 0,function*(){const n=this.controller.adapters.find(t.platform),a=yield null==n?void 0:n.receiptValidationBody(t);if(a){if(a.additionalData=Object.assign(Object.assign({},null!==(o=a.additionalData)&&void 0!==o?o:{}),{applicationUsername:this.controller.getApplicationUsername()}),a.additionalData.applicationUsername||delete a.additionalData.applicationUsername,a.device=Object.assign(Object.assign({},null!==(i=a.device)&&void 0!==i?i:{}),e.Validator.Internal.getDeviceInfo(this.controller)),1===(null===(c=a.offers)||void 0===c?void 0:c.length)){const u=a.offers[0];if(1===u.pricingPhases.length){const h=u.pricingPhases[0];a.currency=h.currency,a.priceMicros=h.priceMicros}else if(2===u.pricingPhases.length){const h=u.pricingPhases[1];a.currency=h.currency,a.priceMicros=h.priceMicros,a.introPriceMicros=u.pricingPhases[0].priceMicros}}return a}})}removeExpiredCache(){const t=+new Date,o=[];for(const i in this.cache)this.cache[i].expires<t&&o.push(i);for(const i of o)delete this.cache[i]}runValidatorRequest(t,o,i,c){this.removeExpiredCache();const n=e.Utils.md5(JSON.stringify(i.transaction)),a=this.cache[n];if(a)return c({receipt:o,payload:a.payload});e.Utils.ajax(this.log.child("Ajax"),{url:t.url,method:"POST",customHeaders:t.headers,timeout:t.timeout,data:i,success:u=>{var h;if(this.log.debug("validator success, response: "+JSON.stringify(u)),!function s(r){return!!r&&"object"==typeof r&&"ok"in r&&"boolean"==typeof r.ok}(u))return c({receipt:o,payload:{ok:!1,code:e.ErrorCode.BAD_RESPONSE,message:"Validator responded with invalid data",data:{latest_receipt:null===(h=null==u?void 0:u.data)||void 0===h?void 0:h.latest_receipt}}});this.cache[n]={payload:u,expires:+new Date+12e4},c({receipt:o,payload:u})},error:(u,h,E)=>{var m="Error "+u+": "+h;this.log.debug("validator failed, response: "+JSON.stringify(m)),this.log.debug("body => "+JSON.stringify(E)),c({receipt:o,payload:{ok:!1,message:m,code:e.ErrorCode.COMMUNICATION,status:u,data:{}}})}})}}}(I=e.Internal||(e.Internal={}))}(f||(f={})),function(e){let I;(I=e.Internal||(e.Internal={})).Adapters=class l{constructor(){this.list=[]}add(s,r,t){r.forEach(o=>{if(s.info(""),!this.find(o.platform))switch(o.platform){case e.Platform.APPLE_APPSTORE:return this.list.push(new e.AppleAppStore.Adapter(t,o.options||{}));case e.Platform.GOOGLE_PLAY:return this.list.push(new e.GooglePlay.Adapter(t));case e.Platform.BRAINTREE:return o.options||s.error("Options missing for Braintree initialization. Use {platform: Platform.BRAINTREE, options: {...}} in your call to store.initialize"),this.list.push(new e.Braintree.Adapter(t,o.options));case e.Platform.TEST:return this.list.push(new e.Test.Adapter(t));default:return}})}initialize(s,r){return N(this,void 0,void 0,function*(){const t=s.map(n=>"string"==typeof n?{platform:n}:n).filter(n=>!this.find(n.platform)),o=r.log.child("Adapters");o.info("Adding platforms: "+JSON.stringify(t)),this.add(o,t,r);const i=r.registeredProducts.byPlatform();return(yield Promise.all(t.map(n=>N(this,void 0,void 0,function*(){var a,u,h;const E=null!==(h=null===(u=null===(a=i.filter(g=>g.platform===n.platform))||void 0===a?void 0:a[0])||void 0===u?void 0:u.products)&&void 0!==h?h:[],m=this.find(n.platform);if(!m)return;if(o.info(`${m.name} initializing...`),!m.isSupported)return void o.info(`${m.name} is not supported.`);const R=yield m.initialize();if(m.ready=!0,o.info(`${m.name} initialized. ${R?JSON.stringify(R):""}`),null!=R&&R.code)return R;if(o.info(`${m.name} products: ${JSON.stringify(E)}`),0===E.length)return;let O=[],T=[];m.supportsParallelLoading?[O,T]=yield Promise.all([m.loadProducts(E),m.loadReceipts()]):(O=yield m.loadProducts(E),T=yield m.loadReceipts()),o.info(`${m.name} products loaded: ${JSON.stringify(O)}`);const P=O.filter(g=>g instanceof e.Product);return r.listener.productsUpdated(n.platform,P),o.info(`${m.name} receipts loaded: ${JSON.stringify(T)}`),O.filter(g=>"code"in g&&"message"in g)[0]})))).filter(n=>n)})}find(s){return this.list.filter(r=>r.id===s)[0]}findReady(s){return this.list.filter(r=>(!s||r.id===s)&&r.ready)[0]}}}(f||(f={})),function(e){let I;!function(p){class l{constructor(s,r){this.supportedPlatforms=[],this.platformWithReceiptsReady=[],this.lastTransactionState={},this.lastCallTimeForState={},this.delegate=s,this.log=r.child("AdapterListener")}static makeTransactionToken(s){return s.platform+"|"+s.transactionId}setSupportedPlatforms(s){this.log.debug(`setSupportedPlatforms: ${s.join(",")} (${this.platformWithReceiptsReady.length} have their receipts ready)`),this.supportedPlatforms=s,this.supportedPlatforms.length===this.platformWithReceiptsReady.length&&(this.log.debug("triggering receiptsReady()"),this.delegate.receiptsReadyCallbacks.trigger(void 0,"adapterListener_setSupportedPlatforms"))}receiptsReady(s){this.supportedPlatforms.length>0&&this.platformWithReceiptsReady.length===this.supportedPlatforms.length?this.log.debug("receiptsReady: "+s+"(skipping)"):this.platformWithReceiptsReady.indexOf(s)<0&&(this.platformWithReceiptsReady.push(s),this.log.debug(`receiptsReady: ${s} (${this.platformWithReceiptsReady.length}/${this.supportedPlatforms.length})`),this.platformWithReceiptsReady.length===this.supportedPlatforms.length&&(this.log.debug("triggering receiptsReady()"),this.delegate.receiptsReadyCallbacks.trigger(void 0,"adapterListener_receiptsReady")))}productsUpdated(s,r){r.forEach(t=>this.delegate.updatedCallbacks.trigger(t,"adapterListener_productsUpdated"))}receiptsUpdated(s,r){const t=+new Date;this.log.debug("receiptsUpdated: "+JSON.stringify(r)),r.forEach(o=>{this.delegate.updatedReceiptCallbacks.trigger(o,"adapterListener_receiptsUpdated"),o.transactions.forEach(i=>{const c=l.makeTransactionToken(i),n=c+"@"+i.state,a=this.lastTransactionState[c];i.state===e.TransactionState.APPROVED?(0|this.lastCallTimeForState[n])<t-6e4&&(this.delegate.approvedCallbacks.trigger(i,"adapterListener_receiptsUpdated_approved"),this.lastCallTimeForState[n]=t):a!==i.state&&(i.state===e.TransactionState.FINISHED?(this.delegate.finishedCallbacks.trigger(i,"adapterListener_receiptsUpdated_finished"),this.lastCallTimeForState[n]=t):i.state===e.TransactionState.PENDING&&(this.delegate.pendingCallbacks.trigger(i,"adapterListener_receiptsUpdated_pending"),this.lastCallTimeForState[n]=t)),this.lastTransactionState[c]=i.state})})}}p.StoreAdapterListener=l}(I=e.Internal||(e.Internal={}))}(f||(f={})),function(e){let I;(I=e.Internal||(e.Internal={})).Callbacks=class l{constructor(s,r,t=!1){this.callbacks=[],this.numTriggers=0,this.logger=s,this.className=r,this.finalStateMode=t}push(s,r){if(this.finalStateMode&&this.numTriggers>0)s(this.lastTriggerArgument);else{for(const t of this.callbacks)if(t.callback===s)throw new Error("REGISTERING THE SAME CALLBACK TWICE? This is indicative of a bug in your integration.");this.callbacks.push({callback:s,callbackName:r})}}trigger(s,r){this.lastTriggerArgument=s,this.numTriggers++;const t=this.callbacks;this.finalStateMode&&(this.callbacks=[]),t.forEach(o=>{e.Utils.safeCall(this.logger,this.className,o.callback,s,o.callbackName,r)})}remove(s){this.callbacks=this.callbacks.filter(r=>r.callback!==s)}}}(f||(f={})),function(e){let I;(I=e.Internal||(e.Internal={})).ReadyCallbacks=class l{constructor(s){this.isReady=!1,this.readyCallbacks=[],this.logger=s}add(s){if(this.isReady)return setTimeout(s,0);this.readyCallbacks.push(s)}trigger(s){this.isReady=!0,this.readyCallbacks.forEach(r=>e.Utils.safeCall(this.logger,"ready()",r,void 0,void 0,s)),this.readyCallbacks=[]}remove(s){this.readyCallbacks=this.readyCallbacks.filter(r=>r!==s)}}}(f||(f={})),function(e){let I;(I=e.Internal||(e.Internal={})).RegisteredProducts=class d{constructor(){this.list=[]}find(r,t){return this.list.find(o=>o.platform===r&&o.id===t)}add(r){const t=[],i=(Array.isArray(r)?r:[r]).filter(c=>!this.find(c.platform,c.id));for(const c of i)"object"==typeof(s=c)&&s.hasOwnProperty("platform")&&s.hasOwnProperty("id")&&s.hasOwnProperty("type")?this.list.push(c):t.push(e.storeError(e.ErrorCode.LOAD,'Invalid parameter to "register", expected "id", "type" and "platform". Got: '+JSON.stringify(c),null,null));var s;return t}byPlatform(){const r={};return this.list.forEach(t=>{r[t.platform]=(r[t.platform]||[]).concat(t)}),Object.keys(r).map(t=>({platform:t,products:r[t]}))}}}(f||(f={})),function(e){let I;(I=e.Internal||(e.Internal={})).TransactionStateMonitors=class l{constructor(s){this.monitors=[],s.approved(r=>this.callOnChange(r),"transactionStateMonitors_callOnChange").finished(r=>this.callOnChange(r),"transactionStateMonitors_callOnChange")}findMonitors(s){return this.monitors.filter(r=>r.transaction.platform===s.platform&&r.transaction.transactionId===s.transactionId)}callOnChange(s){this.findMonitors(s).forEach(r=>{r.lastChange!==s.state&&(r.lastChange=s.state,r.onChange(s.state))})}start(s,r){const t=e.Utils.uuidv4();return this.monitors.push({monitorId:t,transaction:s,onChange:r,lastChange:s.state}),setTimeout(r,0,s.state),{transaction:s,stop:()=>this.stop(t)}}stop(s){this.monitors=this.monitors.filter(r=>r.monitorId!==s)}}}(f||(f={})),function(e){let I;(I=e.Internal||(e.Internal={})).ReceiptsMonitor=class l{constructor(s){this.hasCalledReceiptsVerified=!1,this.controller=s,this.log=s.log.child("ReceiptsMonitor")}callReceiptsVerified(){this.hasCalledReceiptsVerified||(this.hasCalledReceiptsVerified=!0,this.log.info("receiptsVerified()"),this.controller.when().receiptsReady(()=>{setTimeout(()=>{this.controller.receiptsVerified()},0)},"receiptsMonitor_callReceiptsVerified"))}launch(){const s=()=>{this.log.debug(`check(${this.controller.numValidationResponses()}/${this.controller.numValidationRequests()})`),this.controller.numValidationRequests()===this.controller.numValidationResponses()&&(void 0!==this.intervalChecker&&(clearInterval(this.intervalChecker),this.intervalChecker=void 0),this.controller.off(s),this.callReceiptsVerified())};this.controller.when().verified(s,"receiptsMonitor_check").unverified(s,"receiptsMonitor_check").receiptsReady(()=>{this.log.debug("receiptsReady..."),(!this.controller.hasLocalReceipts()||!this.controller.hasValidator())&&setTimeout(()=>{s()},0),this.intervalChecker=setInterval(()=>{this.log.debug("keep checking every 10s..."),s()},1e4)},"receiptsMonitor_setup")}}}(f||(f={})),function(e){let I;(I=e.Internal||(e.Internal={})).ExpiryMonitor=(()=>{class d{constructor(r){this.activePurchases={},this.notifiedPurchases={},this.controller=r}launch(){this.interval=setInterval(()=>{var r,t;const o=+new Date;for(const i of this.controller.verifiedReceipts){const c=null!==(r=d.GRACE_PERIOD_MS[i.platform])&&void 0!==r?r:d.GRACE_PERIOD_MS.DEFAULT;for(const n of i.collection)if(n.expiryDate){const a=n.expiryDate+c,u=null!==(t=n.transactionId)&&void 0!==t?t:`${a}`;a>o&&(this.activePurchases[u]=!0),a<o&&this.activePurchases[u]&&!this.notifiedPurchases[u]&&(this.notifiedPurchases[u]=!0,this.controller.onVerifiedPurchaseExpired(n,i))}}},d.INTERVAL_MS)}}return d.INTERVAL_MS=1e4,d.GRACE_PERIOD_MS={DEFAULT:6e4,"ios-appstore":6e4,"android-playstore":3e4},d})()}(f||(f={})),function(e){e.PLUGIN_VERSION="13.10.0",e.Store=class I{constructor(){this.adapters=new e.Internal.Adapters,this.registeredProducts=new e.Internal.RegisteredProducts,this.log=new e.Logger(this),this.verbosity=e.LogLevel.ERROR,this._readyCallbacks=new e.Internal.ReadyCallbacks(this.log),this.updatedCallbacks=new e.Internal.Callbacks(this.log,"productUpdated()"),this.updatedReceiptsCallbacks=new e.Internal.Callbacks(this.log,"receiptUpdated()"),this.approvedCallbacks=new e.Internal.Callbacks(this.log,"approved()"),this.finishedCallbacks=new e.Internal.Callbacks(this.log,"finished()"),this.pendingCallbacks=new e.Internal.Callbacks(this.log,"pending()"),this.verifiedCallbacks=new e.Internal.Callbacks(this.log,"verified()"),this.unverifiedCallbacks=new e.Internal.Callbacks(this.log,"unverified()"),this.receiptsReadyCallbacks=new e.Internal.Callbacks(this.log,"receiptsReady()",!0),this.receiptsVerifiedCallbacks=new e.Internal.Callbacks(this.log,"receiptsVerified()",!0),this.errorCallbacks=new e.Internal.Callbacks(this.log,"error()"),this.initializedHasBeenCalled=!1,this.lastUpdate=0,this.minTimeBetweenUpdates=6e5,this.version=e.PLUGIN_VERSION;const l=this;this.listener=new e.Internal.StoreAdapterListener({updatedCallbacks:this.updatedCallbacks,updatedReceiptCallbacks:this.updatedReceiptsCallbacks,approvedCallbacks:this.approvedCallbacks,finishedCallbacks:this.finishedCallbacks,pendingCallbacks:this.pendingCallbacks,receiptsReadyCallbacks:this.receiptsReadyCallbacks},this.log),this.transactionStateMonitors=new e.Internal.TransactionStateMonitors(this.when()),this._validator=new e.Internal.Validator({adapters:this.adapters,getApplicationUsername:this.getApplicationUsername.bind(this),get localReceipts(){return l.localReceipts},get validator(){return l.validator},get validator_privacy_policy(){return l.validator_privacy_policy},verifiedCallbacks:this.verifiedCallbacks,unverifiedCallbacks:this.unverifiedCallbacks,finish:d=>this.finish(d)},this.log),new e.Internal.ReceiptsMonitor({hasLocalReceipts:()=>this.localReceipts.length>0,hasValidator:()=>!!this.validator,numValidationRequests:()=>this._validator.numRequests,numValidationResponses:()=>this._validator.numResponses,off:this.off.bind(this),when:this.when.bind(this),receiptsVerified:()=>{l.receiptsVerifiedCallbacks.trigger(void 0,"receipts_monitor_controller")},log:this.log}).launch(),this.expiryMonitor=new e.Internal.ExpiryMonitor({get verifiedReceipts(){return l.verifiedReceipts},onVerifiedPurchaseExpired(d,s){l.verify(s.sourceReceipt)}}),this.expiryMonitor.launch()}getAdapter(l){return this.adapters.find(l)}getApplicationUsername(){return this.applicationUsername instanceof Function?this.applicationUsername():this.applicationUsername}register(l){this.registeredProducts.add(l).forEach(s=>{e.store.errorCallbacks.trigger(s,"register_error"),this.log.error(s)})}initialize(l=[this.defaultPlatform()]){return N(this,void 0,void 0,function*(){if(this.initializedHasBeenCalled)return this.log.warn("store.initialized() has been called already."),[];this.log.info("initialize()"),this.initializedHasBeenCalled=!0,this.lastUpdate=+new Date;const d=this,s=this.adapters.initialize(l,{error:this.triggerError.bind(this),get verbosity(){return d.verbosity},getApplicationUsername:()=>d.getApplicationUsername(),get listener(){return d.listener},get log(){return d.log},get registeredProducts(){return d.registeredProducts},apiDecorators:{canPurchase:this.canPurchase.bind(this),owned:this.owned.bind(this),finish:this.finish.bind(this),order:this.order.bind(this),verify:this.verify.bind(this)}});return s.then(()=>{this._readyCallbacks.trigger("initialize_promise_resolved"),this.listener.setSupportedPlatforms(this.adapters.list.filter(r=>r.isSupported).map(r=>r.id))}),s})}refresh(){throw new Error("use store.initialize() or store.update()")}update(){var l;return N(this,void 0,void 0,function*(){if(this.log.info("update()"),!this._readyCallbacks.isReady)return void this.log.warn("Do not call store.update() at startup! It is meant to reload the price of products (if needed) long after initialization.");const d=+new Date;if(this.lastUpdate>d-this.minTimeBetweenUpdates)this.log.info("Skipping store.update() as the last call occurred less than store.minTimeBetweenUpdates millis ago.");else{this.lastUpdate=d;for(const s of this.registeredProducts.byPlatform()){const r=yield null===(l=this.adapters.findReady(s.platform))||void 0===l?void 0:l.loadProducts(s.products);null==r||r.forEach(t=>{t instanceof e.Product&&this.updatedCallbacks.trigger(t,"update_has_loaded_products")})}}})}ready(l){this._readyCallbacks.add(l)}get isReady(){return this._readyCallbacks.isReady}when(){const l={productUpdated:(d,s)=>(this.updatedCallbacks.push(d,s),l),receiptUpdated:(d,s)=>(this.updatedReceiptsCallbacks.push(d,s),l),updated:(d,s)=>(this.updatedCallbacks.push(d,s),this.updatedReceiptsCallbacks.push(d,s),l),approved:(d,s)=>(this.approvedCallbacks.push(d,s),l),pending:(d,s)=>(this.pendingCallbacks.push(d,s),l),finished:(d,s)=>(this.finishedCallbacks.push(d,s),l),verified:(d,s)=>(this.verifiedCallbacks.push(d,s),l),unverified:(d,s)=>(this.unverifiedCallbacks.push(d,s),l),receiptsReady:(d,s)=>(this.receiptsReadyCallbacks.push(d,s),l),receiptsVerified:(d,s)=>(this.receiptsVerifiedCallbacks.push(d,s),l)};return l}off(l){this.updatedCallbacks.remove(l),this.updatedReceiptsCallbacks.remove(l),this.approvedCallbacks.remove(l),this.finishedCallbacks.remove(l),this.pendingCallbacks.remove(l),this.verifiedCallbacks.remove(l),this.unverifiedCallbacks.remove(l),this.receiptsReadyCallbacks.remove(l),this.receiptsVerifiedCallbacks.remove(l),this.errorCallbacks.remove(l),this._readyCallbacks.remove(l)}monitor(l,d,s){return this.transactionStateMonitors.start(l,e.Utils.safeCallback(this.log,"monitor()",d,s,"transactionStateMonitors_stateChanged"))}get products(){return[].concat(...this.adapters.list.map(l=>l.products))}get(l,d){var s;return null===(s=this.adapters.findReady(d))||void 0===s?void 0:s.products.find(r=>r.id===l)}get localReceipts(){return[].concat(...this.adapters.list.map(l=>l.receipts))}get localTransactions(){const l=[];for(const d of this.localReceipts)l.push(...d.transactions);return l}get verifiedReceipts(){return this._validator.verifiedReceipts}get verifiedPurchases(){return e.Internal.VerifiedReceipts.getVerifiedPurchases(this.verifiedReceipts)}findInVerifiedReceipts(l){return e.Internal.VerifiedReceipts.find(this.verifiedReceipts,l)}findInLocalReceipts(l){return e.Internal.LocalReceipts.find(this.localReceipts,l)}canPurchase(l){const d=l instanceof e.Offer?this.get(l.productId,l.platform):l,s=this.adapters.findReady(l.platform);return!(null==s||!s.checkSupport("order"))&&e.Internal.LocalReceipts.canPurchase(this.localReceipts,d)}owned(l){return e.Internal.owned({product:"string"==typeof l?{id:l}:l,verifiedReceipts:this.validator?this.verifiedReceipts:void 0,localReceipts:this.localReceipts})}order(l,d){return N(this,void 0,void 0,function*(){this.log.info(`order(${l.productId})`);const s=this.adapters.findReady(l.platform);if(!s)return e.storeError(e.ErrorCode.PAYMENT_NOT_ALLOWED,"Adapter not found or not ready ("+l.platform+")",l.platform,null);const r=yield s.order(l,d||{});return r&&"isError"in r&&e.store.triggerError(r),r})}requestPayment(l,d){var s,r,t,o,i;const c=this.adapters.findReady(l.platform);if(!c)return e.PaymentRequestPromise.failed(e.ErrorCode.PAYMENT_NOT_ALLOWED,"Adapter not found or not ready ("+l.platform+")",l.platform,null);if(!l.amountMicros){l.amountMicros=0;for(const a of l.items)l.amountMicros+=null!==(r=null===(s=null==a?void 0:a.pricing)||void 0===s?void 0:s.priceMicros)&&void 0!==r?r:0}if(l.currency)for(const a of l.items)if(null!==(o=null==a?void 0:a.pricing)&&void 0!==o&&o.currency){if(l.currency!==a.pricing.currency)return e.PaymentRequestPromise.failed(e.ErrorCode.PAYMENT_INVALID,"Currencies do not match",l.platform,a.id)}else null!=a&&a.pricing&&(a.pricing.currency=l.currency);else for(const a of l.items)null!==(t=null==a?void 0:a.pricing)&&void 0!==t&&t.currency&&(l.currency=a.pricing.currency);if(1===l.items.length){const a=l.items[0];a&&!a.pricing&&(a.pricing={priceMicros:null!==(i=l.amountMicros)&&void 0!==i?i:0,currency:l.currency})}const n=new e.PaymentRequestPromise;return c.requestPayment(l,d).then(a=>{if(n.trigger(a),a instanceof e.Transaction){const h=this.monitor(a,E=>{n.trigger(a),a.state===e.TransactionState.FINISHED&&h.stop()},"requestPayment_onStateChange")}}),n}checkSupport(l,d){const s=this.adapters.find(l);return!!s&&s.checkSupport(d)}verify(l){return N(this,void 0,void 0,function*(){this.log.info(`verify(${l.className})`),this._validator.add(l),setTimeout(()=>this._validator.run(),200)})}finish(l){return N(this,void 0,void 0,function*(){this.log.info(`finish(${l.className})`),(l instanceof e.VerifiedReceipt?l.sourceReceipt.transactions:l instanceof e.Receipt?l.transactions:[l]).forEach(s=>{var r;null===(r=this.adapters.findReady(s.platform))||void 0===r||r.finish(s)})})}restorePurchases(){return N(this,void 0,void 0,function*(){let l;for(const d of this.adapters.list)d.ready&&(l=null!=l?l:yield d.restorePurchases());return l})}manageSubscriptions(l){return N(this,void 0,void 0,function*(){this.log.info("manageSubscriptions()");const d=this.adapters.findReady(l);return d?d.manageSubscriptions():e.storeError(e.ErrorCode.SETUP,"Found no adapter ready to handle 'manageSubscription'",null!=l?l:null,null)})}manageBilling(l){return N(this,void 0,void 0,function*(){this.log.info("manageBilling()");const d=this.adapters.findReady(l);return d?d.manageBilling():e.storeError(e.ErrorCode.SETUP,"Found no adapter ready to handle 'manageBilling'",null!=l?l:null,null)})}defaultPlatform(){switch(window.cordova.platformId){case"android":return e.Platform.GOOGLE_PLAY;case"ios":return e.Platform.APPLE_APPSTORE;default:return e.Platform.TEST}}error(l){this.errorCallbacks.push(l)}triggerError(l){this.errorCallbacks.trigger(l,"triggerError")}}}(f||(f={})),window.cordova?setTimeout(U,0):U(),function(e){let I;var i;let p,l,d,s,r,t,o;(i=I=e.ProductType||(e.ProductType={})).CONSUMABLE="consumable",i.NON_CONSUMABLE="non consumable",i.FREE_SUBSCRIPTION="free subscription",i.PAID_SUBSCRIPTION="paid subscription",i.NON_RENEWING_SUBSCRIPTION="non renewing subscription",i.APPLICATION="application",function(i){i.NON_RECURRING="NON_RECURRING",i.FINITE_RECURRING="FINITE_RECURRING",i.INFINITE_RECURRING="INFINITE_RECURRING"}(p=e.RecurrenceMode||(e.RecurrenceMode={})),function(i){i.PAY_AS_YOU_GO="PayAsYouGo",i.UP_FRONT="UpFront",i.FREE_TRIAL="FreeTrial"}(l=e.PaymentMode||(e.PaymentMode={})),function(i){i.APPLE_APPSTORE="ios-appstore",i.GOOGLE_PLAY="android-playstore",i.WINDOWS_STORE="windows-store-transaction",i.BRAINTREE="braintree",i.TEST="test"}(d=e.Platform||(e.Platform={})),function(i){i.INITIATED="initiated",i.PENDING="pending",i.APPROVED="approved",i.CANCELLED="cancelled",i.FINISHED="finished",i.UNKNOWN_STATE=""}(s=e.TransactionState||(e.TransactionState={})),function(i){i.LAPSE="Lapse",i.RENEW="Renew"}(r=e.RenewalIntent||(e.RenewalIntent={})),function(i){i.NOTIFIED="Notified",i.AGREED="Agreed"}(t=e.PriceConsentStatus||(e.PriceConsentStatus={})),function(i){i.NOT_CANCELED="",i.DEVELOPER="Developer",i.SYSTEM="System",i.SYSTEM_REPLACED="System.Replaced",i.SYSTEM_PRODUCT_UNAVAILABLE="System.ProductUnavailable",i.SYSTEM_BILLING_ERROR="System.BillingError",i.SYSTEM_DELETED="System.Deleted",i.CUSTOMER="Customer",i.CUSTOMER_TECHNICAL_ISSUES="Customer.TechnicalIssues",i.CUSTOMER_PRICE_INCREASE="Customer.PriceIncrease",i.CUSTOMER_COST="Customer.Cost",i.CUSTOMER_FOUND_BETTER_APP="Customer.FoundBetterApp",i.CUSTOMER_NOT_USEFUL_ENOUGH="Customer.NotUsefulEnough",i.CUSTOMER_OTHER_REASON="Customer.OtherReason",i.UNKNOWN="Unknown"}(o=e.CancelationReason||(e.CancelationReason={}))}(f||(f={})),function(e){e.Offer=class I{constructor(l,d){this.className="Offer",this.id=l.id,this.pricingPhases=l.pricingPhases,Object.defineProperty(this,"productId",{enumerable:!0,get:()=>l.product.id}),Object.defineProperty(this,"productType",{enumerable:!0,get:()=>l.product.type}),Object.defineProperty(this,"productGroup",{enumerable:!0,get:()=>l.product.group}),Object.defineProperty(this,"platform",{enumerable:!0,get:()=>l.product.platform}),Object.defineProperty(this,"order",{enumerable:!1,get:()=>s=>d.order(this,s)}),Object.defineProperty(this,"canPurchase",{enumerable:!1,get:()=>d.canPurchase(this)})}get productId(){return""}get productType(){return e.ProductType.APPLICATION}get productGroup(){}get platform(){return e.Platform.TEST}order(l){return N(this,void 0,void 0,function*(){})}get canPurchase(){return!1}}}(f||(f={})),function(e){class I{constructor(){this.failedCallbacks=new e.Internal.PromiseLike,this.initiatedCallbacks=new e.Internal.PromiseLike,this.approvedCallbacks=new e.Internal.PromiseLike,this.finishedCallbacks=new e.Internal.PromiseLike,this.cancelledCallback=new e.Internal.PromiseLike}failed(l){return this.failedCallbacks.push(l),this}initiated(l){return this.initiatedCallbacks.push(l),this}approved(l){return this.approvedCallbacks.push(l),this}finished(l){return this.finishedCallbacks.push(l),this}cancelled(l){return this.cancelledCallback.push(l),this}trigger(l){if(l)if("isError"in l)this.failedCallbacks.resolve(l);else switch(l.state){case e.TransactionState.INITIATED:this.initiatedCallbacks.resolve(l);break;case e.TransactionState.APPROVED:this.approvedCallbacks.resolve(l);break;case e.TransactionState.FINISHED:this.finishedCallbacks.resolve(l)}else this.cancelledCallback.resolve();return this}static failed(l,d,s,r){return(new I).trigger(e.storeError(l,d,s,r))}static cancelled(){return(new I).trigger()}static initiated(l){return(new I).trigger(l)}}e.PaymentRequestPromise=I}(f||(f={})),function(e){e.Receipt=class I{constructor(l,d){this.className="Receipt",this.transactions=[],this.platform=l,Object.defineProperty(this,"verify",{enumerable:!1,get(){return()=>d.verify(this)}}),Object.defineProperty(this,"finish",{enumerable:!1,get(){return()=>d.finish(this)}})}verify(){return N(this,void 0,void 0,function*(){})}finish(){return N(this,void 0,void 0,function*(){})}hasTransaction(l){return!!this.transactions.find(d=>d===l)}lastTransaction(){return this.transactions[this.transactions.length-1]}}}(f||(f={})),function(e){e.Transaction=class I{constructor(l,d,s){this.className="Transaction",this.transactionId="",this.state=e.TransactionState.UNKNOWN_STATE,this.products=[],this.platform=l,Object.defineProperty(this,"finish",{enumerable:!1,get(){return()=>s.finish(this)}}),Object.defineProperty(this,"verify",{enumerable:!1,get(){return()=>s.verify(this)}}),Object.defineProperty(this,"parentReceipt",{enumerable:!1,get:()=>d})}finish(){return N(this,void 0,void 0,function*(){})}verify(){return N(this,void 0,void 0,function*(){})}get parentReceipt(){return{}}}}(f||(f={})),function(e){let I;!function(p){class l{static find(s,r){var t,o;if(!r)return;let i;for(const c of s)if(!r.platform||c.platform===r.platform)for(const n of c.transactions)for(const a of n.products)a.id===r.id&&(!i||(null!==(t=n.purchaseDate)&&void 0!==t?t:0)<(null!==(o=i.purchaseDate)&&void 0!==o?o:1))&&(i=n);return i}static isOwned(s,r){if(!r)return!1;const t=l.find(s,r);return!(!t||t.isConsumed||t.isPending)&&(!t.expirationDate||t.expirationDate.getTime()>+new Date)}static canPurchase(s,r){if(!r)return!1;const t=l.find(s,r);return!(t&&!t.isConsumed)||!t.expirationDate||t.expirationDate.getTime()<=+new Date}}p.LocalReceipts=l}(I=e.Internal||(e.Internal={}))}(f||(f={})),function(e){let I;var p;(p=I=e.Internal||(e.Internal={})).owned=function l(d){return void 0!==d.verifiedReceipts?p.VerifiedReceipts.isOwned(d.verifiedReceipts,d.product):void 0!==d.localReceipts&&p.LocalReceipts.isOwned(d.localReceipts,d.product)}}(f||(f={})),function(e){let I;(I=e.Internal||(e.Internal={})).PromiseLike=class l{constructor(){this.resolved=!1,this.callbacks=[]}push(s){this.resolved?setTimeout(s,0,this.resolvedArgument):this.callbacks.push(s)}resolve(s){this.resolved||(this.resolved=!0,this.resolvedArgument=s,this.callbacks.forEach(r=>setTimeout(r,0,s)),this.callbacks=[])}}}(f||(f={})),function(e){let I;(I=e.Internal||(e.Internal={})).Retry=class l{constructor(s=5e3,r=12e4){this.maxTimeout=12e4,this.minTimeout=5e3,this.retryTimeout=5e3,this.retries=[],this.minTimeout=s,this.maxTimeout=r,this.retryTimeout=s,document.addEventListener("online",()=>{const t=this.retries;this.retries=[],this.retryTimeout=this.minTimeout;for(var o=0;o<t.length;++o)clearTimeout(t[o].tid),t[o].fn.call(this)},!1)}retry(s){var r=setTimeout(()=>{this.retries=this.retries.filter(function(t){return r!==t.tid}),s()},this.retryTimeout);this.retries.push({tid:r,fn:s}),this.retryTimeout*=2,this.retryTimeout>this.maxTimeout&&(this.retryTimeout=this.maxTimeout)}}}(f||(f={})),function(e){let I;!function(p){class l{static find(s,r){var t,o;if(!r)return;let i;for(const c of s)if(!r.platform||c.platform===r.platform)for(const n of c.collection)n.id===r.id&&(null!==(t=null==i?void 0:i.purchaseDate)&&void 0!==t?t:0)<(null!==(o=n.purchaseDate)&&void 0!==o?o:1)&&(i=n);return i}static isOwned(s,r){if(!r)return!1;const t=l.find(s,r);return!(!t||null!=t&&t.isExpired)&&(null==t||!t.expiryDate||t.expiryDate>+new Date)}static getVerifiedPurchases(s){var r,t,o,i;const c={};for(const n of s)for(const a of n.collection){const u=n.platform+":"+a.id,h=c[u];(!h||h&&(null!==(t=null!==(r=h.lastRenewalDate)&&void 0!==r?r:h.purchaseDate)&&void 0!==t?t:0)<(null!==(i=null!==(o=a.lastRenewalDate)&&void 0!==o?o:a.purchaseDate)&&void 0!==i?i:0))&&(c[u]=Object.assign(Object.assign({},a),{platform:n.platform}))}return Object.keys(c).map(n=>c[n])}}p.VerifiedReceipts=l}(I=e.Internal||(e.Internal={}))}(f||(f={})),function(e){let I;!function(p){let l;var r;let d,s;(r=l=p.ContactField||(p.ContactField={})).Name="name",r.EmailAddress="emailAddress",r.PhoneNumber="phoneNumber",r.PostalAddress="postalAddress",r.PhoneticName="phoneticName",function(r){r.Amex="Amex",r.Barcode="Barcode",r.CartesBancaires="CartesBancaires",r.ChinaUnionPay="ChinaUnionPay",r.Dankort="Dankort",r.Discover="Discover",r.Eftpos="Eftpos",r.Electron="Electron",r.Elo="Elo",r.Girocard="Girocard",r.IDCredit="IDCredit",r.Interac="Interac",r.JCB="JCB",r.Mada="Mada",r.Maestro="Maestro",r.MasterCard="MasterCard",r.Mir="Mir",r.Nanaco="Nanaco",r.PrivateLabel="PrivateLabel",r.QuicPay="QuicPay",r.Suica="Suica",r.Visa="Visa",r.VPay="VPay",r.Waon="Waon"}(d=p.PaymentNetwork||(p.PaymentNetwork={})),function(r){r.ThreeDS="3DS",r.EMV="EMV",r.Credit="Credit",r.Debit="Debit"}(s=p.MerchantCapability||(p.MerchantCapability={}))}(I=e.ApplePay||(e.ApplePay={}))}(f||(f={})),function(e){let I;!function(p){function l(r){return`virtual.${r}`}function s(r,t,o){return e.storeError(r,t,e.Platform.APPLE_APPSTORE,o)}p.Adapter=class d{constructor(t,o){var i,c;this.id=e.Platform.APPLE_APPSTORE,this.name="AppStore",this.ready=!1,this._canMakePayments=!1,this.forceReceiptReload=!1,this._products=[],this.validProducts={},this._paymentMonitor=()=>{},this.supportsParallelLoading=!0,this._appStoreReceiptLoading=!1,this._appStoreReceiptCallbacks=[],this.context=t,this.bridge=new p.Bridge.Bridge,this.log=t.log.child("AppleAppStore"),this.discountEligibilityDeterminer=o.discountEligibilityDeterminer,this.needAppReceipt=null===(i=o.needAppReceipt)||void 0===i||i,this.autoFinish=null!==(c=o.autoFinish)&&void 0!==c&&c,this.pseudoReceipt=new e.Receipt(e.Platform.APPLE_APPSTORE,this.context.apiDecorators),this.receiptsUpdated=e.Utils.debounce(()=>{this._receiptsUpdated()},300)}get products(){return this._products}getProduct(t){return this._products.find(o=>o.id===t)}get receipts(){return this.isSupported?(this._receipt?[this._receipt]:[]).concat(this.pseudoReceipt?this.pseudoReceipt:[]):[]}addValidProducts(t,o){o.forEach(i=>{const c=t.find(n=>n.id===i.id);c&&(this.validProducts[i.id]=Object.assign(Object.assign({},i),c))})}get isSupported(){return"ios"===window.cordova.platformId}upsertTransactionInProgress(t,o){const i=l(t);return new Promise(c=>{const n=this.pseudoReceipt.transactions.find(a=>a.transactionId===i);if(n)n.state=o,n.refresh(t),c(n);else{const a=new p.SKTransaction(e.Platform.APPLE_APPSTORE,this.pseudoReceipt,this.context.apiDecorators);a.state=o,a.transactionId=i,a.refresh(t),this.pseudoReceipt.transactions.push(a),c(a)}})}removeTransactionInProgress(t){const o=l(t);this.pseudoReceipt.transactions=this.pseudoReceipt.transactions.filter(i=>i.transactionId!==o)}upsertTransaction(t,o,i){return N(this,void 0,void 0,function*(){return new Promise(c=>{this.initializeAppReceipt(()=>{var n;if(!this._receipt)return void this.log.warn("Failed to load the application receipt, cannot proceed with handling the purchase");const a=null===(n=this._receipt)||void 0===n?void 0:n.transactions.find(u=>u.transactionId===o);if(a)a.state=i,a.refresh(t),c(a);else{const u=new p.SKTransaction(e.Platform.APPLE_APPSTORE,this._receipt,this.context.apiDecorators);u.state=i,u.transactionId=o,u.refresh(t),this._receipt.transactions.push(u),c(u)}})})})}removeTransaction(t){this._receipt&&(this._receipt.transactions=this._receipt.transactions.filter(o=>o.transactionId!==t))}_receiptsUpdated(){this._receipt?(this.log.debug("receipt updated and ready."),this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[this._receipt,this.pseudoReceipt]),this.context.listener.receiptsReady(e.Platform.APPLE_APPSTORE)):(this.log.debug("receipt updated."),this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[this.pseudoReceipt]))}setPaymentMonitor(t){this._paymentMonitor=t}callPaymentMonitor(t,o,i){this._paymentMonitor(t)}initialize(){return new Promise(t=>{this.log.info("bridge.init");const o=this.log.child("Bridge");this.bridge.init({autoFinish:this.autoFinish,debug:this.context.verbosity===e.LogLevel.DEBUG,log:i=>o.debug(i),error:(i,c,n)=>{this.log.error("ERROR: "+i+" - "+c),i!==e.ErrorCode.PAYMENT_CANCELLED?this.context.error(s(i,c,(null==n?void 0:n.productId)||null)):this.callPaymentMonitor("cancelled",e.ErrorCode.PAYMENT_CANCELLED,c)},ready:()=>{this.log.info("ready")},purchased:(i,c,n,a,u)=>N(this,void 0,void 0,function*(){this.log.info("purchase: id:"+i+" product:"+c+" originalTransaction:"+n+" - date:"+a+" - discount:"+u),(yield this.upsertTransaction(c,i,e.TransactionState.APPROVED)).refresh(c,n,a,u),this.removeTransactionInProgress(c),this.receiptsUpdated(),this.callPaymentMonitor("purchased")}),purchaseEnqueued:(i,c)=>N(this,void 0,void 0,function*(){this.log.info("purchaseEnqueued: "+i+" - "+c),yield this.upsertTransactionInProgress(i,e.TransactionState.INITIATED),this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[this.pseudoReceipt])}),purchaseFailed:(i,c,n)=>{this.log.info("purchaseFailed: "+i+" - "+c+" - "+n),this.removeTransactionInProgress(i),this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[this.pseudoReceipt]),this.callPaymentMonitor("failed",c,n)},purchasing:i=>N(this,void 0,void 0,function*(){this.log.info("purchasing: "+i),yield this.upsertTransactionInProgress(i,e.TransactionState.INITIATED),this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[this.pseudoReceipt])}),deferred:i=>N(this,void 0,void 0,function*(){this.log.info("deferred: "+i),yield this.upsertTransactionInProgress(i,e.TransactionState.PENDING),this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[this.pseudoReceipt]),this.callPaymentMonitor("deferred")}),finished:(i,c)=>N(this,void 0,void 0,function*(){this.log.info("finish: "+i+" - "+c),this.removeTransactionInProgress(c),yield this.upsertTransaction(c,i,e.TransactionState.FINISHED),this.receiptsUpdated()}),restored:(i,c)=>N(this,void 0,void 0,function*(){this.log.info("restore: "+i+" - "+c),yield this.upsertTransaction(c,i,e.TransactionState.APPROVED),this.receiptsUpdated()}),receiptsRefreshed:i=>{this.log.info("receiptsRefreshed"),this._receipt&&this._receipt.refresh(i,this.needAppReceipt,this.context.apiDecorators)},restoreFailed:i=>{this.log.info("restoreFailed: "+i),this.onRestoreCompleted&&(this.onRestoreCompleted(s(i,"Restore purchases failed",null)),this.onRestoreCompleted=void 0)},restoreCompleted:()=>{this.log.info("restoreCompleted"),this.onRestoreCompleted&&(this.onRestoreCompleted(void 0),this.onRestoreCompleted=void 0)}},()=>N(this,void 0,void 0,function*(){this.log.info("bridge.init done"),yield this.canMakePayments(),t(void 0)}),(i,c)=>{this.log.info("bridge.init failed: "+i+" - "+c),t(s(i,c,null))})})}loadReceipts(){return new Promise(t=>{setTimeout(()=>{this.initializeAppReceipt(()=>{this.receiptsUpdated(),t(this._receipt?[this._receipt,this.pseudoReceipt]:[this.pseudoReceipt])})},300)})}canMakePayments(){return N(this,void 0,void 0,function*(){return new Promise(t=>{this.bridge.canMakePayments(()=>{this._canMakePayments=!0,t(!0)},o=>{this.log.warn(`canMakePayments: ${o}`),this._canMakePayments=!1,t(!1)})})})}initializeAppReceipt(t){return N(this,void 0,void 0,function*(){if(this._receipt)return this.log.debug("initializeAppReceipt() => already initialized."),t(void 0);if(this._appStoreReceiptCallbacks.push(t),this._appStoreReceiptLoading)return void this.log.debug("initializeAppReceipt() => already loading.");this._appStoreReceiptLoading=!0;const o=yield this.loadAppStoreReceipt(),i=c=>{const n=this._appStoreReceiptCallbacks;this._appStoreReceiptCallbacks=[],n.forEach(a=>{a(c)})};if(null==o||!o.appStoreReceipt)return this.log.warn("no appStoreReceipt"),this._appStoreReceiptLoading=!1,void i(s(e.ErrorCode.REFRESH,"No appStoreReceipt",null));this._receipt=new p.SKApplicationReceipt(o,this.needAppReceipt,this.context.apiDecorators),i(void 0)})}prepareReceipt(t){null!=t&&t.appStoreReceipt&&(this._receipt?this._receipt.refresh(t,this.needAppReceipt,this.context.apiDecorators):this._receipt=new p.SKApplicationReceipt(t,this.needAppReceipt,this.context.apiDecorators))}loadAppStoreReceipt(){return N(this,void 0,void 0,function*(){let t=!1;return new Promise(o=>{var i;if(null!==(i=this.bridge.appStoreReceipt)&&void 0!==i&&i.appStoreReceipt&&!this.forceReceiptReload)return this.log.debug("using cached appstore receipt"),o(this.bridge.appStoreReceipt);this.log.debug("loading appstore receipt..."),this.forceReceiptReload=!1,this.bridge.loadReceipts(c=>{this.log.debug("appstore receipt loaded"),t||o(c),t=!0},(c,n)=>{this.log.warn("Failed to load appStoreReceipt: "+c+" - "+n),t||o(void 0),t=!0}),setTimeout(function(){t||o(void 0),t=!0},5e3)}).then(o=>(this.context.listener.receiptsReady(e.Platform.APPLE_APPSTORE),o)).catch(o=>(this.context.listener.receiptsReady(e.Platform.APPLE_APPSTORE),o))})}loadEligibility(t){return N(this,void 0,void 0,function*(){if(this.log.debug("load eligibility: "+JSON.stringify(t)),!this.discountEligibilityDeterminer)return this.log.debug("No discount eligibility determiner, skipping..."),new p.Internal.DiscountEligibilities([],[]);const o=[];if(t.forEach(i=>{var c,n,a;null===(c=i.discounts)||void 0===c||c.forEach(u=>{o.push({productId:i.id,discountId:u.id,discountType:u.type})}),0===(null!==(a=null===(n=i.discounts)||void 0===n?void 0:n.length)&&void 0!==a?a:0)&&i.introPrice&&o.push({productId:i.id,discountId:"intro",discountType:"Introductory"})}),o.length>0){const i=yield this.loadAppStoreReceipt();if(!i||!i.appStoreReceipt)return this.log.debug("no receipt, assuming introductory price are available."),new p.Internal.DiscountEligibilities(o,o.map(c=>"Introductory"===c.discountType));{this.log.debug("calling discount eligibility determiner.");const c=yield this.callDiscountEligibilityDeterminer(i,o);return this.log.debug("response: "+JSON.stringify(c)),new p.Internal.DiscountEligibilities(o,c)}}return new p.Internal.DiscountEligibilities([],[])})}callDiscountEligibilityDeterminer(t,o){return new Promise(i=>{if(!this.discountEligibilityDeterminer)return i([]);this.discountEligibilityDeterminer(t,o,i)})}loadProducts(t){return new Promise(o=>{this.log.info("bridge.load"),this.bridge.load(t.map(i=>i.id),(i,c)=>N(this,void 0,void 0,function*(){this.log.info("bridge.loaded: "+JSON.stringify({validProducts:i,invalidProducts:c})),this.addValidProducts(t,i);const n=yield this.loadEligibility(i);this.log.info("eligibilities ready: "+JSON.stringify(n));const a=t.map(u=>{if(c.indexOf(u.id)>=0)return this.log.debug(`${u.id} is invalid`),s(e.ErrorCode.INVALID_PRODUCT_ID,"Product not found in AppStore. #400",u.id);{const h=i.find(m=>m.id===u.id);if(this.log.debug(`${u.id} is valid: ${JSON.stringify(h)}`),!h)return s(e.ErrorCode.INVALID_PRODUCT_ID,"Product not found in AppStore. #404",u.id);let E=this.getProduct(u.id);return E?(this.log.debug("refreshing existing product"),null==E||E.refresh(h,this.context.apiDecorators,n)):(this.log.debug("registering new product"),E=new p.SKProduct(h,u,this.context.apiDecorators,n),this._products.push(E)),E}});this.log.debug(`Products loaded: ${JSON.stringify(a)}`),o(a)}),(i,c)=>t.map(n=>s(i,c,null)))})}order(t,o){return N(this,void 0,void 0,function*(){let i=!1;return new Promise(c=>{var n;const a=R=>{i||(this.setPaymentMonitor(()=>{}),i=!0,c(R))};this.log.info("order");const u=t.id!==p.DEFAULT_OFFER_ID?t.id:void 0,h=null===(n=null==o?void 0:o.appStore)||void 0===n?void 0:n.discount;return u&&!h?a(s(e.ErrorCode.MISSING_OFFER_PARAMS,"Missing additionalData.appStore.discount when ordering a discount offer",t.productId)):u&&(null==h?void 0:h.id)!==u?a(s(e.ErrorCode.INVALID_OFFER_IDENTIFIER,"Offer identifier does not match additionalData.appStore.discount.id",t.productId)):(this.setPaymentMonitor((R,O,T)=>{if(this.log.info("order.paymentMonitor => "+R+" "+(null!=O?O:"")+" "+(null!=T?T:"")),!i)switch(R){case"cancelled":a(s(null!=O?O:e.ErrorCode.PAYMENT_CANCELLED,null!=T?T:"The user cancelled the order.",t.productId));break;case"failed":setTimeout(()=>{a(s(null!=O?O:e.ErrorCode.PURCHASE,null!=T?T:"Purchase failed",t.productId))},500);break;case"purchased":case"deferred":a(void 0)}}),this.forceReceiptReload=!0,void this.bridge.purchase(t.productId,1,this.context.getApplicationUsername(),h,()=>{this.log.info("order.success")},()=>{this.log.info("order.error"),a(s(e.ErrorCode.PURCHASE,"Failed to place order",t.productId))}))})})}finish(t){return new Promise(o=>{if(this.log.info("finish("+t.transactionId+")"),t.transactionId===p.APPLICATION_VIRTUAL_TRANSACTION_ID||t.transactionId===l(t.products[0].id))return t.state=e.TransactionState.FINISHED,this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[t.parentReceipt]),o(void 0);const i=()=>{t.state=e.TransactionState.FINISHED,this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[t.parentReceipt]),o(void 0)};this.bridge.finish(t.transactionId,i,n=>{var a,u;null!=n&&n.includes("[#CdvPurchase:100]")?i():o(s(e.ErrorCode.FINISH,"Failed to finish transaction",null!==(u=null===(a=t.products[0])||void 0===a?void 0:a.id)&&void 0!==u?u:null))})})}refreshReceipt(){return new Promise(t=>{this.bridge.refreshReceipts(c=>{t(c)},(c,n)=>{t(s(c,n,null))})})}receiptValidationBody(t){return N(this,void 0,void 0,function*(){if(t.platform!==e.Platform.APPLE_APPSTORE||t!==this._receipt)return;const o=t;let i=o.nativeData;if(this.forceReceiptReload){const n=yield this.loadAppStoreReceipt();this.forceReceiptReload=!1,n&&(i=n,this.prepareReceipt(n))}if(!o.nativeData.appStoreReceipt){this.log.info("Cannot prepare the receipt validation body, because appStoreReceipt is missing. Refreshing...");const n=yield this.refreshReceipt();if(!n||"isError"in n)return this.log.warn("Failed to refresh receipt, cannot run receipt validation."),void(n&&this.log.error(n));this.log.info("Receipt refreshed."),i=n}const c=o.transactions.slice(-1)[0];return{id:i.bundleIdentifier,type:e.ProductType.APPLICATION,products:e.Utils.objectValues(this.validProducts).map(n=>new p.SKProduct(n,n,this.context.apiDecorators,{isEligible:()=>!0})),transaction:{type:"ios-appstore",id:null==c?void 0:c.transactionId,appStoreReceipt:i.appStoreReceipt}}})}handleReceiptValidationResponse(t,o){var i,c;return N(this,void 0,void 0,function*(){let n=!1;if(o.ok){const a=null===(i=o.data)||void 0===i?void 0:i.transaction;"ios-appstore"===(null==a?void 0:a.type)&&"original_application_version"in a&&(null===(c=this._receipt)||void 0===c||c.transactions.forEach(u=>{u.transactionId===p.APPLICATION_VIRTUAL_TRANSACTION_ID&&a.original_purchase_date_ms&&(u.purchaseDate=new Date(parseInt(a.original_purchase_date_ms)),n=!0)}))}n&&this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[t])})}requestPayment(t,o){return N(this,void 0,void 0,function*(){return s(e.ErrorCode.UNKNOWN,"requestPayment not supported",null)})}manageSubscriptions(){return N(this,void 0,void 0,function*(){this.bridge.manageSubscriptions()})}manageBilling(){return N(this,void 0,void 0,function*(){this.bridge.manageBilling()})}checkSupport(t){return"order"===t?this._canMakePayments:["order","manageBilling","manageSubscriptions"].indexOf(t)>=0}restorePurchases(){return new Promise(t=>{this.onRestoreCompleted=o=>{this.onRestoreCompleted=void 0,this.bridge.refreshReceipts(i=>{t(o)},(i,c)=>{t(o||s(i,c,null))})},this.forceReceiptReload=!0,this.bridge.restore()})}presentCodeRedemptionSheet(){return new Promise(t=>{this.bridge.presentCodeRedemptionSheet(t)})}}}(I=e.AppleAppStore||(e.AppleAppStore={}))}(f||(f={})),function(e){let I;!function(p){let l;!function(d){const s=c=>{};let r=s;function t(c,n,a,u){window.cordova.exec(a,u,"InAppPurchase",c,n)}function o(c,n,...a){if(c)try{c.apply(this,a)}catch(u){r("exception in "+n+': "'+u+'"')}}d.Bridge=class i{constructor(){this.transactionsForProduct={},this.initialized=!1,this.registeredProducts=[],this.needRestoreNotification=!1,this.pendingUpdates=[],this.onPurchased=!1,this.onFailed=!1,this.onRestored=!1,window.storekit=this,this.options={error:s,ready:s,purchased:s,purchaseEnqueued:s,purchasing:s,purchaseFailed:s,deferred:s,finished:s,restored:s,receiptsRefreshed:s,restoreFailed:s,restoreCompleted:s}}init(n,a,u){this.options={error:n.error||s,ready:n.ready||s,purchased:n.purchased||s,purchaseEnqueued:n.purchaseEnqueued||s,purchasing:n.purchasing||s,purchaseFailed:n.purchaseFailed||s,deferred:n.deferred||s,finished:n.finished||s,restored:n.restored||s,receiptsRefreshed:n.receiptsRefreshed||s,restoreFailed:n.restoreFailed||s,restoreCompleted:n.restoreCompleted||s},n.debug&&(t("debug",[],s,s),r=n.log||function(m){console.log("[CdvPurchase.AppAppStore.Bridge] "+m)}),n.autoFinish&&t("autoFinish",[],s,s),t("setup",[],()=>{r("setup ok"),o(this.options.ready,"options.ready"),o(a,"init.success"),this.initialized=!0,setTimeout(()=>this.processPendingTransactions(),50)},m=>{r("setup failed"),o(u,"init.error",e.ErrorCode.SETUP,"Setup failed: "+m)})}processPendingTransactions(){r("processing pending transactions"),t("processPendingTransactions",[],()=>{this.finalizeTransactionUpdates()},void 0)}purchase(n,a,u,h,E,m){a=0|a||1;const R=this.options;if(this.registeredProducts.indexOf(n)<0)return r("Purchasing "+n+" failed.  Ensure the product was loaded first with Bridge.load(...)!"),void("function"==typeof R.error&&o(R.error,"options.error",e.ErrorCode.PURCHASE,"Trying to purchase a unknown product.",{productId:n,quantity:a}));t("purchase",[n,a,u,h||{}],()=>{r("Purchase enqueued "+n),"function"==typeof R.purchaseEnqueued&&o(R.purchaseEnqueued,"options.purchaseEnqueued",n,a),o(E,"purchase.success")},()=>{const P="Purchase failed: "+n;r(P),"function"==typeof R.error&&o(R.error,"options.error",e.ErrorCode.PURCHASE,P,{productId:n,quantity:a}),o(m,"purchase.error")})}canMakePayments(n,a){return t("canMakePayments",[],n,a)}restore(n){this.needRestoreNotification=!0,t("restoreCompletedTransactions",[],n,n)}manageSubscriptions(n){t("manageSubscriptions",[],n,n)}manageBilling(n){t("manageBilling",[],n,n)}presentCodeRedemptionSheet(n){t("presentCodeRedemptionSheet",[],n,n)}load(n,a,u){const h=this.options;if("string"==typeof n&&(n=[n]),n)if(n.length){if("string"!=typeof n[0]){const R="invalid productIds given to store.load: "+JSON.stringify(n);return r(R),o(h.error,"options.error",e.ErrorCode.LOAD,R),void o(u,"load.error",e.ErrorCode.LOAD,R)}r("load "+JSON.stringify(n));const E=R=>{const O=R[0],T=R[1];r("load ok: { valid:"+JSON.stringify(O)+" invalid:"+JSON.stringify(T)+" }"),o(a,"load.success",O,T)},m=R=>{r("load failed"),r(R);const O="Load failed: "+R;o(h.error,"options.error",e.ErrorCode.LOAD,O),o(u,"load.error",e.ErrorCode.LOAD,O)};this.registeredProducts=this.registeredProducts.concat(n),t("load",[n],E,m)}else o(a,"load.success",[],[]);else o(a,"load.success",[],[])}finish(n,a,u){t("finishTransaction",[n],a,u)}finalizeTransactionUpdates(){for(let n=0;n<this.pendingUpdates.length;++n){const a=this.pendingUpdates[n];this.transactionUpdated(a.state,a.errorCode,a.errorText,a.transactionIdentifier,a.productId,a.transactionReceipt,a.originalTransactionIdentifier,a.transactionDate,a.discountId)}this.pendingUpdates=[]}lastTransactionUpdated(){}transactionUpdated(n,a,u,h,E,m,R,O,T){if(this.initialized)switch(r("transaction updated:"+h+" state:"+n+" product:"+E),E&&h&&(this.transactionsForProduct[E]?this.transactionsForProduct[E].push(h):this.transactionsForProduct[E]=[h]),n){case"PaymentTransactionStatePurchasing":return void o(this.options.purchasing,"options.purchasing",E);case"PaymentTransactionStatePurchased":return void o(this.options.purchased,"options.purchase",h,E,R,O,T);case"PaymentTransactionStateDeferred":return void o(this.options.deferred,"options.deferred",E);case"PaymentTransactionStateFailed":return o(this.options.purchaseFailed,"options.purchaseFailed",E,a||e.ErrorCode.UNKNOWN,u||"ERROR"),void o(this.options.error,"options.error",a||e.ErrorCode.UNKNOWN,u||"ERROR",{productId:E});case"PaymentTransactionStateRestored":return void o(this.options.restored,"options.restore",h,E);case"PaymentTransactionStateFinished":return void o(this.options.finished,"options.finish",h,E)}else this.pendingUpdates.push({state:n,errorCode:a,errorText:u,transactionIdentifier:h,productId:E,transactionReceipt:m,originalTransactionIdentifier:R,transactionDate:O,discountId:T})}restoreCompletedTransactionsFinished(){this.needRestoreNotification&&(this.needRestoreNotification=!1,o(this.options.restoreCompleted,"options.restoreCompleted"))}restoreCompletedTransactionsFailed(n){this.needRestoreNotification&&(this.needRestoreNotification=!1,o(this.options.restoreFailed,"options.restoreFailed",n))}parseReceiptArgs(n){const a=n[0],u=n[1],h=n[2],E=n[3],m=n[4];return r("infoPlist: "+u+","+h+","+E+","+m),{appStoreReceipt:a,bundleIdentifier:u,bundleShortVersion:h,bundleNumericVersion:E,bundleSignature:m}}refreshReceipts(n,a){this.appStoreReceipt=null,r("refreshing appStoreReceipt"),t("appStoreRefreshReceipt",[],E=>{const m=this.parseReceiptArgs(E);this.appStoreReceipt=m,o(this.options.receiptsRefreshed,"options.receiptsRefreshed",m),o(n,"refreshReceipts.success",m)},E=>{r("refresh receipt failed: "+E),E.includes("(@AMSErrorDomain:100)")&&r('authentication failed, indicated by the string "(@AMSErrorDomain:100)"'),o(this.options.error,"options.error",e.ErrorCode.REFRESH_RECEIPTS,"Failed to refresh receipt: "+E),o(a,"refreshReceipts.error",e.ErrorCode.REFRESH_RECEIPTS,"Failed to refresh receipt: "+E)})}loadReceipts(n,a){r("loading appStoreReceipt"),t("appStoreReceipt",[],E=>{const m=this.parseReceiptArgs(E);this.appStoreReceipt=m,o(n,"loadReceipts.callback",m)},E=>{})}}}(l=p.Bridge||(p.Bridge={}))}(I=e.AppleAppStore||(e.AppleAppStore={}))}(f||(f={})),function(e){let I;!function(p){let l;(l=p.Internal||(p.Internal={})).DiscountEligibilities=class s{constructor(t,o){this.request=t,this.response=o}isEligible(t,o,i){var c;for(let n=0;n<this.request.length;++n){const a=this.request[n];if(a.productId===t&&a.discountId===i&&a.discountType===o)return null!==(c=this.response[n])&&void 0!==c&&c}return!0}}}(I=e.AppleAppStore||(e.AppleAppStore={}))}(f||(f={})),function(e){let I;!function(p){p.DEFAULT_OFFER_ID="$";class l extends e.Offer{constructor(r,t){super(r,t),this.offerType=r.offerType}}p.SKOffer=l,p.SKProduct=class d extends e.Product{constructor(r,t,o,i){super(t,o),this.raw=r,this.refresh(r,o,i)}removeIneligibleDiscounts(r){this.offers=this.offers.filter(t=>"Default"===t.offerType||r.isEligible(this.id,t.offerType,t.id))}refresh(r,t,o){var i;this.raw=r,this.title=r.title,this.description=r.description,this.countryCode=r.countryCode,r.group&&(this.group=r.group),this.removeIneligibleDiscounts(o);const c={price:r.price,priceMicros:r.priceMicros,currency:r.currency,billingPeriod:a(r.billingPeriod,r.billingPeriodUnit),paymentMode:this.type===e.ProductType.PAID_SUBSCRIPTION?e.PaymentMode.PAY_AS_YOU_GO:e.PaymentMode.UP_FRONT,recurrenceMode:this.type===e.ProductType.PAID_SUBSCRIPTION?e.RecurrenceMode.INFINITE_RECURRING:e.RecurrenceMode.NON_RECURRING};if(null===(i=r.discounts)||void 0===i||i.forEach(u=>{if(o.isEligible(r.id,u.type,u.id)){const h=[],E=u.paymentMode===e.PaymentMode.PAY_AS_YOU_GO?u.period:1,R={price:u.price,priceMicros:u.priceMicros,currency:r.currency,billingPeriod:a(u.paymentMode===e.PaymentMode.PAY_AS_YOU_GO?1:u.period,u.periodUnit),billingCycles:E,paymentMode:u.paymentMode,recurrenceMode:e.RecurrenceMode.FINITE_RECURRING};h.push(R),h.push(c),this.addOffer(new l({id:u.id,product:this,pricingPhases:h,offerType:u.type},t))}}),!function n(u){return u.offers.filter(h=>"Introductory"===h.offerType||"Default"===h.offerType&&h.pricingPhases.length>1).length>0}(this)){const u=[];if(r.introPrice&&void 0!==r.introPriceMicros&&o.isEligible(r.id,"Introductory","intro")){const h={price:r.introPrice,priceMicros:r.introPriceMicros,currency:r.currency,billingPeriod:a(r.introPricePeriod,r.introPricePeriodUnit),paymentMode:r.introPricePaymentMode,recurrenceMode:e.RecurrenceMode.FINITE_RECURRING,billingCycles:1};u.push(h)}u.push(c),this.addOffer(new l({id:p.DEFAULT_OFFER_ID,product:this,pricingPhases:u,offerType:"Default"},t))}function a(u,h){if(u&&h)return`P${u}${h[0]}`}}}}(I=e.AppleAppStore||(e.AppleAppStore={}))}(f||(f={})),function(e){let I;var p;(p=I=e.AppleAppStore||(e.AppleAppStore={})).APPLICATION_VIRTUAL_TRANSACTION_ID="appstore.application",p.SKApplicationReceipt=class l extends e.Receipt{constructor(r,t,o){super(e.Platform.APPLE_APPSTORE,o),this.nativeData=r,this.refresh(this.nativeData,t,o)}refresh(r,t,o){if(this.nativeData=r,t){if(this.transactions.find(n=>n.transactionId===p.APPLICATION_VIRTUAL_TRANSACTION_ID))return;const c=new e.Transaction(e.Platform.APPLE_APPSTORE,this,o);c.transactionId=p.APPLICATION_VIRTUAL_TRANSACTION_ID,c.state=e.TransactionState.APPROVED,c.products.push({id:r.bundleIdentifier}),this.transactions.push(c)}}},p.SKTransaction=class d extends e.Transaction{refresh(r,t,o,i){r&&(this.products=[{id:r,offerId:i}]),t&&(this.originalTransactionId=t),o&&(this.purchaseDate=new Date(+o))}}}(f||(f={})),function(e){let I;!function(p){let l;!function(d){let s;var r;(r=s=d.AppleExpirationIntent||(d.AppleExpirationIntent={})).CANCELED="1",r.BILLING_ERROR="2",r.PRICE_INCREASE="3",r.PRODUCT_NOT_AVAILABLE="4",r.UNKNOWN="5"}(l=p.VerifyReceipt||(p.VerifyReceipt={}))}(I=e.AppleAppStore||(e.AppleAppStore={}))}(f||(f={})),function(e){let I;!function(p){class l extends e.Receipt{constructor(n,a,u){var h,E,m;super(e.Platform.BRAINTREE,u);const R=new e.Transaction(e.Platform.BRAINTREE,this,u);R.purchaseDate=new Date,R.products=(null===(h=n.items)||void 0===h?void 0:h.filter(O=>O).map(O=>({id:(null==O?void 0:O.id)||""})))||[],R.state=e.TransactionState.APPROVED,R.transactionId=null!==(m=null===(E=a.paymentMethodNonce)||void 0===E?void 0:E.nonce)&&void 0!==m?m:`UNKNOWN_${a.paymentMethodType}_${a.paymentDescription}`,this.transactions=[R],this.dropInResult=a,this.paymentRequest=n,this.refresh(n,a,u)}refresh(n,a,u){var h,E;this.dropInResult=a,this.paymentRequest=n;const m=new e.Transaction(e.Platform.BRAINTREE,this,u);m.products=n.items.filter(R=>R).map(R=>({id:(null==R?void 0:R.id)||""})),m.state=e.TransactionState.APPROVED,m.transactionId=null!==(E=null===(h=a.paymentMethodNonce)||void 0===h?void 0:h.nonce)&&void 0!==E?E:`UNKNOWN_${a.paymentMethodType}_${a.paymentDescription}`,m.amountMicros=n.amountMicros,m.currency=n.currency,this.transactions=[m]}}p.BraintreeReceipt=l,p.Adapter=class d{constructor(n,a){this.id=e.Platform.BRAINTREE,this.name="BrainTree",this.ready=!1,this.products=[],this._receipts=[],this.supportsParallelLoading=!1,this.context=n,this.log=n.log.child("Braintree"),this.options=a}get receipts(){return this._receipts}get isSupported(){return p.IosBridge.Bridge.isSupported()||p.AndroidBridge.Bridge.isSupported()}initialize(){return new Promise(n=>{this.log.info("initialize()"),p.IosBridge.Bridge.isSupported()?(this.log.info("instantiating ios bridge..."),this.iosBridge=new p.IosBridge.Bridge(this.log,a=>{this.options.tokenizationKey?a(this.options.tokenizationKey):this.options.clientTokenProvider?this.options.clientTokenProvider(a):a(i(e.ErrorCode.CLIENT_INVALID,"Braintree iOS Bridge requires a clientTokenProvider or tokenizationKey"))},this.options.applePay),this.iosBridge.initialize(this.context,n)):p.AndroidBridge.Bridge.isSupported()&&!this.androidBridge?(this.log.info("instantiating android bridge..."),this.androidBridge=new p.AndroidBridge.Bridge(this.log),this.log.info("calling android bridge -> initialize..."),this.androidBridge.initialize(this.options.tokenizationKey?this.options.tokenizationKey:this.options.clientTokenProvider?this.options.clientTokenProvider:"",n)):(this.log.info("platform not supported..."),n(void 0)),this.context.listener.receiptsReady(e.Platform.BRAINTREE)})}loadProducts(n){return N(this,void 0,void 0,function*(){return n.map(a=>i(e.ErrorCode.PRODUCT_NOT_AVAILABLE,"N/A"))})}loadReceipts(){return N(this,void 0,void 0,function*(){return this.context.listener.receiptsReady(e.Platform.BRAINTREE),[]})}order(n){return N(this,void 0,void 0,function*(){return i(e.ErrorCode.UNKNOWN,"N/A: Not implemented with Braintree")})}finish(n){return N(this,void 0,void 0,function*(){n.state=e.TransactionState.FINISHED,this.context.listener.receiptsUpdated(e.Platform.TEST,[n.parentReceipt])})}manageSubscriptions(){return N(this,void 0,void 0,function*(){this.log.info("N/A: manageSubscriptions() is not available with Braintree")})}manageBilling(){return N(this,void 0,void 0,function*(){this.log.info("N/A: manageBilling() is not available with Braintree")})}launchDropIn(n,a){return N(this,void 0,void 0,function*(){return this.androidBridge?this.androidBridge.launchDropIn(a):this.iosBridge?this.iosBridge.launchDropIn(n,a):i(e.ErrorCode.PURCHASE,"Braintree is not available")})}requestPayment(n,a){var u,h,E,m,R,O,T,P,g;return N(this,void 0,void 0,function*(){this.log.info("requestPayment()"+JSON.stringify(n));const y=(null===(u=null==a?void 0:a.braintree)||void 0===u?void 0:u.dropInRequest)||{};if((yield p.IosBridge.ApplePayPlugin.isSupported(this.log))||(this.log.info("Apple Pay is not supported."),y.applePayDisabled=!0),this.options.googlePay||y.googlePayRequest){const b=Object.assign(Object.assign({},null!==(h=this.options.googlePay)&&void 0!==h?h:{}),null!==(E=y.googlePayRequest)&&void 0!==E?E:{});b.transactionInfo||(b.transactionInfo={currencyCode:null!==(m=n.currency)&&void 0!==m?m:"",totalPrice:(null!==(R=n.amountMicros)&&void 0!==R?R:0)/1e6,totalPriceStatus:p.GooglePay.TotalPriceStatus.FINAL}),y.googlePayRequest=b}if(this.options.threeDSecure||y.threeDSecureRequest){const b=Object.assign(Object.assign({},null!==(O=this.options.threeDSecure)&&void 0!==O?O:{}),null!==(T=y.threeDSecureRequest)&&void 0!==T?T:{});b.amount||(b.amount=function s(c){const n=""+c/1e4;return(n.slice(0,-2)||"0")+"."+(n.slice(-2,-1)||"0")+(n.slice(-1)||"0")}(null!==(P=n.amountMicros)&&void 0!==P?P:0)),!b.billingAddress&&n.billingAddress&&(b.billingAddress={givenName:n.billingAddress.givenName,surname:n.billingAddress.surname,countryCodeAlpha2:n.billingAddress.countryCode,postalCode:n.billingAddress.postalCode,locality:n.billingAddress.locality,streetAddress:n.billingAddress.streetAddress1,extendedAddress:n.billingAddress.streetAddress2,line3:n.billingAddress.streetAddress3,phoneNumber:n.billingAddress.phoneNumber,region:n.billingAddress.region}),b.email||(b.email=n.email),y.threeDSecureRequest=b}const _=yield this.launchDropIn(n,y);if(!t(_))return o(this.log,_);const S=_;if(this.log.info("launchDropIn success: "+JSON.stringify({paymentRequest:n,dropInResult:S})),null===(g=S.paymentMethodNonce)||void 0===g||!g.nonce)return i(e.ErrorCode.BAD_RESPONSE,"launchDropIn returned no paymentMethodNonce");let A=this._receipts.find(b=>{var v,D;return(null===(v=b.dropInResult.paymentMethodNonce)||void 0===v?void 0:v.nonce)===(null===(D=S.paymentMethodNonce)||void 0===D?void 0:D.nonce)});return A?A.refresh(n,S,this.context.apiDecorators):(A=new l(n,S,this.context.apiDecorators),this.receipts.push(A)),this.context.listener.receiptsUpdated(e.Platform.BRAINTREE,[A]),A.transactions[0]})}receiptValidationBody(n){var a,u,h,E,m;return N(this,void 0,void 0,function*(){if(function r(c){return c.platform===e.Platform.BRAINTREE}(n))return this.log.info("create receiptValidationBody for: "+JSON.stringify(n)),{id:null!==(h=null===(u=null===(a=n.paymentRequest.items)||void 0===a?void 0:a[0])||void 0===u?void 0:u.id)&&void 0!==h?h:"unknown",type:e.ProductType.CONSUMABLE,priceMicros:n.paymentRequest.amountMicros,currency:n.paymentRequest.currency,products:[],transaction:{type:e.Platform.BRAINTREE,deviceData:n.dropInResult.deviceData,id:"nonce",paymentMethodNonce:null!==(m=null===(E=n.dropInResult.paymentMethodNonce)||void 0===E?void 0:E.nonce)&&void 0!==m?m:"",paymentDescription:n.dropInResult.paymentDescription,paymentMethodType:n.dropInResult.paymentMethodType}};this.log.error("Unexpected error, expecting a BraintreeReceipt: "+JSON.stringify(n))})}handleReceiptValidationResponse(n,a){var u;return N(this,void 0,void 0,function*(){if(this.log.info("receipt validation response: "+JSON.stringify(a)),null!=a&&a.data&&"transaction"in a.data&&"braintree"===a.data.transaction.type){const h=null===(u=a.data.transaction.data.transaction)||void 0===u?void 0:u.customer.id;h&&!p.customerId&&(this.log.info("customerId updated: "+h),p.customerId=h)}})}checkSupport(n){return"requestPayment"===n}restorePurchases(){return N(this,void 0,void 0,function*(){})}};const t=c=>!(!c||"code"in c&&"message"in c),o=(c,n)=>n?n.code===e.ErrorCode.PAYMENT_CANCELLED?void c.info("User cancelled the payment request"):(c.warn("launchDropIn failed: "+JSON.stringify(n)),n):(c.warn("launchDropIn failed: no response"),i(e.ErrorCode.BAD_RESPONSE,"Braintree failed to launch drop in"));function i(c,n){return e.storeError(c,n,e.Platform.BRAINTREE,null)}p.braintreeError=i}(I=e.Braintree||(e.Braintree={}))}(f||(f={})),function(e){let I;!function(p){const l="BraintreePlugin";let d;(d=p.AndroidBridge||(p.AndroidBridge={})).Bridge=class r{constructor(o){this.log=o.child("AndroidBridge")}listener(o){this.log.debug("listener: "+JSON.stringify(o)),o&&o.type&&"getClientToken"===o.type&&this.getClientToken()}initialize(o,i){try{if("string"==typeof o){const n=o;this.clientTokenProvider=a=>{a(n)}}else this.clientTokenProvider=o;this.log.info("exec.setListener()");const c=this.listener.bind(this);window.cordova.exec(c,null,l,"setListener",[]),i(void 0)}catch(c){this.log.warn("initialization failed: "+(null==c?void 0:c.message)),i(p.braintreeError(e.ErrorCode.SETUP,"Failed to initialize Braintree Android Bridge: "+(null==c?void 0:c.message)))}}getClientToken(){this.log.info("getClientToken()"),this.clientTokenProvider?(this.log.debug("clientTokenProvider set, calling."),this.clientTokenProvider(o=>{"string"==typeof o?window.cordova.exec(null,null,l,"onClientTokenSuccess",[o]):window.cordova.exec(null,null,l,"onClientTokenFailure",[o.code,o.message])})):(this.log.debug("clientTokenProvider not set, retrying later..."),setTimeout(()=>this.getClientToken(),1e3))}static isSupported(){return"android"===window.cordova.platformId}isApplePaySupported(){return N(this,void 0,void 0,function*(){return!1})}launchDropIn(o){return new Promise(i=>{window.cordova.exec(c=>{this.log.info("dropInSuccess: "+JSON.stringify(c)),i(c)},c=>{this.log.info("dropInFailure: "+c);const n=c.split("|")[0],a=c.split("|").slice(1).join("");i("UserCanceledException"===n?p.braintreeError(e.ErrorCode.PAYMENT_CANCELLED,a):"AuthorizationException"===n?p.braintreeError(e.ErrorCode.UNAUTHORIZED_REQUEST_DATA,a):p.braintreeError(e.ErrorCode.UNKNOWN,c))},l,"launchDropIn",[o])})}}}(I=e.Braintree||(e.Braintree={}))}(f||(f={})),function(e){let I;!function(p){let l;!function(d){const s="BraintreeApplePayPlugin";class r{static get(){return window.CdvPurchaseBraintreeApplePay}static requestPayment(o){return new Promise(i=>{var c;if(null===(c=r.get())||void 0===c||!c.installed)return i(p.braintreeError(e.ErrorCode.SETUP,"cordova-plugin-purchase-braintree-applepay does not appear to be installed."));window.cordova.exec(u=>{i(u)},u=>{i(p.braintreeError(e.ErrorCode.PURCHASE,"Braintree+ApplePay ERROR: "+(null!=u?u:"payment request failed")))},s,"presentDropInPaymentUI",[o])})}static isSupported(o){return new Promise(i=>{var c;if("ios"!==window.cordova.platformId)return o.info("BraintreeApplePayPlugin is only available for ios."),i(!1);if(null===(c=r.get())||void 0===c||!c.installed)return o.info("BraintreeApplePayPlugin does not appear to be installed."),i(!1);try{window.cordova.exec(n=>{i(n)},()=>{o.info("BraintreeApplePayPlugin is not available."),i(!1)},s,"isApplePaySupported",[])}catch{o.info("BraintreeApplePayPlugin is not installed."),i(!1)}})}}d.ApplePayPlugin=r}(l=p.IosBridge||(p.IosBridge={}))}(I=e.Braintree||(e.Braintree={}))}(f||(f={})),function(e){let I;!function(p){let d;var s;(s=d=p.IosBridge||(p.IosBridge={})).Bridge=class r{constructor(o,i,c){this.log=o.child("IosBridge"),this.clientTokenProvider=i,this.applePayOptions=c}initialize(o,i){window.cordova.exec(null,null,"BraintreePlugin","setVerbosity",[o.verbosity]),window.cordova.exec(c=>this.log.debug("(Native) "+c),null,"BraintreePlugin","setLogger",[]),setTimeout(()=>i(void 0),0)}continueDropInForApplePay(o,i,c){var n,a,u,h,E,m,R,O,T;return N(this,void 0,void 0,function*(){const P=(null===(a=null===(n=this.applePayOptions)||void 0===n?void 0:n.preparePaymentRequest)||void 0===a?void 0:a.call(n,o))||{merchantCapabilities:[e.ApplePay.MerchantCapability.ThreeDS]};if(!P.paymentSummaryItems){const y=o.items.filter(S=>S).map((S,A)=>{var b,v,D;return{type:"final",label:(null==S?void 0:S.title)||(null==S?void 0:S.id)||`Item #${A+1}`,amount:""+Math.round((null!==(D=null!==(v=null===(b=null==S?void 0:S.pricing)||void 0===b?void 0:b.priceMicros)&&void 0!==v?v:o.amountMicros)&&void 0!==D?D:0)/1e4)/100}}),_={type:"final",label:null!==(h=null===(u=this.applePayOptions)||void 0===u?void 0:u.companyName)&&void 0!==h?h:"Total",amount:""+Math.round((null!==(E=o.amountMicros)&&void 0!==E?E:0)/1e4)/100};P.paymentSummaryItems=[...y,_]}const g=yield s.ApplePayPlugin.requestPayment(P);return this.log.info("Result from Apple Pay: "+JSON.stringify(g)),"isError"in g?g:g.userCancelled?p.braintreeError(e.ErrorCode.PAYMENT_CANCELLED,"User cancelled the payment request"):{paymentMethodNonce:{isDefault:!1,nonce:null!==(R=null===(m=g.applePayCardNonce)||void 0===m?void 0:m.nonce)&&void 0!==R?R:"",type:null!==(T=null===(O=g.applePayCardNonce)||void 0===O?void 0:O.type)&&void 0!==T?T:""},paymentMethodType:c.paymentMethodType,deviceData:c.deviceData,paymentDescription:c.paymentDescription}})}launchDropIn(o,i){return new Promise(c=>N(this,void 0,void 0,function*(){const n=u=>{this.log.info("dropInSuccess: "+JSON.stringify(u)),u.paymentMethodType===p.DropIn.PaymentMethod.APPLE_PAY?(this.log.info("it's an ApplePay request, we have to process it."),this.continueDropInForApplePay(o,i,u).then(c)):c(u)},a=u=>{this.log.info("dropInFailure: "+u);const[h,E]=u.split("|");c("UserCanceledException"===h?p.braintreeError(e.ErrorCode.PAYMENT_CANCELLED,E):p.braintreeError(e.ErrorCode.UNKNOWN,"ERROR "+h+": "+E))};this.clientTokenProvider(u=>{"string"==typeof u?window.cordova.exec(n,a,"BraintreePlugin","launchDropIn",[u,i]):c(u)})}))}braintreePlugin(){return window.CdvPurchaseBraintree}static isSupported(){return"ios"===window.cordova.platformId}}}(I=e.Braintree||(e.Braintree={}))}(f||(f={})),function(e){let I;!function(p){let l;!function(d){let s;var r;(r=s=d.CardFormFieldStatus||(d.CardFormFieldStatus={}))[r.DISABLED=0]="DISABLED",r[r.OPTIONAL=1]="OPTIONAL",r[r.REQUIRED=2]="REQUIRED"}(l=p.DropIn||(p.DropIn={}))}(I=e.Braintree||(e.Braintree={}))}(f||(f={})),function(e){let I;!function(p){let l;!function(d){let s;var r;(r=s=d.PaymentMethod||(d.PaymentMethod={})).GOOGLE_PAY="GOOGLE_PAY",r.LASER="LASER",r.UK_MAESTRO="UK_MAESTRO",r.SWITCH="SWITCH",r.SOLOR="SOLO",r.APPLE_PAY="APPLE_PAY",r.AMEX="AMEX",r.DINERS_CLUB="DINERS_CLUB",r.DISCOVER="DISCOVER",r.JCB="JCB",r.MAESTRO="MAESTRO",r.MASTERCARD="MASTERCARD",r.PAYPAL="PAYPAL",r.VISA="VISA",r.VENMO="VENMO",r.UNIONPAY="UNIONPAY",r.HIPER="HIPER",r.HIPERCARD="HIPERCARD",r.UNKNOWN="UNKNOWN"}(l=p.DropIn||(p.DropIn={}))}(I=e.Braintree||(e.Braintree={}))}(f||(f={})),function(e){let I;!function(p){let l;!function(d){let s;var t;let r;(t=s=d.BillingAddressFormat||(d.BillingAddressFormat={}))[t.MIN=0]="MIN",t[t.FULL=1]="FULL",function(t){t[t.NOT_CURRENTLY_KNOWN=1]="NOT_CURRENTLY_KNOWN",t[t.ESTIMATED=2]="ESTIMATED",t[t.FINAL=3]="FINAL"}(r=d.TotalPriceStatus||(d.TotalPriceStatus={}))}(l=p.GooglePay||(p.GooglePay={}))}(I=e.Braintree||(e.Braintree={}))}(f||(f={})),function(e){let I;!function(p){let l;!function(d){let s;var o;let r,t;(o=s=d.AccountType||(d.AccountType={})).UNSPECIFIED="00",o.CREDIT="01",o.DEBIT="02",function(o){o[o.UNSPECIFIED=0]="UNSPECIFIED",o[o.SAME_DAY=1]="SAME_DAY",o[o.EXPEDITED=2]="EXPEDITED",o[o.PRIORITY=3]="PRIORITY",o[o.GROUND=4]="GROUND",o[o.ELECTRONIC_DELIVERY=5]="ELECTRONIC_DELIVERY",o[o.SHIP_TO_STORE=6]="SHIP_TO_STORE"}(r=d.ShippingMethod||(d.ShippingMethod={})),function(o){o[o.V1=0]="V1",o[o.V2=1]="V2"}(t=d.Version||(d.Version={}))}(l=p.ThreeDSecure||(p.ThreeDSecure={}))}(I=e.Braintree||(e.Braintree={}))}(f||(f={})),function(e){let I;!function(p){class l extends e.Transaction{constructor(o,i,c){super(e.Platform.GOOGLE_PLAY,i,c),this.nativePurchase=o,this.refresh(o)}static toState(o,i,c){switch(o){case p.Bridge.PurchaseState.PENDING:return e.TransactionState.INITIATED;case p.Bridge.PurchaseState.PURCHASED:return c?e.TransactionState.FINISHED:e.TransactionState.APPROVED;case p.Bridge.PurchaseState.UNSPECIFIED_STATE:return e.TransactionState.UNKNOWN_STATE}}refresh(o){var i,c;this.nativePurchase=o,this.transactionId=`${o.orderId||o.purchaseToken}`,this.purchaseId=`${o.purchaseToken}`,this.products=o.productIds.map(n=>({id:n})),o.purchaseTime&&(this.purchaseDate=new Date(o.purchaseTime)),this.isPending=o.getPurchaseState===p.Bridge.PurchaseState.PENDING,typeof o.acknowledged<"u"&&(this.isAcknowledged=o.acknowledged),typeof o.consumed<"u"&&(this.isConsumed=o.consumed),typeof o.autoRenewing<"u"&&(this.renewalIntent=o.autoRenewing?e.RenewalIntent.RENEW:e.RenewalIntent.LAPSE),this.state=l.toState(o.getPurchaseState,null!==(i=this.isAcknowledged)&&void 0!==i&&i,null!==(c=this.isConsumed)&&void 0!==c&&c)}}p.Transaction=l;class d extends e.Receipt{constructor(o,i){super(e.Platform.GOOGLE_PLAY,i),this.transactions=[new l(o,this,i)],this.purchaseToken=o.purchaseToken,this.orderId=o.orderId}refreshPurchase(o){var i;null===(i=this.transactions[0])||void 0===i||i.refresh(o),this.orderId=o.orderId}}p.Receipt=d;let s=(()=>{class t{constructor(i,c=864e5){if(this.id=e.Platform.GOOGLE_PLAY,this.name="GooglePlay",this.ready=!1,this.supportsParallelLoading=!1,this._receipts=[],this.bridge=new p.Bridge.Bridge,this.initialized=!1,this.retry=new e.Internal.Retry,this.autoRefreshIntervalMillis=0,t._instance)throw new Error("GooglePlay adapter already initialized");this._products=new p.Products(i.apiDecorators),this.autoRefreshIntervalMillis=c,this.context=i,this.log=i.log.child("GooglePlay"),t._instance=this}get products(){return this._products.products}get receipts(){return this._receipts}get isSupported(){return"android"===window.cordova.platformId}initialize(){return N(this,void 0,void 0,function*(){return this.log.info("Initialize"),this.initializationPromise?this.initializationPromise:this.initializationPromise=new Promise(i=>{const c=this.log.child("Bridge"),n={onSetPurchases:this.onSetPurchases.bind(this),onPurchasesUpdated:this.onPurchasesUpdated.bind(this),onPurchaseConsumed:this.onPurchaseConsumed.bind(this),showLog:this.context.verbosity>=e.LogLevel.DEBUG,log:h=>c.info(h)};this.bridge.init(()=>{this.log.debug("Ready"),this.autoRefreshIntervalMillis>0&&window.setInterval(()=>this.getPurchases(),this.autoRefreshIntervalMillis),i(void 0)},h=>{this.initialized=!1,this.context.error(r(e.ErrorCode.SETUP,"Init failed - "+h,null)),this.retry.retry(()=>this.initialize())},n)})})}getSkusOf(i){const c=[],n=[];for(const a of i)a.type===e.ProductType.PAID_SUBSCRIPTION?n.push(a.id):c.push(a.id);return{inAppSkus:c,subsSkus:n}}loadReceipts(){return new Promise(i=>{this.getPurchases().then(c=>{i(this._receipts)})})}loadProducts(i){return new Promise(c=>{this.log.debug("Load: "+JSON.stringify(i));const n=u=>{this.log.debug("Loaded: "+JSON.stringify(u));const h=i.map(E=>{const m=u.find(R=>R.productId===E.id);return m&&m.productId?this._products.addProduct(E,m):r(e.ErrorCode.INVALID_PRODUCT_ID,`Product with id ${E.id} not found.`,E.id)});c(h)},a=()=>{const{inAppSkus:u,subsSkus:h}=this.getSkusOf(i);this.log.debug("getAvailableProducts: "+JSON.stringify(u)+" | "+JSON.stringify(h)),this.bridge.getAvailableProducts(u,h,n,E=>{this.retry.retry(a),this.context.error(r(e.ErrorCode.LOAD,"Loading product info failed - "+E+" - retrying later...",null))})};a()})}finish(i){return new Promise(c=>{const n=()=>{i.state!==e.TransactionState.FINISHED&&(i.state=e.TransactionState.FINISHED,this.context.listener.receiptsUpdated(e.Platform.GOOGLE_PLAY,[i.parentReceipt])),c(void 0)},a=i.products[0];if(!a)return c(r(e.ErrorCode.FINISH,"Cannot finish a transaction with no product",null));const u=this._products.getProduct(a.id);if(!u)return c(r(e.ErrorCode.FINISH,"Cannot finish transaction, unknown product "+a.id,a.id));const h=this._receipts.find(m=>m.hasTransaction(i));if(!h)return c(r(e.ErrorCode.FINISH,"Cannot finish transaction, linked receipt not found.",u.id));if(!h.purchaseToken)return c(r(e.ErrorCode.FINISH,"Cannot finish transaction, linked receipt contains no purchaseToken.",u.id));const E=(m,R)=>c(r(R||e.ErrorCode.UNKNOWN,m,u.id));if(u.type===e.ProductType.NON_RENEWING_SUBSCRIPTION||u.type===e.ProductType.CONSUMABLE){if(!i.isConsumed)return this.bridge.consumePurchase(n,E,h.purchaseToken)}else if(!i.isAcknowledged)return this.bridge.acknowledgePurchase(n,E,h.purchaseToken);c(void 0)})}onPurchaseConsumed(i){this.log.debug("onPurchaseConsumed: "+i.orderId),i.acknowledged=!0,i.consumed=!0,this.onPurchasesUpdated([i])}onPurchasesUpdated(i){this.log.debug("onPurchaseUpdated: "+i.map(c=>c.orderId).join(", ")),i.forEach(c=>{const n=this.receipts.find(a=>a.purchaseToken===c.purchaseToken);if(n)n.refreshPurchase(c),this.context.listener.receiptsUpdated(e.Platform.GOOGLE_PLAY,[n]);else{const a=new d(c,this.context.apiDecorators);this.receipts.push(a),this.context.listener.receiptsUpdated(e.Platform.GOOGLE_PLAY,[a])}})}onSetPurchases(i){this.log.debug("onSetPurchases: "+JSON.stringify(i)),this.onPurchasesUpdated(i),this.context.listener.receiptsReady(e.Platform.GOOGLE_PLAY)}onPriceChangeConfirmationResult(i){}getPurchases(){return new Promise(i=>{this.log.debug("getPurchases"),this.bridge.getPurchases(()=>{this.log.debug("getPurchases success"),setTimeout(()=>i(void 0),0)},(a,u)=>{this.log.warn("getPurchases failed: "+a+" ("+u+")"),setTimeout(()=>i(r(u||e.ErrorCode.UNKNOWN,a,null)),0)})})}order(i,c){return N(this,void 0,void 0,function*(){return new Promise(n=>{this.log.info("Order - "+JSON.stringify(i));const a=()=>n(void 0),u=(h,E)=>{this.log.warn("Order failed: "+JSON.stringify({message:h,code:E})),n(r(null!=E?E:e.ErrorCode.UNKNOWN,h,i.productId))};if(i.productType===e.ProductType.PAID_SUBSCRIPTION){const h="token"in i?i.productId+"@"+i.token:i.productId,E=this.findOldPurchaseToken(i.productId,i.productGroup);E&&(c.googlePlay?c.googlePlay.oldPurchaseToken||(c.googlePlay.oldPurchaseToken=E):c.googlePlay={oldPurchaseToken:E}),this.bridge.subscribe(a,u,h,c)}else this.bridge.buy(a,u,i.productId,c)})})}findOldPurchaseToken(i,c){if(!c)return;const n=this._receipts.find(a=>!!a.transactions.find(u=>!!u.products.find(h=>{const E=this._products.getProduct(h.id);return!(!E||!e.Internal.LocalReceipts.isOwned([a],E))&&(h.id===i||c&&E.group===c)})));return null==n?void 0:n.purchaseToken}receiptValidationBody(i){var c;return N(this,void 0,void 0,function*(){const n=i.transactions[0];if(!n)return;const a=null===(c=n.products[0])||void 0===c?void 0:c.id;if(!a)return;const u=this._products.getProduct(a);if(!u)return;const h=n.nativePurchase;return{id:a,type:u.type,offers:u.offers,products:this._products.products,transaction:{type:e.Platform.GOOGLE_PLAY,id:i.transactions[0].transactionId,purchaseToken:h.purchaseToken,signature:h.signature,receipt:h.receipt}}})}handleReceiptValidationResponse(i,c){var n;return N(this,void 0,void 0,function*(){if(null!=c&&c.ok){const a=null===(n=null==c?void 0:c.data)||void 0===n?void 0:n.transaction;if((null==a?void 0:a.type)!==e.Platform.GOOGLE_PLAY)return}})}requestPayment(i,c){return N(this,void 0,void 0,function*(){return r(e.ErrorCode.UNKNOWN,"requestPayment not supported",null)})}manageSubscriptions(){return N(this,void 0,void 0,function*(){this.bridge.manageSubscriptions()})}manageBilling(){return N(this,void 0,void 0,function*(){this.bridge.manageBilling()})}checkSupport(i){return["order","manageBilling","manageSubscriptions"].indexOf(i)>=0}restorePurchases(){return new Promise(i=>{this.bridge.getPurchases(()=>i(void 0),(c,n)=>{this.log.warn("getPurchases() failed: "+(null!=n?n:"ERROR")+": "+c),i(r(null!=n?n:e.ErrorCode.UNKNOWN,c,null))})})}}return t.trimProductTitles=!0,t})();function r(t,o,i){return e.storeError(t,o,e.Platform.GOOGLE_PLAY,i)}p.Adapter=s}(I=e.GooglePlay||(e.GooglePlay={}))}(f||(f={})),function(e){let I;!function(p){let l;!function(d){let s;var r;(r=s=d.RecurrenceMode||(d.RecurrenceMode={})).FINITE_RECURRING="FINITE_RECURRING",r.INFINITE_RECURRING="INFINITE_RECURRING",r.NON_RECURRING="NON_RECURRING"}(l=p.Bridge||(p.Bridge={}))}(I=e.GooglePlay||(e.GooglePlay={}))}(f||(f={})),function(e){let I;!function(p){let l;var s;let d;(s=l=p.ProrationMode||(p.ProrationMode={})).IMMEDIATE_WITH_TIME_PRORATION="IMMEDIATE_WITH_TIME_PRORATION",s.IMMEDIATE_AND_CHARGE_PRORATED_PRICE="IMMEDIATE_AND_CHARGE_PRORATED_PRICE",s.IMMEDIATE_WITHOUT_PRORATION="IMMEDIATE_WITHOUT_PRORATION",s.DEFERRED="DEFERRED",s.IMMEDIATE_AND_CHARGE_FULL_PRICE="IMMEDIATE_AND_CHARGE_FULL_PRICE",function(s){let t,r=function(u){console.log("InAppBilling[js]: "+u)};var a;function i(a){return function(u){if(!a)return;const h="string"==typeof u?u.split("|"):[];h.length>1&&/^[-+]?(\d+)$/.test(h[0])?a(h[1],+h[0]):a(u)}}function n(a){const u=function c(a){return a&&a.constructor===Object?a:{}}(null==a?void 0:a.googlePlay);return!u.accountId&&null!=a&&a.applicationUsername&&(u.accountId=e.Utils.md5(a.applicationUsername)),u}(a=t=s.PurchaseState||(s.PurchaseState={}))[a.UNSPECIFIED_STATE=0]="UNSPECIFIED_STATE",a[a.PURCHASED=1]="PURCHASED",a[a.PENDING=2]="PENDING",s.Bridge=class o{constructor(){this.options={}}init(u,h,E){E||(E={}),E.log&&(r=E.log),this.options={showLog:!1!==E.showLog,onPurchaseConsumed:E.onPurchaseConsumed,onPurchasesUpdated:E.onPurchasesUpdated,onSetPurchases:E.onSetPurchases},this.options.showLog&&r("setup ok");const m=this.listener.bind(this);window.cordova.exec(m,function(R){},"InAppBillingPlugin","setListener",[]),window.cordova.exec(u,i(h),"InAppBillingPlugin","init",[])}load(u,h,E,m,R){if(typeof E<"u"&&("string"==typeof E&&(E=[E]),E.length>0)){if("string"!=typeof E[0]){var T="invalid productIds: "+JSON.stringify(E);return this.options.showLog&&r(T),void h(T,e.ErrorCode.INVALID_PRODUCT_ID)}this.options.showLog&&r("load "+JSON.stringify(E))}window.cordova.exec(u,i(h),"InAppBillingPlugin","load",[E,m,R])}listener(u){this.options.showLog&&r("listener: "+JSON.stringify(u)),u&&u.type&&("setPurchases"===u.type&&this.options.onSetPurchases&&this.options.onSetPurchases(u.data.purchases),"purchasesUpdated"===u.type&&this.options.onPurchasesUpdated&&this.options.onPurchasesUpdated(u.data.purchases),"purchaseConsumed"===u.type&&this.options.onPurchaseConsumed&&this.options.onPurchaseConsumed(u.data.purchase),"onPriceChangeConfirmationResultOK"===u.type&&this.options.onPriceChangeConfirmationResult&&this.options.onPriceChangeConfirmationResult("OK"),"onPriceChangeConfirmationResultUserCanceled"===u.type&&this.options.onPriceChangeConfirmationResult&&this.options.onPriceChangeConfirmationResult("UserCanceled"),"onPriceChangeConfirmationResultUnknownSku"===u.type&&this.options.onPriceChangeConfirmationResult&&this.options.onPriceChangeConfirmationResult("UnknownProduct"))}getPurchases(u,h){return this.options.showLog&&r("getPurchases()"),window.cordova.exec(u,i(h),"InAppBillingPlugin","getPurchases",["null"])}buy(u,h,E,m){return this.options.showLog&&r("buy()"),window.cordova.exec(u,i(h),"InAppBillingPlugin","buy",[E,n(m)])}subscribe(u,h,E,m){var R;return this.options.showLog&&r("subscribe()"),!(null===(R=m.googlePlay)||void 0===R)&&R.oldPurchaseToken&&this.options.showLog&&r("subscribe() -> upgrading from an old purchase"),window.cordova.exec(u,i(h),"InAppBillingPlugin","subscribe",[E,n(m)])}consumePurchase(u,h,E){return this.options.showLog&&r("consumePurchase()"),window.cordova.exec(u,i(h),"InAppBillingPlugin","consumePurchase",[E])}acknowledgePurchase(u,h,E){return this.options.showLog&&r("acknowledgePurchase()"),window.cordova.exec(u,i(h),"InAppBillingPlugin","acknowledgePurchase",[E])}getAvailableProducts(u,h,E,m){return this.options.showLog&&r("getAvailableProducts()"),window.cordova.exec(E,i(m),"InAppBillingPlugin","getAvailableProducts",[u,h])}manageSubscriptions(){return window.cordova.exec(function(){},function(){},"InAppBillingPlugin","manageSubscriptions",[])}manageBilling(){return window.cordova.exec(function(){},function(){},"InAppBillingPlugin","manageBilling",[])}launchPriceChangeConfirmationFlow(u){return window.cordova.exec(function(){},function(){},"InAppBillingPlugin","launchPriceChangeConfirmationFlow",[u])}}}(d=p.Bridge||(p.Bridge={}))}(I=e.GooglePlay||(e.GooglePlay={}))}(f||(f={})),function(e){let I;!function(p){class l extends e.Product{}p.GProduct=l;class d extends e.Offer{constructor(){super(...arguments),this.type="inapp"}}p.InAppOffer=d;class s extends e.Offer{constructor(o,i){super(o,i),this.type="subs",this.tags=o.tags,this.token=o.token}}p.SubscriptionOffer=s,p.Products=class r{constructor(o){this.products=[],this.offers=[],this.decorator=o}getProduct(o){return this.products.find(i=>i.id===o)}getOffer(o){return this.offers.find(i=>i.id===o)}addProduct(o,i){const c=this.getProduct(o.id),n=null!=c?c:new l(o,this.decorator);return n.title=i.title||i.name||n.title,p.Adapter.trimProductTitles&&(n.title=n.title.replace(/ \(.*\)$/,"")),n.description=i.description||n.description,"product_format"in i&&"v12.0"===i.product_format&&"subs"===i.product_type?this.onSubsV12Loaded(n,i):this.onInAppLoaded(n,i),c||this.products.push(n),n}onSubsV12Loaded(o,i){return i.offers.forEach(n=>{const a=n.pricing_phases.slice(-1)[0];if((null==a?void 0:a.recurrence_mode)===e.RecurrenceMode.FINITE_RECURRING){const h=function c(n){if(!n)return null;for(const a of i.offers)if(a.base_plan_id===n&&!a.offer_id)return a;return null}(n.base_plan_id);h&&h!==n&&n.pricing_phases.push(...h.pricing_phases)}const u=this.iabSubsOfferV12Loaded(o,i,n);o.addOffer(u)}),o}makeOfferId(o,i){return i.base_plan_id?i.offer_id?o+"@"+i.base_plan_id+"@"+i.offer_id:o+"@"+i.base_plan_id:o+"@"+i.token}iabSubsOfferV12Loaded(o,i,c){const n=this.makeOfferId(i.productId,c),a=this.getOffer(n),u=c.pricing_phases.map(h=>this.toPricingPhase(h));if(a)return a.pricingPhases=u,a;{const h=new s({id:n,product:o,pricingPhases:u,token:c.token,tags:c.tags},this.decorator);return this.offers.push(h),h}}onInAppLoaded(o,i){var c,n,a,u;const h=this.getOffer(i.productId),E=[{price:null!==(n=null!==(c=i.formatted_price)&&void 0!==c?c:i.price)&&void 0!==n?n:`${(null!==(a=i.price_amount_micros)&&void 0!==a?a:0)/1e6} ${i.price_currency_code}`,priceMicros:null!==(u=i.price_amount_micros)&&void 0!==u?u:0,currency:i.price_currency_code,recurrenceMode:e.RecurrenceMode.NON_RECURRING}];if(h)h.pricingPhases=E,o.offers=[h];else{const m=new d({id:i.productId,product:o,pricingPhases:E},this.decorator);this.offers.push(m),o.offers=[m]}return o}toPaymentMode(o){return 0===o.price_amount_micros?e.PaymentMode.FREE_TRIAL:o.recurrence_mode===p.Bridge.RecurrenceMode.NON_RECURRING?e.PaymentMode.UP_FRONT:e.PaymentMode.PAY_AS_YOU_GO}toRecurrenceMode(o){switch(o){case p.Bridge.RecurrenceMode.FINITE_RECURRING:return e.RecurrenceMode.FINITE_RECURRING;case p.Bridge.RecurrenceMode.INFINITE_RECURRING:return e.RecurrenceMode.INFINITE_RECURRING;case p.Bridge.RecurrenceMode.NON_RECURRING:return e.RecurrenceMode.NON_RECURRING}}toPricingPhase(o){return{price:o.formatted_price,priceMicros:o.price_amount_micros,currency:o.price_currency_code,billingPeriod:o.billing_period,billingCycles:o.billing_cycle_count,recurrenceMode:this.toRecurrenceMode(o.recurrence_mode),paymentMode:this.toPaymentMode(o)}}}}(I=e.GooglePlay||(e.GooglePlay={}))}(f||(f={})),function(e){let I;!function(p){let l;!function(d){let s;var t;let r;(t=s=d.GoogleErrorReason||(d.GoogleErrorReason={})).SUBSCRIPTION_NO_LONGER_AVAILABLE="subscriptionPurchaseNoLongerAvailable",t.PURCHASE_TOKEN_NO_LONGER_VALID="purchaseTokenNoLongerValid",function(t){t[t.GONE=410]="GONE"}(r=d.ErrorCode||(d.ErrorCode={}))}(l=p.PublisherAPI||(p.PublisherAPI={}))}(I=e.GooglePlay||(e.GooglePlay={}))}(f||(f={})),function(e){let I;!function(p){const l=e.Platform.TEST;let d=[];function s(o){o.products.forEach(i=>{var c,n,a,u;const h=d.find(m=>i.id===m.id),E={id:i.id,purchaseDate:null===(c=o.purchaseDate)||void 0===c?void 0:c.getTime(),expiryDate:null===(n=o.expirationDate)||void 0===n?void 0:n.getTime(),lastRenewalDate:null===(a=o.lastRenewalDate)||void 0===a?void 0:a.getTime(),renewalIntent:o.renewalIntent,renewalIntentChangeDate:null===(u=o.renewalIntentChangeDate)||void 0===u?void 0:u.getTime()};h?Object.assign(h,E):d.push(E)})}function t(o,i,c){return e.storeError(o,i,e.Platform.TEST,c)}p.Adapter=class r{constructor(i){this.id=e.Platform.TEST,this.name="Test",this.ready=!1,this.products=[],this.receipts=[],this.supportsParallelLoading=!0,this.context=i,this.log=i.log.child("Test")}get isSupported(){return!0}initialize(){return N(this,void 0,void 0,function*(){})}loadReceipts(){return N(this,void 0,void 0,function*(){return new Promise(i=>{setTimeout(()=>{this.context.listener.receiptsReady(e.Platform.TEST),i(this.receipts)},600)})})}loadProducts(i){return N(this,void 0,void 0,function*(){return i.map(c=>{if(!p.testProductsArray.find(u=>u.id===c.id&&u.type===c.type))return t(e.ErrorCode.PRODUCT_NOT_AVAILABLE,"This product is not available",c.id);const n=this.products.find(u=>u.id===c.id);if(n)return n;c.id===p.testProducts.PAID_SUBSCRIPTION_ACTIVE.id&&setTimeout(()=>{this.reportActiveSubscription()},500);const a=p.initTestProduct(c.id,this.context.apiDecorators);return a?(this.products.push(a),this.context.listener.productsUpdated(e.Platform.TEST,[a]),a):t(e.ErrorCode.PRODUCT_NOT_AVAILABLE,"Could not load this product",c.id)})})}order(i){return N(this,void 0,void 0,function*(){if(i.id.indexOf("-fail-")>0)return t(e.ErrorCode.PURCHASE,"Purchase failed.",i.productId);const c=this.products.find(h=>h.id===i.productId);if(!e.Internal.LocalReceipts.canPurchase(this.receipts,c))return t(e.ErrorCode.PURCHASE,"Product already owned",i.productId);const n=prompt(`Do you want to purchase ${i.productId} for ${i.pricingPhases[0].price}?\nEnter "Y" to confirm.\nEnter "E" to fail with an error.Anything else to cancel.`);if("E"===(null==n?void 0:n.toUpperCase()))return t(e.ErrorCode.PURCHASE,"Purchase failed",i.productId);if("Y"!==(null==n?void 0:n.toUpperCase()))return t(e.ErrorCode.PAYMENT_CANCELLED,"Purchase flow has been cancelled by the user",i.productId);const a=new e.Receipt(l,this.context.apiDecorators),u=new e.Transaction(l,a,this.context.apiDecorators);a.transactions=[u],u.products=[{id:i.productId,offerId:i.id}],u.state=e.TransactionState.APPROVED,u.purchaseDate=new Date,u.transactionId=i.productId+"-"+(new Date).getTime(),u.isAcknowledged=!1,i.productType===e.ProductType.PAID_SUBSCRIPTION&&(u.expirationDate=new Date(+new Date+6048e5),u.renewalIntent=e.RenewalIntent.RENEW),s(u),this.receipts.push(a),this.context.listener.receiptsUpdated(e.Platform.TEST,[a])})}finish(i){return new Promise(c=>{setTimeout(()=>{i.state=e.TransactionState.FINISHED,i.isAcknowledged=!0,s(i);const n=this.products.find(u=>i.products[0].id===u.id);(null==n?void 0:n.type)===e.ProductType.CONSUMABLE&&(i.isConsumed=!0);const a=this.receipts.filter(u=>u.hasTransaction(i));this.context.listener.receiptsUpdated(l,a),c(void 0)},500)})}receiptValidationBody(i){return N(this,void 0,void 0,function*(){})}handleReceiptValidationResponse(i,c){return N(this,void 0,void 0,function*(){})}requestPayment(i,c){var n;return N(this,void 0,void 0,function*(){yield e.Utils.asyncDelay(100);const a=prompt(`Mock payment of ${(null!==(n=i.amountMicros)&&void 0!==n?n:0)/1e6} ${i.currency}. Enter "Y" to confirm. Enter "E" to trigger an error.`);if("E"===(null==a?void 0:a.toUpperCase()))return t(e.ErrorCode.PAYMENT_NOT_ALLOWED,"Payment not allowed",null);if("Y"!==(null==a?void 0:a.toUpperCase()))return;const u=new e.Receipt(l,this.context.apiDecorators),h=new e.Transaction(e.Platform.TEST,u,this.context.apiDecorators);return h.purchaseDate=new Date,h.products=i.items.filter(E=>E).map(E=>({id:(null==E?void 0:E.id)||""})),h.state=e.TransactionState.APPROVED,h.transactionId="payment-"+(new Date).getTime(),h.amountMicros=i.amountMicros,h.currency=i.currency,u.transactions=[h],this.receipts.push(u),setTimeout(()=>{this.context.listener.receiptsUpdated(l,[u])},400),h})}manageSubscriptions(){return N(this,void 0,void 0,function*(){alert("Pseudo subscription management interface. Close it when you are done.")})}manageBilling(){return N(this,void 0,void 0,function*(){alert("Pseudo billing management interface. Close it when you are done.")})}reportActiveSubscription(){if(this.receipts.find(h=>h.transactions[0].transactionId===a(1)))return;const i=12e4,c=new e.Receipt(l,this.context.apiDecorators),n=h=>{var E,m;const R=new e.Transaction(l,c,this.context.apiDecorators);R.products=[{id:p.testProducts.PAID_SUBSCRIPTION_ACTIVE.id,offerId:p.testProducts.PAID_SUBSCRIPTION_ACTIVE.extra.offerId}],R.state=e.TransactionState.APPROVED,R.transactionId=a(h),R.isAcknowledged=1==h,R.renewalIntent=e.RenewalIntent.RENEW;const O=+((null===(m=null===(E=null==c?void 0:c.transactions)||void 0===E?void 0:E[0])||void 0===m?void 0:m.purchaseDate)||new Date);return R.purchaseDate=new Date(O),R.lastRenewalDate=new Date(O+i*(h-1)),R.expirationDate=new Date(O+i*h),s(R),R};function a(h){return"test-active-subscription-transaction-"+h}c.transactions.push(n(1)),this.receipts.push(c),this.context.listener.receiptsUpdated(e.Platform.TEST,[c]);let u=1;setInterval(()=>{this.log.info("auto-renewing the mock subscription"),u+=1,c.transactions.push(n(u)),this.context.listener.receiptsUpdated(e.Platform.TEST,[c])},i)}static verify(i,c){setTimeout(()=>{var n,a;c({receipt:i,payload:{ok:!0,data:{id:null===(a=null===(n=i.transactions[0])||void 0===n?void 0:n.products[0])||void 0===a?void 0:a.id,latest_receipt:!0,transaction:{type:"test"},collection:d}}})},500)}checkSupport(i){return!0}restorePurchases(){return N(this,void 0,void 0,function*(){})}}}(I=e.Test||(e.Test={}))}(f||(f={})),function(e){let I;!function(p){const l=e.Platform.TEST;p.testProducts={CONSUMABLE:{platform:l,id:"test-consumable",type:e.ProductType.CONSUMABLE},CONSUMABLE_FAILING:{platform:l,id:"test-consumable-fail",type:e.ProductType.CONSUMABLE},NON_CONSUMABLE:{platform:l,id:"test-non-consumable",type:e.ProductType.NON_CONSUMABLE},PAID_SUBSCRIPTION:{platform:l,id:"test-subscription",type:e.ProductType.PAID_SUBSCRIPTION},PAID_SUBSCRIPTION_ACTIVE:{platform:l,id:"test-subscription-active",type:e.ProductType.PAID_SUBSCRIPTION,extra:{offerId:"test-paid-subscription-active-offer1"}}},p.testProductsArray=e.Utils.objectValues(p.testProducts),p.initTestProduct=function d(s,r){const t=Object.keys(p.testProducts).find(i=>p.testProducts[i]&&p.testProducts[i].id===s);if(!t)return;const o=new e.Product(p.testProducts[t],r);switch(t){case"CONSUMABLE":o.title="Test Consumable",o.description="A consumable product that you can purchase",o.addOffer(new e.Offer({id:"test-consumable-offer1",pricingPhases:[{price:"$4.99",currency:"USD",priceMicros:499e4,paymentMode:e.PaymentMode.UP_FRONT,recurrenceMode:e.RecurrenceMode.NON_RECURRING}],product:o},r));break;case"CONSUMABLE_FAILING":o.title="Failing Consumable",o.description="A consumable product that cannot be purchased",o.addOffer(new e.Offer({id:"test-consumable-fail-offer1",pricingPhases:[{price:"$1.99",currency:"USD",priceMicros:199e4,paymentMode:e.PaymentMode.UP_FRONT,recurrenceMode:e.RecurrenceMode.NON_RECURRING}],product:o},r));break;case"NON_CONSUMABLE":o.title="Non Consumable",o.description="A non consumable product",o.addOffer(new e.Offer({id:"test-non-consumable-offer1",pricingPhases:[{price:"$9.99",currency:"USD",priceMicros:999e4,paymentMode:e.PaymentMode.UP_FRONT,recurrenceMode:e.RecurrenceMode.NON_RECURRING}],product:o},r));break;case"PAID_SUBSCRIPTION":o.title="A subscription product",o.description="An auto-renewing paid subscription with a trial period",o.addOffer(new e.Offer({id:"test-paid-subscription-offer1",product:o,pricingPhases:[{price:"$0.00",currency:"USD",priceMicros:0,paymentMode:e.PaymentMode.FREE_TRIAL,recurrenceMode:e.RecurrenceMode.FINITE_RECURRING,billingCycles:3,billingPeriod:"P1W"},{price:"$4.99",currency:"USD",priceMicros:499e4,paymentMode:e.PaymentMode.PAY_AS_YOU_GO,recurrenceMode:e.RecurrenceMode.INFINITE_RECURRING,billingPeriod:"P1M"}]},r));break;case"PAID_SUBSCRIPTION_ACTIVE":o.title="An owned subscription product",o.description="An active paid subscription",o.addOffer(new e.Offer({id:p.testProducts.PAID_SUBSCRIPTION_ACTIVE.extra.offerId,product:o,pricingPhases:[{price:"$19.99",currency:"USD",priceMicros:1999e4,paymentMode:e.PaymentMode.PAY_AS_YOU_GO,recurrenceMode:e.RecurrenceMode.INFINITE_RECURRING,billingPeriod:"P1Y"}]},r));break;default:throw new Error(`Unhandled enum case: ${t}`)}return o}}(I=e.Test||(e.Test={}))}(f||(f={})),function(e){let I;!function(p){function d(s,r,t){return e.storeError(s,r,e.Platform.WINDOWS_STORE,t)}p.Adapter=class l{constructor(){this.id=e.Platform.WINDOWS_STORE,this.name="WindowsStore",this.ready=!1,this.supportsParallelLoading=!1,this.products=[],this.receipts=[]}initialize(){return N(this,void 0,void 0,function*(){})}get isSupported(){return!1}loadProducts(r){return N(this,void 0,void 0,function*(){return r.map(t=>d(e.ErrorCode.PRODUCT_NOT_AVAILABLE,"TODO",t.id))})}loadReceipts(){return N(this,void 0,void 0,function*(){return[]})}order(r){return N(this,void 0,void 0,function*(){return d(e.ErrorCode.UNKNOWN,"TODO: Not implemented",r.productId)})}finish(r){return N(this,void 0,void 0,function*(){return d(e.ErrorCode.UNKNOWN,"TODO: Not implemented",null)})}handleReceiptValidationResponse(r,t){return N(this,void 0,void 0,function*(){})}receiptValidationBody(r){return N(this,void 0,void 0,function*(){})}requestPayment(r,t){return N(this,void 0,void 0,function*(){return d(e.ErrorCode.UNKNOWN,"requestPayment not supported",null)})}manageSubscriptions(){return N(this,void 0,void 0,function*(){return d(e.ErrorCode.UNKNOWN,"manageSubscriptions not supported",null)})}manageBilling(){return N(this,void 0,void 0,function*(){return d(e.ErrorCode.UNKNOWN,"manageBilling not supported",null)})}checkSupport(r){return!1}restorePurchases(){return N(this,void 0,void 0,function*(){})}}}(I=e.WindowsStore||(e.WindowsStore={}))}(f||(f={})),function(e){let I;!function(p){let l;(l=p.Ajax||(p.Ajax={})).HTTP_REQUEST_TIMEOUT=408,p.ajax=function d(r,t){if(typeof window<"u"&&window.cordova&&window.cordova.plugin&&window.cordova.plugin.http)return function s(r,t){let o=function(){};const i={method:(t.method||"get").toLowerCase(),data:t.data,serializer:"json"};t.customHeaders&&(r.debug("ajax[http] -> adding custom headers: "+JSON.stringify(t.customHeaders)),i.headers=t.customHeaders),r.debug("ajax[http] -> send request to "+t.url);const c=n=>{try{200==n.status?p.callExternal(r,"ajax.success",t.success,JSON.parse(n.data)):(r.warn("ajax[http] -> request to "+t.url+" failed with status "+n.status+" ("+n.error+")"),p.callExternal(r,"ajax.error",t.error,n.status,n.error))}catch(a){r.warn("ajax[http] -> request to "+t.url+" failed with an exception: "+a.message),t.error&&p.callExternal(r,"ajax.error",t.error,417,a.message)}p.callExternal(r,"ajax.done",o)};return window.cordova.plugin.http.sendRequest(t.url,i,c,c),{done:function(n){return o=n,this}}}(r,t);var o=function(){},i=new XMLHttpRequest;t.timeout&&(i.timeout=t.timeout,i.ontimeout=function(){r.warn("ajax -> request to "+t.url+" timeout"),p.callExternal(r,"ajax.error",t.error,l.HTTP_REQUEST_TIMEOUT,"Timeout")}),i.open(t.method||"POST",t.url,!0),i.onreadystatechange=function(){try{4===i.readyState&&(200===i.status?p.callExternal(r,"ajax.success",t.success,JSON.parse(i.responseText)):(r.warn("ajax -> request to "+t.url+" failed with status "+i.status+" ("+i.statusText+")"),p.callExternal(r,"ajax.error",t.error,i.status,i.statusText)))}catch(n){r.warn("ajax -> request to "+t.url+" failed with an exception: "+n.message),t.error&&t.error(417,n.message,null)}4===i.readyState&&p.callExternal(r,"ajax.done",o)};const c=t.customHeaders;return c&&Object.keys(c).forEach(function(n){r.debug("ajax -> adding custom header: "+n),i.setRequestHeader(n,c[n])}),i.setRequestHeader("Accept","application/json"),r.debug("ajax -> send request to "+t.url),t.data?(i.setRequestHeader("Content-Type","application/json;charset=UTF-8"),i.send(JSON.stringify(t.data))):i.send(),{done:function(n){return o=n,this}}}}(I=e.Utils||(e.Utils={}))}(f||(f={})),function(e){let I;(I=e.Utils||(e.Utils={})).callExternal=function l(d,s,r,...t){try{const o=Array.prototype.slice.call(arguments,3);r&&r.apply(e.store,o)}catch(o){d.logCallbackException(s,o)}}}(f||(f={})),function(e){let I;var p;(p=I=e.Utils||(e.Utils={})).delay=function l(r,t){return setTimeout(r,t)},p.debounce=function d(r,t){let o=null;const i=function(n,a){o=null,r()};return function(){o&&window.clearTimeout(o),o=setTimeout(i,t)}},p.asyncDelay=function s(r){return new Promise(t=>setTimeout(t,r))}}(f||(f={})),function(e){let I;var p;(p=I=e.Utils||(e.Utils={})).formatBillingCycleEN=function l(s){switch(function d(s){var r;const t=null!==(r=s.billingCycles)&&void 0!==r?r:0;if(s.recurrenceMode===e.RecurrenceMode.FINITE_RECURRING){if(1==t)return e.RecurrenceMode.NON_RECURRING;if(t<=0)return e.RecurrenceMode.INFINITE_RECURRING}return s.recurrenceMode}(s)){case e.RecurrenceMode.FINITE_RECURRING:return`${s.billingCycles}x ${p.formatDurationEN(s.billingPeriod)}`;case e.RecurrenceMode.NON_RECURRING:return"for "+p.formatDurationEN(s.billingPeriod);default:return"every "+p.formatDurationEN(s.billingPeriod,{omitOne:!0})}}}(f||(f={})),function(e){let I;(I=e.Utils||(e.Utils={})).formatDurationEN=function l(d,s){if(!d)return"";const r=d.length,t=d.slice(1,r-1);return"1"===t?null!=s&&s.omitOne?{D:"day",W:"week",M:"month",Y:"year"}[d[r-1]]||d[r-1]:{D:"1 day",W:"1 week",M:"1 month",Y:"1 year"}[d[r-1]]||d[r-1]:`${t} ${{D:"days",W:"weeks",M:"months",Y:"years"}[d[r-1]]||d[r-1]}`}}(f||(f={})),function(e){let I;!function(p){const l="0123456789abcdef".split("");function d(m){for(var R="",O=0;O<4;O++)R+=l[m>>8*O+4&15]+l[m>>8*O&15];return R}function s(m){const R=[];for(var O=m.length,T=0;T<O;T++)R.push(d(m[T]));return R.join("")}function r(m,R){return m+R&4294967295}function t(m,R,O,T,P,g,y){return function _(A,b,v){return r(A<<b|A>>>32-b,v)}(function S(A,b,v,D){return r(r(b,A),r(v,D))}(m,R,T,g),P,O)}var o=function(m,R,O,T,P,g,y,_){return t(O&T|~O&P,R,O,g,y,_)},i=function(m,R,O,T,P,g,y,_){return t(O&P|T&~P,R,O,g,y,_)},c=function(m,R,O,T,P,g,y,_){return t(O^T^P,R,O,g,y,_)},n=function(m,R,O,T,P,g,y,_){return t(T^(O|~P),R,O,g,y,_)};function a(m,R,O){O||(O=r);let T=m[0],P=m[1],g=m[2],y=m[3];var _=o.bind(null,O);T=_(T,P,g,y,R[0],7,-680876936),y=_(y,T,P,g,R[1],12,-389564586),g=_(g,y,T,P,R[2],17,606105819),P=_(P,g,y,T,R[3],22,-1044525330),T=_(T,P,g,y,R[4],7,-176418897),y=_(y,T,P,g,R[5],12,1200080426),g=_(g,y,T,P,R[6],17,-1473231341),P=_(P,g,y,T,R[7],22,-45705983),T=_(T,P,g,y,R[8],7,1770035416),y=_(y,T,P,g,R[9],12,-1958414417),g=_(g,y,T,P,R[10],17,-42063),P=_(P,g,y,T,R[11],22,-1990404162),T=_(T,P,g,y,R[12],7,1804603682),y=_(y,T,P,g,R[13],12,-40341101),g=_(g,y,T,P,R[14],17,-1502002290),P=_(P,g,y,T,R[15],22,1236535329);var S=i.bind(null,O);T=S(T,P,g,y,R[1],5,-165796510),y=S(y,T,P,g,R[6],9,-1069501632),g=S(g,y,T,P,R[11],14,643717713),P=S(P,g,y,T,R[0],20,-373897302),T=S(T,P,g,y,R[5],5,-701558691),y=S(y,T,P,g,R[10],9,38016083),g=S(g,y,T,P,R[15],14,-660478335),P=S(P,g,y,T,R[4],20,-405537848),T=S(T,P,g,y,R[9],5,568446438),y=S(y,T,P,g,R[14],9,-1019803690),g=S(g,y,T,P,R[3],14,-187363961),P=S(P,g,y,T,R[8],20,1163531501),T=S(T,P,g,y,R[13],5,-1444681467),y=S(y,T,P,g,R[2],9,-51403784),g=S(g,y,T,P,R[7],14,1735328473),P=S(P,g,y,T,R[12],20,-1926607734);var A=c.bind(null,O);T=A(T,P,g,y,R[5],4,-378558),y=A(y,T,P,g,R[8],11,-2022574463),g=A(g,y,T,P,R[11],16,1839030562),P=A(P,g,y,T,R[14],23,-35309556),T=A(T,P,g,y,R[1],4,-1530992060),y=A(y,T,P,g,R[4],11,1272893353),g=A(g,y,T,P,R[7],16,-155497632),P=A(P,g,y,T,R[10],23,-1094730640),T=A(T,P,g,y,R[13],4,681279174),y=A(y,T,P,g,R[0],11,-358537222),g=A(g,y,T,P,R[3],16,-722521979),P=A(P,g,y,T,R[6],23,76029189),T=A(T,P,g,y,R[9],4,-640364487),y=A(y,T,P,g,R[12],11,-421815835),g=A(g,y,T,P,R[15],16,530742520),P=A(P,g,y,T,R[2],23,-995338651);var b=n.bind(null,O);T=b(T,P,g,y,R[0],6,-198630844),y=b(y,T,P,g,R[7],10,1126891415),g=b(g,y,T,P,R[14],15,-1416354905),P=b(P,g,y,T,R[5],21,-57434055),T=b(T,P,g,y,R[12],6,1700485571),y=b(y,T,P,g,R[3],10,-1894986606),g=b(g,y,T,P,R[10],15,-1051523),P=b(P,g,y,T,R[1],21,-2054922799),T=b(T,P,g,y,R[8],6,1873313359),y=b(y,T,P,g,R[15],10,-30611744),g=b(g,y,T,P,R[6],15,-1560198380),P=b(P,g,y,T,R[13],21,1309151649),T=b(T,P,g,y,R[4],6,-145523070),y=b(y,T,P,g,R[11],10,-1120210379),g=b(g,y,T,P,R[2],15,718787259),P=b(P,g,y,T,R[9],21,-343485551),m[0]=O(T,m[0]),m[1]=O(P,m[1]),m[2]=O(g,m[2]),m[3]=O(y,m[3])}function u(m){for(var R=[],O=0;O<64;O+=4)R[O>>2]=m.charCodeAt(O)+(m.charCodeAt(O+1)<<8)+(m.charCodeAt(O+2)<<16)+(m.charCodeAt(O+3)<<24);return R}function h(m,R){let O;const T=m.length,P=[1732584193,-271733879,-1732584194,271733878];for(O=64;O<=T;O+=64)a(P,u(m.substring(O-64,O)),R);const g=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],y=(m=m.substring(O-64)).length;let _;for(_=0;_<y;_++)g[_>>2]|=m.charCodeAt(_)<<(_%4<<3);if(g[_>>2]|=128<<(_%4<<3),_>55)for(a(P,g,R),_=16;_--;)g[_]=0;return g[14]=8*T,a(P,g,R),P}p.md5=function E(m){if(!m)return"";let R;return"5d41402abc4b2a76b9719d911017c592"!==s(h("hello"))&&(R=function(O,T){const P=(65535&O)+(65535&T);return(O>>16)+(T>>16)+(P>>16)<<16|65535&P}),s(h(m,R))}}(I=e.Utils||(e.Utils={}))}(f||(f={})),function(e){let I;!function(p){function d(s,r,t,o,i,c){i||(i=t.name||"#"+p.md5(t.toString())),setTimeout(()=>{try{s.debug(`Calling callback: type=${r} name=${i} reason=${c}`),t(o)}catch(n){s.error(`Error in callback: type=${r} name=${i} reason=${c}`),s.debug(t.toString());const a=n;"message"in a&&s.error(a.message),"fileName"in n&&s.error("in "+n.fileName+":"+n.lineNumber),"stack"in a&&s.error(a.stack)}},0)}p.safeCallback=function l(s,r,t,o,i){return function(c){d(s,r,t,c,o,i)}},p.safeCall=d}(I=e.Utils||(e.Utils={}))}(f||(f={})),function(e){let I;(I=e.Utils||(e.Utils={})).uuidv4=function d(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(s){return(s^function l(){return window.crypto||window.msCrypto}().getRandomValues(new Uint8Array(1))[0]&15>>s/4).toString(16)})}}(f||(f={})),function(e){let I;!function(p){let l;(l=p.Internal||(p.Internal={})).getDeviceInfo=function o(i){const c=function t(i){return"string"==typeof i.validator_privacy_policy?i.validator_privacy_policy.split(","):function s(i){return"[object Array]"===Object.prototype.toString.call(i)}(i.validator_privacy_policy)?i.validator_privacy_policy:["analytics","support","fraud"]}(i);function n(m){return c.indexOf(m)>=0}const a={plugin:"cordova-plugin-purchase/"+e.PLUGIN_VERSION},u=window,h=function r(i){return"[object Object]"===Object.prototype.toString.call(i)}(u.device)?u.device:{};if(n("analytics")||n("support")){const m=u.Ionic||u.ionic;m&&m.version&&(a.ionic=m.version),h.cordova&&(a.cordova=h.cordova),h.model&&(a.model=h.model),h.platform&&(a.platform=h.platform),h.version&&(a.version=h.version),h.manufacturer&&(a.manufacturer=h.manufacturer)}if(n("tracking")&&(h.serial&&(a.serial=h.serial),h.uuid&&(a.uuid=h.uuid)),h.isVirtual&&(a.isVirtual=h.isVirtual),n("fraud")){var E="";h.serial?E="serial:"+h.serial:h.uuid?E="uuid:"+h.uuid:(h.model&&(E+="/"+h.model),h.manufacturer&&(E="/"+h.manufacturer)),E&&(a.fingerprint=e.Utils.md5(E))}return a}}(I=e.Validator||(e.Validator={}))}(f||(f={})),function(e){let I;!function(p){let l;l=p.Request||(p.Request={})}(I=e.Validator||(e.Validator={}))}(f||(f={})),function(e){e.VerifiedReceipt=class I{constructor(l,d,s){var r;this.className="VerifiedReceipt",this.id=d.id,this.sourceReceipt=l,this.collection=null!==(r=d.collection)&&void 0!==r?r:[],this.latestReceipt=d.latest_receipt,this.nativeTransactions=[d.transaction],this.warning=d.warning,Object.defineProperty(this,"raw",{enumerable:!1,get:()=>d}),Object.defineProperty(this,"finish",{enumerable:!1,get(){return()=>s.finish(this)}})}get platform(){return this.sourceReceipt.platform}get raw(){return{}}set(l,d){var s;this.id=d.id,this.sourceReceipt=l,this.collection=null!==(s=d.collection)&&void 0!==s?s:[],this.latestReceipt=d.latest_receipt,this.nativeTransactions=[d.transaction],this.warning=d.warning}finish(){return N(this,void 0,void 0,function*(){})}}}(f||(f={}))}}]);