"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[958],{3554:(A,U,f)=>{f.d(U,{e:()=>d});var e=f(6814),T=f(95),p=f(5548),l=f(6689);let d=(()=>{class s{}return s.\u0275fac=function(o){return new(o||s)},s.\u0275mod=l.oAB({type:s}),s.\u0275inj=l.cJS({imports:[e.ez,T.u5,p.Pc]}),s})()},1269:(A,U,f)=>{f.d(U,{O:()=>p});var e=f(6689),T=f(9862);let p=(()=>{class l{constructor(s){this.http=s}post(s,t){return this.http.post(s,t,{headers:this.getHeaders()})}getHeaders(){return{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}}}return l.\u0275fac=function(s){return new(s||l)(e.LFG(T.eN))},l.\u0275prov=e.Yz7({token:l,factory:l.\u0275fac,providedIn:"root"}),l})()},3990:(A,U,f)=>{f.d(U,{O:()=>I});var e=f(5861),T=f(6306),p=f(6973);function l(E,m){const P="object"==typeof m;return new Promise((O,b)=>{let v,N=!1;E.subscribe({next:D=>{v=D,N=!0},error:b,complete:()=>{N?O(v):P?O(m.defaultValue):b(new p.K)}})})}var d=f(553);const s=d.N.useFunctionsEmulator&&!d.N.production?"http://localhost:5001/balanced-budget-90f1f/us-central1/":"https://us-central1-balanced-budget-90f1f.cloudfunctions.net/",t=s+"getTransactionData",o=s+"createPlaidLinkToken",r=s+"exchangePublicToken";function c(E){const m=E.datetime?new Date(E.datetime):new Date(E.date);return{id:E.transaction_id,amount:E.amount,subcategoryId:"",date:m,merchant_name:E.merchant_name,name:E.name,pending:E.pending}}var n=f(6689),a=f(1269),u=f(4092),h=f(182),R=f(15);let _=(()=>{class E extends u.q{constructor(){super(h.lN)}get(P,O){var b=()=>super._get,N=this;return(0,e.Z)(function*(){const v=yield b().call(N,E.makeCollectionRef(P),O);return N.convertTimestampToDate(v)})()}getAll(){var P=()=>super._getAll,O=this;return(0,e.Z)(function*(){const b=yield P().call(O);return b.docs&&(b.docs=b.docs.map(N=>O.convertTimestampToDate(N))),b})()}getAllFromParent(P){var O=()=>super._getAllFromParent,b=this;return(0,e.Z)(function*(){const N=yield O().call(b,E.makeCollectionRef(P));return N.docs&&(N.docs=N.docs.map(v=>b.convertTimestampToDate(v))),N})()}getByQuery(P){var O=()=>super._getByQuery,b=this;return(0,e.Z)(function*(){const N=yield O().call(b,P);return N.docs&&(N.docs=N.docs.map(v=>b.convertTimestampToDate(v))),N})()}add(P,O,b){var N=()=>super._add,v=this;return(0,e.Z)(function*(){return N().call(v,E.makeCollectionRef(P),O,b)})()}update(P,O,b){var N=()=>super._update,v=this;return(0,e.Z)(function*(){return N().call(v,E.makeCollectionRef(P),O,b)})()}delete(P,O,b=!1){var N=()=>super._delete,v=this;return(0,e.Z)(function*(){return N().call(v,E.makeCollectionRef(P),O,b)})()}static makeCollectionRef(P){return(0,R.hJ)((0,R.ad)(),h.YP,P,h.lN)}convertTimestampToDate(P){if(!P)return P;const O=P.last_transaction_retrieval;return O&&(P.last_transaction_retrieval=O.toDate()),P}}return E.\u0275fac=function(P){return new(P||E)},E.\u0275prov=n.Yz7({token:E,factory:E.\u0275fac,providedIn:"root"}),E})();var g=f(7195),S=f(6635),y=f(5548);let I=(()=>{class E{constructor(P,O,b,N,v){this.http=P,this.linkedAccountsRepository=O,this.userRepository=b,this.transactionPublisher=N,this.loadingController=v}linkPlaidToUser(){var P=this;return(0,e.Z)(function*(){const O=yield P.loadingController.create();yield O.present(),P.http.post(o,{user_id:P.userRepository.getCurrentUserId()}).pipe((0,T.K)(b=>(console.log(b),O.dismiss(),b))).subscribe(b=>{console.log(b);const N=P.createPlaidHandler(b.link_token);O.dismiss(),N.open()})})()}syncPlaidTransactions(){var P=this;return(0,e.Z)(function*(){const O=P.userRepository.getCurrentUserId();if(!O)throw new Error("User is not logged in");const b=(yield P.linkedAccountsRepository.getAllFromParent(O)).docs;if(0===b.length)return;const N=[];for(let w of b)(yield P.shouldSyncTransactions(w))&&N.push(l(P.http.post(t,{userId:O,linkedAccount:w,linkedAccountId:w.id})));const v=yield Promise.all(N);let D=[],L=[],C=[];for(let w=0;w<v.length;w++){const M=v[w];D=D.concat(M.added),L=L.concat(M.removed),C=C.concat(M.modified)}P.plaidTransactionSyncHandler(D,L,C,!0)})()}createPlaidHandler(P){return Plaid.create({token:P,onSuccess:this.plaidHandlerOnSuccessCallback.bind(this),onExit:this.plaidHandlerOnExitCallback.bind(this),onLoad:this.plaidHandlerOnLoadCallback.bind(this),onEvent:this.plaidHandlerOnEventCallback.bind(this),receivedRedirectUri:null})}plaidHandlerOnSuccessCallback(P,O){this.http.post(r,{publicToken:P,institutionName:O.institution.name,userId:this.userRepository.getCurrentUserId()}).subscribe(b=>{console.log(b);const{added:N,removed:v,modified:D}=b;this.plaidTransactionSyncHandler(N,v,D,!0)})}plaidHandlerOnExitCallback(P,O){return(0,e.Z)(function*(){console.log(P)})()}plaidHandlerOnLoadCallback(){return(0,e.Z)(function*(){})()}plaidHandlerOnEventCallback(P,O){return(0,e.Z)(function*(){})()}plaidTransactionSyncHandler(P,O,b,N=!0){var v=this;return(0,e.Z)(function*(){const w={from:"plaid",addedTransactions:P.map(c),removedTransactions:O.map(c),modifiedTransactions:b.map(c)};return N&&v.transactionPublisher.publishEvent(w),w})()}shouldSyncTransactions(P){return(0,e.Z)(function*(){if(!P.last_transaction_retrieval)return!0;const b=P.last_transaction_retrieval;return(new Date).getTime()-b.getTime()>3e5})()}}return E.\u0275fac=function(P){return new(P||E)(n.LFG(a.O),n.LFG(_),n.LFG(g.E),n.LFG(S.u),n.LFG(y.HT))},E.\u0275prov=n.Yz7({token:E,factory:E.\u0275fac,providedIn:"root"}),E})()},6635:(A,U,f)=>{f.d(U,{u:()=>T});var e=f(6689);let T=(()=>{class p{constructor(){this.subscribers=new Set}publishEvent(d){console.log("Publishing event",d),this.subscribers.forEach(s=>{s.onTransactionEvent(d)})}subscribe(d){this.subscribers.add(d)}unsubscribe(d){this.subscribers.delete(d)}}return p.\u0275fac=function(d){return new(d||p)},p.\u0275prov=e.Yz7({token:p,factory:p.\u0275fac,providedIn:"root"}),p})()},958:(A,U,f)=>{f.r(U),f.d(U,{Tab3PageModule:()=>y});var e=f(5548),T=f(6814),p=f(95),l=f(3554),d=f(2607),s=f(5861),t=f(6689),o=f(1776),r=f(3251),i=f(3990),c=f(3076);f(3382);let a=(()=>{class I{constructor(m,P,O,b){this.platform=m,this.loadingCtrl=P,this.userService=O,this.alertCtrl=b,this.products=[],this.premium_yearly_id=(this.platform.is("ios"),"premium_yearly"),this.premium_id=(this.platform.is("ios"),"premium_sub"),this.platform.ready().then(()=>{this.platform.is("mobile")?(this.store=CdvPurchase.store,this.registerProducts(),this.setupListeners(),this.store.initialize([this.platform.is("ios")?CdvPurchase.Platform.APPLE_APPSTORE:CdvPurchase.Platform.GOOGLE_PLAY]),this.store.ready(()=>{this.products=this.store.products})):this.platform.is("desktop")})}registerProducts(){this.store.register([{type:CdvPurchase.ProductType.PAID_SUBSCRIPTION,id:this.premium_id,platform:this.platform.is("ios")?CdvPurchase.Platform.APPLE_APPSTORE:CdvPurchase.Platform.GOOGLE_PLAY},{type:CdvPurchase.ProductType.PAID_SUBSCRIPTION,id:this.premium_yearly_id,platform:this.platform.is("ios")?CdvPurchase.Platform.APPLE_APPSTORE:CdvPurchase.Platform.GOOGLE_PLAY}])}setupListeners(){this.store.when().approved(m=>((m.products[0].id===this.premium_id||m.products[0].id===this.premium_yearly_id)&&this.userService.updatePremiumStatus(!0),m.verify())).verified(m=>m.finish()).unverified(m=>m.finish()).finished(()=>{this.loader&&this.loader.dismiss()})}startPurchase(m){var P=this;return(0,s.Z)(function*(){let O;for(let b=0;b<P.products.length;b++)if(P.products[b].id==m){O=P.products[b];break}P.purchase(O)})()}purchase(m){var P=this;return(0,s.Z)(function*(){P.loader=yield P.loadingCtrl.create({message:"Loading..."}),yield P.loader.present();let O=m.getOffer();O&&P.store.order(O).then(b=>{},b=>{P.loader.dismiss(),P.presentAlert("Failed",`Failed to purchase: ${b}`)}).finally(()=>{P.loader.dismiss()})})()}restore(){this.store.restorePurchases()}presentAlert(m,P){var O=this;return(0,s.Z)(function*(){yield(yield O.alertCtrl.create({header:m,message:P,buttons:["OK"]})).present()})()}}return I.\u0275fac=function(m){return new(m||I)(t.LFG(e.t4),t.LFG(e.HT),t.LFG(c.K),t.LFG(e.Br))},I.\u0275prov=t.Yz7({token:I,factory:I.\u0275fac,providedIn:"root"}),I})();function u(I,E){if(1&I&&(t.TgZ(0,"p",16),t._uU(1),t.qZA()),2&I){const m=t.oxw(2);t.xp6(1),t.hij(" ",m.inapp.products[0].raw.price,"/month ")}}function h(I,E){if(1&I&&(t.TgZ(0,"p",16),t._uU(1),t.qZA()),2&I){const m=t.oxw(2);t.xp6(1),t.hij(" ",m.inapp.products[1].raw.price,"/year ")}}function R(I,E){if(1&I){const m=t.EpF();t.TgZ(0,"ion-card")(1,"ion-card-content")(2,"div",7)(3,"header"),t._UZ(4,"lottie-player",8),t.qZA(),t.TgZ(5,"section",9)(6,"h2"),t._uU(7,"Why Go Pro?"),t.qZA(),t.TgZ(8,"ul")(9,"li"),t._uU(10,"\u{1f680} Automatic Transaction Imports"),t.qZA(),t.TgZ(11,"li"),t._uU(12,"\u{1f552} Save Time with No More Manual Entries"),t.qZA(),t.TgZ(13,"li"),t._uU(14,"\u{1f3a8} Change the app's overall theme"),t.qZA()()(),t.TgZ(15,"section",10)(16,"h2"),t._uU(17,"Choose Your Plan"),t.qZA(),t.TgZ(18,"span",11)(19,"div",12)(20,"h3"),t._uU(21,"Monthly Plan"),t.qZA(),t.YNc(22,u,2,1,"p",13),t.TgZ(23,"p"),t._uU(24,"After 7-day Free Trial"),t.qZA(),t.TgZ(25,"button",14),t.NdJ("click",function(){t.CHM(m);const O=t.oxw();return t.KtG(O.purchase("premium_sub"))}),t._uU(26,"Go Monthly"),t.qZA()(),t.TgZ(27,"div",15)(28,"h3"),t._uU(29,"Yearly Plan"),t.qZA(),t.YNc(30,h,2,1,"p",13),t.TgZ(31,"p"),t._uU(32,"After 7-day Free Trial"),t.qZA(),t.TgZ(33,"button",14),t.NdJ("click",function(){t.CHM(m);const O=t.oxw();return t.KtG(O.purchase("premium_yearly"))}),t._uU(34,"Go Yearly"),t.qZA()()()()()()()}if(2&I){const m=t.oxw();t.xp6(22),t.Q6J("ngIf",m.inapp.products.length>0),t.xp6(8),t.Q6J("ngIf",m.inapp.products.length>0)}}const g=[{path:"",component:(()=>{class I{constructor(m,P,O,b,N,v){this.authService=m,this.router=P,this.alertService=O,this.plaidService=b,this.userService=N,this.inapp=v}link(){var m=this;return(0,s.Z)(function*(){m.plaidService.linkPlaidToUser()})()}signOut(){var m=this;return(0,s.Z)(function*(){(yield m.authService.logout())?m.router.navigateByUrl("login"):m.alertService.createAndShowToast("There was an error logging out")})()}purchase(m){this.inapp.startPurchase(m)}goToThemes(){this.router.navigateByUrl("tabs/tab3/themes")}}return I.\u0275fac=function(m){return new(m||I)(t.Y36(o.e),t.Y36(d.F0),t.Y36(r.c),t.Y36(i.O),t.Y36(c.K),t.Y36(a))},I.\u0275cmp=t.Xpm({type:I,selectors:[["app-tab3"]],decls:22,vars:5,consts:[[3,"translucent"],[3,"fullscreen"],["collapse","condense"],["size","large"],[4,"ngIf"],["button","",3,"disabled","click"],["button","",3,"click"],[1,"container"],["slot","end","autoplay","","loop","","src","https://lottie.host/1a9b80ea-1cb9-4b02-929a-0a9d8e7fcee2/bdrGIZRYXV.json"],[1,"benefits"],[1,"pricing"],[1,"row"],["id","monthly",1,"plan"],["class","price",4,"ngIf"],[3,"click"],["id","yearly",1,"plan"],[1,"price"]],template:function(m,P){1&m&&(t.TgZ(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),t._uU(3," Accounts "),t.qZA()()(),t.TgZ(4,"ion-content",1)(5,"ion-header",2)(6,"ion-toolbar")(7,"ion-title",3),t._uU(8,"Accounts"),t.qZA()()(),t.YNc(9,R,35,2,"ion-card",4),t.TgZ(10,"ion-card")(11,"ion-card-content")(12,"ion-list")(13,"ion-item",5),t.NdJ("click",function(){return P.link()}),t.TgZ(14,"ion-label"),t._uU(15,"Link Account"),t.qZA()(),t.TgZ(16,"ion-item",5),t.NdJ("click",function(){return P.goToThemes()}),t.TgZ(17,"ion-label"),t._uU(18,"Change App Theme"),t.qZA()(),t.TgZ(19,"ion-item",6),t.NdJ("click",function(){return P.signOut()}),t.TgZ(20,"ion-label"),t._uU(21,"Sign Out"),t.qZA()()()()()()),2&m&&(t.Q6J("translucent",!0),t.xp6(4),t.Q6J("fullscreen",!0),t.xp6(5),t.Q6J("ngIf",!P.userService.isPremium),t.xp6(4),t.Q6J("disabled",!P.userService.isPremium),t.xp6(3),t.Q6J("disabled",!P.userService.isPremium))},dependencies:[e.PM,e.FN,e.W2,e.Gu,e.Ie,e.Q$,e.q_,e.wd,e.sr,T.O5],styles:["ion-title[_ngcontent-%COMP%]{background:#f3f3f3}ion-toolbar[_ngcontent-%COMP%]{padding:0!important}.container[_ngcontent-%COMP%]{max-width:800px;margin:20px auto;padding:20px;border-radius:8px}header[_ngcontent-%COMP%]{text-align:center;display:flex;flex-direction:row;justify-content:center}header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{color:#00eabb}.benefits[_ngcontent-%COMP%]{margin:20px 0}.benefits[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%], .pricing[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{text-align:center;color:#2980b9}.benefits[_ngcontent-%COMP%]   ul[_ngcontent-%COMP%]{list-style:none;padding:0}.benefits[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{margin:10px 0;font-size:18px}.pricing[_ngcontent-%COMP%]{text-align:center}.pricing[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]{display:flex;flex-direction:row;justify-content:center;flex-wrap:nowrap}.plan[_ngcontent-%COMP%]{display:flex;min-width:50%;max-width:50%;margin:10px;padding:20px;background:#f9f9f9;border:1px solid #ddd;border-radius:8px;flex-direction:column;flex-wrap:nowrap;align-items:center;justify-content:center}.plan[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{color:#2980b9}.price[_ngcontent-%COMP%]{font-size:20px;color:#000}button[_ngcontent-%COMP%]{width:100%;padding:10px;border:none;border-radius:5px;background-color:#00eabb;color:#fff;font-size:18px;cursor:pointer;margin-top:10px}button[_ngcontent-%COMP%]:hover{background-color:#00cea5}lottie-player[_ngcontent-%COMP%]{width:225px;margin-top:-90px;text-align:center}"]}),I})()},{path:"themes",loadChildren:()=>f.e(67).then(f.bind(f,67)).then(I=>I.ThemesPageModule)}];let S=(()=>{class I{}return I.\u0275fac=function(m){return new(m||I)},I.\u0275mod=t.oAB({type:I}),I.\u0275inj=t.cJS({imports:[d.Bz.forChild(g),d.Bz]}),I})(),y=(()=>{class I{}return I.\u0275fac=function(m){return new(m||I)},I.\u0275mod=t.oAB({type:I}),I.\u0275inj=t.cJS({imports:[e.Pc,T.ez,p.u5,l.e,S]}),I})()},3382:function(){var e,f,A=this&&this.__awaiter||function(e,T,p,l){return new(p||(p=Promise))(function(s,t){function o(c){try{i(l.next(c))}catch(n){t(n)}}function r(c){try{i(l.throw(c))}catch(n){t(n)}}function i(c){c.done?s(c.value):function d(s){return s instanceof p?s:new p(function(t){t(s)})}(c.value).then(o,r)}i((l=l.apply(e,T||[])).next())})};function U(){var e;console.log("Create CdvPurchase...");const T=null===(e=window.CdvPurchase)||void 0===e?void 0:e.store;window.CdvPurchase=f,window.CdvPurchase.store=T||new f.Store,Object.assign(window.CdvPurchase.store,f.LogLevel,f.ProductType,f.ErrorCode,f.Platform)}!function(e){let p;var d;(d=p=e.ErrorCode||(e.ErrorCode={}))[d.SETUP=6777001]="SETUP",d[d.LOAD=6777002]="LOAD",d[d.PURCHASE=6777003]="PURCHASE",d[d.LOAD_RECEIPTS=6777004]="LOAD_RECEIPTS",d[d.CLIENT_INVALID=6777005]="CLIENT_INVALID",d[d.PAYMENT_CANCELLED=6777006]="PAYMENT_CANCELLED",d[d.PAYMENT_INVALID=6777007]="PAYMENT_INVALID",d[d.PAYMENT_NOT_ALLOWED=6777008]="PAYMENT_NOT_ALLOWED",d[d.UNKNOWN=6777010]="UNKNOWN",d[d.REFRESH_RECEIPTS=6777011]="REFRESH_RECEIPTS",d[d.INVALID_PRODUCT_ID=6777012]="INVALID_PRODUCT_ID",d[d.FINISH=6777013]="FINISH",d[d.COMMUNICATION=6777014]="COMMUNICATION",d[d.SUBSCRIPTIONS_NOT_AVAILABLE=6777015]="SUBSCRIPTIONS_NOT_AVAILABLE",d[d.MISSING_TOKEN=6777016]="MISSING_TOKEN",d[d.VERIFICATION_FAILED=6777017]="VERIFICATION_FAILED",d[d.BAD_RESPONSE=6777018]="BAD_RESPONSE",d[d.REFRESH=6777019]="REFRESH",d[d.PAYMENT_EXPIRED=6777020]="PAYMENT_EXPIRED",d[d.DOWNLOAD=6777021]="DOWNLOAD",d[d.SUBSCRIPTION_UPDATE_NOT_AVAILABLE=6777022]="SUBSCRIPTION_UPDATE_NOT_AVAILABLE",d[d.PRODUCT_NOT_AVAILABLE=6777023]="PRODUCT_NOT_AVAILABLE",d[d.CLOUD_SERVICE_PERMISSION_DENIED=6777024]="CLOUD_SERVICE_PERMISSION_DENIED",d[d.CLOUD_SERVICE_NETWORK_CONNECTION_FAILED=6777025]="CLOUD_SERVICE_NETWORK_CONNECTION_FAILED",d[d.CLOUD_SERVICE_REVOKED=6777026]="CLOUD_SERVICE_REVOKED",d[d.PRIVACY_ACKNOWLEDGEMENT_REQUIRED=6777027]="PRIVACY_ACKNOWLEDGEMENT_REQUIRED",d[d.UNAUTHORIZED_REQUEST_DATA=6777028]="UNAUTHORIZED_REQUEST_DATA",d[d.INVALID_OFFER_IDENTIFIER=6777029]="INVALID_OFFER_IDENTIFIER",d[d.INVALID_OFFER_PRICE=6777030]="INVALID_OFFER_PRICE",d[d.INVALID_SIGNATURE=6777031]="INVALID_SIGNATURE",d[d.MISSING_OFFER_PARAMS=6777032]="MISSING_OFFER_PARAMS",d[d.VALIDATOR_SUBSCRIPTION_EXPIRED=6778003]="VALIDATOR_SUBSCRIPTION_EXPIRED",e.storeError=function l(d,s,t,o){return{isError:!0,code:d,message:s,platform:t,productId:o}}}(f||(f={})),(e=f||(f={})).Iaptic=class T{constructor(l,d){this.config=l,l.url||(l.url="https://validator.iaptic.com"),this.store=null!=d?d:e.store,this.log=this.store.log.child("Iaptic")}get braintreeClientTokenProvider(){return l=>{this.log.info("Calling Braintree clientTokenProvider"),e.Utils.ajax(this.log,{url:`${this.config.url}/v3/braintree/client-token?appName=${this.config.appName}&apiKey=${this.config.apiKey}`,method:"POST",data:{applicationUsername:e.store.getApplicationUsername(),customerId:e.Braintree.customerId},success:d=>{this.log.info("clientTokenProvider success: "+JSON.stringify(d)),l(d.clientToken)},error:d=>{this.log.info("clientTokenProvider error: "+JSON.stringify(d)),l(e.storeError(d,"ERROR "+d,e.Platform.BRAINTREE,null))}})}}get appStoreDiscountEligibilityDeterminer(){let l;this.log.debug("AppStore eligibility determiner is listening..."),this.store.when().verified(t=>{t.platform===e.Platform.APPLE_APPSTORE&&(this.log.debug("Got a verified AppStore receipt."),l=t)},"appStoreDiscountEligibilityDeterminer_listening");const d=(t,o,r)=>{if(this.log.debug("AppStore eligibility determiner"),l)return this.log.debug("Using cached receipt"),r(s(l,o));const i=c=>{c.platform===e.Platform.APPLE_APPSTORE&&(this.log.debug("Receipt is verified, let's analyze the content and respond."),this.store.off(i),r(s(c,o)))};this.log.debug("Waiting for receipt"),this.store.when().verified(i,"appStoreDiscountEligibilityDeterminer_waiting")};return d.cacheReceipt=function(t){l=t},d;function s(t,o){const r=t.raw.ineligible_for_intro_price;return o.map(i=>{var c;return!("Introductory"===i.discountType&&r&&r.find(n=>i.productId===n)||"Subscription"===i.discountType&&!(null===(c=t.raw.collection)||void 0===c?void 0:c.find(a=>a.id===i.productId)))})}}get validator(){return`${this.config.url}/v1/validate?appName=${this.config.appName}&apiKey=${this.config.apiKey}`}},function(e){let T;var t;(t=T=e.LogLevel||(e.LogLevel={}))[t.QUIET=0]="QUIET",t[t.ERROR=1]="ERROR",t[t.WARNING=2]="WARNING",t[t.INFO=3]="INFO",t[t.DEBUG=4]="DEBUG";class p{constructor(o,r=""){this.prefix="",this.store=o,this.prefix=r||"CdvPurchase"}child(o){return new p(this.store,this.prefix+"."+o)}error(o){s(this.store.verbosity,T.ERROR,this.prefix,o);try{throw new Error(function d(t){return"string"!=typeof t&&(t=JSON.stringify(t)),t}(o))}catch(r){s(this.store.verbosity,T.ERROR,this.prefix,r.stack)}}warn(o){s(this.store.verbosity,T.WARNING,this.prefix,o)}info(o){s(this.store.verbosity,T.INFO,this.prefix,o)}debug(o){s(this.store.verbosity,T.DEBUG,this.prefix,o)}logCallbackException(o,r){this.warn("A callback in '"+o+"' failed with an exception."),"string"==typeof r?this.warn("           "+r):r&&(r.fileName&&this.warn("           "+r.fileName+":"+r.lineNumber),r.message&&this.warn("           "+r.message),r.stack&&this.warn("           "+r.stack))}}p.console=window.console,e.Logger=p;const l=["QUIET","ERROR","WARNING","INFO","DEBUG"];function s(t,o,r,i){if(o>(!0===t?1:t))return;"string"!=typeof i&&(i=JSON.stringify(i));const n=r?`[${r}] `:"";(o===T.ERROR?u=>p.console.error(u):o===T.WARNING?u=>p.console.warn(u):u=>p.console.log(u))(l[o]?`${n}${l[o]}: ${i}`:`${n}${i}`)}}(f||(f={})),function(e){let T;(T=e.Utils||(e.Utils={})).nonEnumerable=(l,d,s)=>{if(s)return s.enumerable=!1,s;Object.defineProperty(l,d,{set(t){Object.defineProperty(this,d,{value:t,writable:!0,configurable:!0})},configurable:!0})}}(f||(f={})),function(e){e.Product=class T{constructor(l,d){this.className="Product",this.title="",this.description="",this.platform=l.platform,this.type=l.type,this.id=l.id,this.group=l.group,this.offers=[],Object.defineProperty(this,"pricing",{enumerable:!1,get:()=>{var s;return null===(s=this.offers[0])||void 0===s?void 0:s.pricingPhases[0]}}),Object.defineProperty(this,"canPurchase",{enumerable:!1,get:()=>d.canPurchase(this)}),Object.defineProperty(this,"owned",{enumerable:!1,get:()=>d.owned(this)})}get pricing(){var l;return null===(l=this.offers[0])||void 0===l?void 0:l.pricingPhases[0]}get canPurchase(){return!1}get owned(){return!1}getOffer(l=""){return l?this.offers.find(d=>d.id===l):this.offers[0]}addOffer(l){return this.getOffer(l.id)||this.offers.push(l),this}}}(f||(f={})),function(e){let T;(T=e.Utils||(e.Utils={})).objectValues=function l(d){const s=[];for(let t in d)d.hasOwnProperty(t)&&s.push(d[t]);return s}}(f||(f={})),function(e){let T;(T=e.Utils||(e.Utils={})).platformName=function l(d){switch(d){case e.Platform.APPLE_APPSTORE:return"App Store";case e.Platform.GOOGLE_PLAY:return"Google Play";case e.Platform.WINDOWS_STORE:return"Windows Store";case e.Platform.BRAINTREE:return"Braintree";case e.Platform.TEST:return"Test";default:return d}}}(f||(f={})),function(e){let T;!function(p){class l{constructor(){this.array=[]}get length(){return this.array.length}get(){return this.array.concat()}add(o){this.has(o)||this.array.push(o)}clear(){for(;0!==this.array.length;)this.array.pop()}has(o){return!!this.array.find(r=>r===o)}}p.ReceiptsToValidate=l,p.Validator=class d{constructor(o,r){this.receiptsToValidate=new l,this.verifiedReceipts=[],this.numRequests=0,this.numResponses=0,this.cache={},this.controller=o,this.log=r.child("Validator")}incrRequestsCounter(){this.numRequests=this.numRequests+1|0,this.log.debug(`Validation requests=${this.numRequests} responses=${this.numResponses}`)}incrResponsesCounter(){this.numResponses=this.numResponses+1|0,this.log.debug(`Validation requests=${this.numRequests} responses=${this.numResponses}`)}addVerifiedReceipt(o,r){for(const c of this.verifiedReceipts)if(c.platform===o.platform&&c.id===r.id)return this.log.debug("Updating existing receipt."),c.set(o,r),c;this.log.debug("Register a new verified receipt.");const i=new e.VerifiedReceipt(o,r,this.controller);return this.verifiedReceipts.push(i),i}add(o){this.log.debug("Schedule validation: "+JSON.stringify(o));const r=o instanceof e.Transaction?o.parentReceipt:o;this.receiptsToValidate.has(r)||(this.incrRequestsCounter(),this.receiptsToValidate.add(r))}run(){const o=this.receiptsToValidate.get();this.receiptsToValidate.clear();const r=i=>A(this,void 0,void 0,function*(){var c;const{receipt:n,payload:a}=i;this.incrResponsesCounter();try{const u=this.controller.adapters.find(n.platform);if(yield null==u?void 0:u.handleReceiptValidationResponse(n,a),a.ok){const h=this.addVerifiedReceipt(n,a.data);this.controller.verifiedCallbacks.trigger(h,"payload_ok")}else if(a.code===e.ErrorCode.VALIDATOR_SUBSCRIPTION_EXPIRED){const h=null===(c=n.lastTransaction())||void 0===c?void 0:c.transactionId,R=h?this.verifiedReceipts.find(_=>{var g;return(null===(g=_.collection[0])||void 0===g?void 0:g.transactionId)===h}):void 0;R?(null==R||R.collection.forEach(_=>{_.transactionId===h&&(_.isExpired=!0)}),this.controller.verifiedCallbacks.trigger(R,"payload_expired")):this.controller.unverifiedCallbacks.trigger({receipt:n,payload:a},"no_verified_receipt")}else this.controller.unverifiedCallbacks.trigger({receipt:n,payload:a},"validator_error")}catch(u){this.log.error("Exception probably caused by an invalid response from the validator."+u.message),this.controller.unverifiedCallbacks.trigger({receipt:n,payload:{ok:!1,code:e.ErrorCode.VERIFICATION_FAILED,message:u.message}},"validator_exception")}});o.forEach(i=>this.runOnReceipt(i,r))}runOnReceipt(o,r){return A(this,void 0,void 0,function*(){if(o.platform===e.Platform.TEST)return this.log.debug("Using Test Adapter mock verify function."),e.Test.Adapter.verify(o,r);if(!this.controller.validator)return this.incrResponsesCounter(),void r({receipt:o,payload:{ok:!0,data:{id:o.transactions[0].transactionId,latest_receipt:!0,transaction:{type:"test"}}}});const i=yield this.buildRequestBody(o);if(i)return"function"==typeof this.controller.validator?this.runValidatorFunction(this.controller.validator,o,i,r):this.runValidatorRequest("string"==typeof this.controller.validator?{url:this.controller.validator,timeout:2e4}:this.controller.validator,o,i,r);this.incrResponsesCounter()})}runValidatorFunction(o,r,i,c){try{o(i,n=>c({receipt:r,payload:n}))}catch(n){this.log.warn("user provided validator function failed with error: "+(null==n?void 0:n.stack))}}buildRequestBody(o){var r,i,c;return A(this,void 0,void 0,function*(){const n=this.controller.adapters.find(o.platform),a=yield null==n?void 0:n.receiptValidationBody(o);if(a){if(a.additionalData=Object.assign(Object.assign({},null!==(r=a.additionalData)&&void 0!==r?r:{}),{applicationUsername:this.controller.getApplicationUsername()}),a.additionalData.applicationUsername||delete a.additionalData.applicationUsername,a.device=Object.assign(Object.assign({},null!==(i=a.device)&&void 0!==i?i:{}),e.Validator.Internal.getDeviceInfo(this.controller)),1===(null===(c=a.offers)||void 0===c?void 0:c.length)){const u=a.offers[0];if(1===u.pricingPhases.length){const h=u.pricingPhases[0];a.currency=h.currency,a.priceMicros=h.priceMicros}else if(2===u.pricingPhases.length){const h=u.pricingPhases[1];a.currency=h.currency,a.priceMicros=h.priceMicros,a.introPriceMicros=u.pricingPhases[0].priceMicros}}return a}})}removeExpiredCache(){const o=+new Date,r=[];for(const i in this.cache)this.cache[i].expires<o&&r.push(i);for(const i of r)delete this.cache[i]}runValidatorRequest(o,r,i,c){this.removeExpiredCache();const n=e.Utils.md5(JSON.stringify(i.transaction)),a=this.cache[n];if(a)return c({receipt:r,payload:a.payload});e.Utils.ajax(this.log.child("Ajax"),{url:o.url,method:"POST",customHeaders:o.headers,timeout:o.timeout,data:i,success:u=>{var h;if(this.log.debug("validator success, response: "+JSON.stringify(u)),!function s(t){return!!t&&"object"==typeof t&&"ok"in t&&"boolean"==typeof t.ok}(u))return c({receipt:r,payload:{ok:!1,code:e.ErrorCode.BAD_RESPONSE,message:"Validator responded with invalid data",data:{latest_receipt:null===(h=null==u?void 0:u.data)||void 0===h?void 0:h.latest_receipt}}});this.cache[n]={payload:u,expires:+new Date+12e4},c({receipt:r,payload:u})},error:(u,h,R)=>{var _="Error "+u+": "+h;this.log.debug("validator failed, response: "+JSON.stringify(_)),this.log.debug("body => "+JSON.stringify(R)),c({receipt:r,payload:{ok:!1,message:_,code:e.ErrorCode.COMMUNICATION,status:u,data:{}}})}})}}}(T=e.Internal||(e.Internal={}))}(f||(f={})),function(e){let T;(T=e.Internal||(e.Internal={})).Adapters=class l{constructor(){this.list=[]}add(s,t,o){t.forEach(r=>{if(s.info(""),!this.find(r.platform))switch(r.platform){case e.Platform.APPLE_APPSTORE:return this.list.push(new e.AppleAppStore.Adapter(o,r.options||{}));case e.Platform.GOOGLE_PLAY:return this.list.push(new e.GooglePlay.Adapter(o));case e.Platform.BRAINTREE:return r.options||s.error("Options missing for Braintree initialization. Use {platform: Platform.BRAINTREE, options: {...}} in your call to store.initialize"),this.list.push(new e.Braintree.Adapter(o,r.options));case e.Platform.TEST:return this.list.push(new e.Test.Adapter(o));default:return}})}initialize(s,t){return A(this,void 0,void 0,function*(){const o=s.map(n=>"string"==typeof n?{platform:n}:n).filter(n=>!this.find(n.platform)),r=t.log.child("Adapters");r.info("Adding platforms: "+JSON.stringify(o)),this.add(r,o,t);const i=t.registeredProducts.byPlatform();return(yield Promise.all(o.map(n=>A(this,void 0,void 0,function*(){var a,u,h;const R=null!==(h=null===(u=null===(a=i.filter(E=>E.platform===n.platform))||void 0===a?void 0:a[0])||void 0===u?void 0:u.products)&&void 0!==h?h:[],_=this.find(n.platform);if(!_)return;if(r.info(`${_.name} initializing...`),!_.isSupported)return void r.info(`${_.name} is not supported.`);const g=yield _.initialize();if(_.ready=!0,r.info(`${_.name} initialized. ${g?JSON.stringify(g):""}`),null!=g&&g.code)return g;if(r.info(`${_.name} products: ${JSON.stringify(R)}`),0===R.length)return;let S=[],y=[];_.supportsParallelLoading?[S,y]=yield Promise.all([_.loadProducts(R),_.loadReceipts()]):(S=yield _.loadProducts(R),y=yield _.loadReceipts()),r.info(`${_.name} products loaded: ${JSON.stringify(S)}`);const I=S.filter(E=>E instanceof e.Product);return t.listener.productsUpdated(n.platform,I),r.info(`${_.name} receipts loaded: ${JSON.stringify(y)}`),S.filter(E=>"code"in E&&"message"in E)[0]})))).filter(n=>n)})}find(s){return this.list.filter(t=>t.id===s)[0]}findReady(s){return this.list.filter(t=>(!s||t.id===s)&&t.ready)[0]}}}(f||(f={})),function(e){let T;!function(p){class l{constructor(s,t){this.supportedPlatforms=[],this.platformWithReceiptsReady=[],this.lastTransactionState={},this.lastCallTimeForState={},this.delegate=s,this.log=t.child("AdapterListener")}static makeTransactionToken(s){return s.platform+"|"+s.transactionId}setSupportedPlatforms(s){this.log.debug(`setSupportedPlatforms: ${s.join(",")} (${this.platformWithReceiptsReady.length} have their receipts ready)`),this.supportedPlatforms=s,this.supportedPlatforms.length===this.platformWithReceiptsReady.length&&(this.log.debug("triggering receiptsReady()"),this.delegate.receiptsReadyCallbacks.trigger(void 0,"adapterListener_setSupportedPlatforms"))}receiptsReady(s){this.supportedPlatforms.length>0&&this.platformWithReceiptsReady.length===this.supportedPlatforms.length?this.log.debug("receiptsReady: "+s+"(skipping)"):this.platformWithReceiptsReady.indexOf(s)<0&&(this.platformWithReceiptsReady.push(s),this.log.debug(`receiptsReady: ${s} (${this.platformWithReceiptsReady.length}/${this.supportedPlatforms.length})`),this.platformWithReceiptsReady.length===this.supportedPlatforms.length&&(this.log.debug("triggering receiptsReady()"),this.delegate.receiptsReadyCallbacks.trigger(void 0,"adapterListener_receiptsReady")))}productsUpdated(s,t){t.forEach(o=>this.delegate.updatedCallbacks.trigger(o,"adapterListener_productsUpdated"))}receiptsUpdated(s,t){const o=+new Date;this.log.debug("receiptsUpdated: "+JSON.stringify(t)),t.forEach(r=>{this.delegate.updatedReceiptCallbacks.trigger(r,"adapterListener_receiptsUpdated"),r.transactions.forEach(i=>{const c=l.makeTransactionToken(i),n=c+"@"+i.state,a=this.lastTransactionState[c];i.state===e.TransactionState.APPROVED?(0|this.lastCallTimeForState[n])<o-6e4&&(this.delegate.approvedCallbacks.trigger(i,"adapterListener_receiptsUpdated_approved"),this.lastCallTimeForState[n]=o):a!==i.state&&(i.state===e.TransactionState.FINISHED?(this.delegate.finishedCallbacks.trigger(i,"adapterListener_receiptsUpdated_finished"),this.lastCallTimeForState[n]=o):i.state===e.TransactionState.PENDING&&(this.delegate.pendingCallbacks.trigger(i,"adapterListener_receiptsUpdated_pending"),this.lastCallTimeForState[n]=o)),this.lastTransactionState[c]=i.state})})}}p.StoreAdapterListener=l}(T=e.Internal||(e.Internal={}))}(f||(f={})),function(e){let T;(T=e.Internal||(e.Internal={})).Callbacks=class l{constructor(s,t,o=!1){this.callbacks=[],this.numTriggers=0,this.logger=s,this.className=t,this.finalStateMode=o}push(s,t){if(this.finalStateMode&&this.numTriggers>0)s(this.lastTriggerArgument);else{for(const o of this.callbacks)if(o.callback===s)throw new Error("REGISTERING THE SAME CALLBACK TWICE? This is indicative of a bug in your integration.");this.callbacks.push({callback:s,callbackName:t})}}trigger(s,t){this.lastTriggerArgument=s,this.numTriggers++;const o=this.callbacks;this.finalStateMode&&(this.callbacks=[]),o.forEach(r=>{e.Utils.safeCall(this.logger,this.className,r.callback,s,r.callbackName,t)})}remove(s){this.callbacks=this.callbacks.filter(t=>t.callback!==s)}}}(f||(f={})),function(e){let T;(T=e.Internal||(e.Internal={})).ReadyCallbacks=class l{constructor(s){this.isReady=!1,this.readyCallbacks=[],this.logger=s}add(s){if(this.isReady)return setTimeout(s,0);this.readyCallbacks.push(s)}trigger(s){this.isReady=!0,this.readyCallbacks.forEach(t=>e.Utils.safeCall(this.logger,"ready()",t,void 0,void 0,s)),this.readyCallbacks=[]}remove(s){this.readyCallbacks=this.readyCallbacks.filter(t=>t!==s)}}}(f||(f={})),function(e){let T;(T=e.Internal||(e.Internal={})).RegisteredProducts=class d{constructor(){this.list=[]}find(t,o){return this.list.find(r=>r.platform===t&&r.id===o)}add(t){const o=[],i=(Array.isArray(t)?t:[t]).filter(c=>!this.find(c.platform,c.id));for(const c of i)"object"==typeof(s=c)&&s.hasOwnProperty("platform")&&s.hasOwnProperty("id")&&s.hasOwnProperty("type")?this.list.push(c):o.push(e.storeError(e.ErrorCode.LOAD,'Invalid parameter to "register", expected "id", "type" and "platform". Got: '+JSON.stringify(c),null,null));var s;return o}byPlatform(){const t={};return this.list.forEach(o=>{t[o.platform]=(t[o.platform]||[]).concat(o)}),Object.keys(t).map(o=>({platform:o,products:t[o]}))}}}(f||(f={})),function(e){let T;(T=e.Internal||(e.Internal={})).TransactionStateMonitors=class l{constructor(s){this.monitors=[],s.approved(t=>this.callOnChange(t),"transactionStateMonitors_callOnChange").finished(t=>this.callOnChange(t),"transactionStateMonitors_callOnChange")}findMonitors(s){return this.monitors.filter(t=>t.transaction.platform===s.platform&&t.transaction.transactionId===s.transactionId)}callOnChange(s){this.findMonitors(s).forEach(t=>{t.lastChange!==s.state&&(t.lastChange=s.state,t.onChange(s.state))})}start(s,t){const o=e.Utils.uuidv4();return this.monitors.push({monitorId:o,transaction:s,onChange:t,lastChange:s.state}),setTimeout(t,0,s.state),{transaction:s,stop:()=>this.stop(o)}}stop(s){this.monitors=this.monitors.filter(t=>t.monitorId!==s)}}}(f||(f={})),function(e){let T;(T=e.Internal||(e.Internal={})).ReceiptsMonitor=class l{constructor(s){this.hasCalledReceiptsVerified=!1,this.controller=s,this.log=s.log.child("ReceiptsMonitor")}callReceiptsVerified(){this.hasCalledReceiptsVerified||(this.hasCalledReceiptsVerified=!0,this.log.info("receiptsVerified()"),this.controller.when().receiptsReady(()=>{setTimeout(()=>{this.controller.receiptsVerified()},0)},"receiptsMonitor_callReceiptsVerified"))}launch(){const s=()=>{this.log.debug(`check(${this.controller.numValidationResponses()}/${this.controller.numValidationRequests()})`),this.controller.numValidationRequests()===this.controller.numValidationResponses()&&(void 0!==this.intervalChecker&&(clearInterval(this.intervalChecker),this.intervalChecker=void 0),this.controller.off(s),this.callReceiptsVerified())};this.controller.when().verified(s,"receiptsMonitor_check").unverified(s,"receiptsMonitor_check").receiptsReady(()=>{this.log.debug("receiptsReady..."),(!this.controller.hasLocalReceipts()||!this.controller.hasValidator())&&setTimeout(()=>{s()},0),this.intervalChecker=setInterval(()=>{this.log.debug("keep checking every 10s..."),s()},1e4)},"receiptsMonitor_setup")}}}(f||(f={})),function(e){let T;(T=e.Internal||(e.Internal={})).ExpiryMonitor=(()=>{class d{constructor(t){this.activePurchases={},this.notifiedPurchases={},this.controller=t}launch(){this.interval=setInterval(()=>{var t,o;const r=+new Date;for(const i of this.controller.verifiedReceipts){const c=null!==(t=d.GRACE_PERIOD_MS[i.platform])&&void 0!==t?t:d.GRACE_PERIOD_MS.DEFAULT;for(const n of i.collection)if(n.expiryDate){const a=n.expiryDate+c,u=null!==(o=n.transactionId)&&void 0!==o?o:`${a}`;a>r&&(this.activePurchases[u]=!0),a<r&&this.activePurchases[u]&&!this.notifiedPurchases[u]&&(this.notifiedPurchases[u]=!0,this.controller.onVerifiedPurchaseExpired(n,i))}}},d.INTERVAL_MS)}}return d.INTERVAL_MS=1e4,d.GRACE_PERIOD_MS={DEFAULT:6e4,"ios-appstore":6e4,"android-playstore":3e4},d})()}(f||(f={})),function(e){e.PLUGIN_VERSION="13.10.0",e.Store=class T{constructor(){this.adapters=new e.Internal.Adapters,this.registeredProducts=new e.Internal.RegisteredProducts,this.log=new e.Logger(this),this.verbosity=e.LogLevel.ERROR,this._readyCallbacks=new e.Internal.ReadyCallbacks(this.log),this.updatedCallbacks=new e.Internal.Callbacks(this.log,"productUpdated()"),this.updatedReceiptsCallbacks=new e.Internal.Callbacks(this.log,"receiptUpdated()"),this.approvedCallbacks=new e.Internal.Callbacks(this.log,"approved()"),this.finishedCallbacks=new e.Internal.Callbacks(this.log,"finished()"),this.pendingCallbacks=new e.Internal.Callbacks(this.log,"pending()"),this.verifiedCallbacks=new e.Internal.Callbacks(this.log,"verified()"),this.unverifiedCallbacks=new e.Internal.Callbacks(this.log,"unverified()"),this.receiptsReadyCallbacks=new e.Internal.Callbacks(this.log,"receiptsReady()",!0),this.receiptsVerifiedCallbacks=new e.Internal.Callbacks(this.log,"receiptsVerified()",!0),this.errorCallbacks=new e.Internal.Callbacks(this.log,"error()"),this.initializedHasBeenCalled=!1,this.lastUpdate=0,this.minTimeBetweenUpdates=6e5,this.version=e.PLUGIN_VERSION;const l=this;this.listener=new e.Internal.StoreAdapterListener({updatedCallbacks:this.updatedCallbacks,updatedReceiptCallbacks:this.updatedReceiptsCallbacks,approvedCallbacks:this.approvedCallbacks,finishedCallbacks:this.finishedCallbacks,pendingCallbacks:this.pendingCallbacks,receiptsReadyCallbacks:this.receiptsReadyCallbacks},this.log),this.transactionStateMonitors=new e.Internal.TransactionStateMonitors(this.when()),this._validator=new e.Internal.Validator({adapters:this.adapters,getApplicationUsername:this.getApplicationUsername.bind(this),get localReceipts(){return l.localReceipts},get validator(){return l.validator},get validator_privacy_policy(){return l.validator_privacy_policy},verifiedCallbacks:this.verifiedCallbacks,unverifiedCallbacks:this.unverifiedCallbacks,finish:d=>this.finish(d)},this.log),new e.Internal.ReceiptsMonitor({hasLocalReceipts:()=>this.localReceipts.length>0,hasValidator:()=>!!this.validator,numValidationRequests:()=>this._validator.numRequests,numValidationResponses:()=>this._validator.numResponses,off:this.off.bind(this),when:this.when.bind(this),receiptsVerified:()=>{l.receiptsVerifiedCallbacks.trigger(void 0,"receipts_monitor_controller")},log:this.log}).launch(),this.expiryMonitor=new e.Internal.ExpiryMonitor({get verifiedReceipts(){return l.verifiedReceipts},onVerifiedPurchaseExpired(d,s){l.verify(s.sourceReceipt)}}),this.expiryMonitor.launch()}getAdapter(l){return this.adapters.find(l)}getApplicationUsername(){return this.applicationUsername instanceof Function?this.applicationUsername():this.applicationUsername}register(l){this.registeredProducts.add(l).forEach(s=>{e.store.errorCallbacks.trigger(s,"register_error"),this.log.error(s)})}initialize(l=[this.defaultPlatform()]){return A(this,void 0,void 0,function*(){if(this.initializedHasBeenCalled)return this.log.warn("store.initialized() has been called already."),[];this.log.info("initialize()"),this.initializedHasBeenCalled=!0,this.lastUpdate=+new Date;const d=this,s=this.adapters.initialize(l,{error:this.triggerError.bind(this),get verbosity(){return d.verbosity},getApplicationUsername:()=>d.getApplicationUsername(),get listener(){return d.listener},get log(){return d.log},get registeredProducts(){return d.registeredProducts},apiDecorators:{canPurchase:this.canPurchase.bind(this),owned:this.owned.bind(this),finish:this.finish.bind(this),order:this.order.bind(this),verify:this.verify.bind(this)}});return s.then(()=>{this._readyCallbacks.trigger("initialize_promise_resolved"),this.listener.setSupportedPlatforms(this.adapters.list.filter(t=>t.isSupported).map(t=>t.id))}),s})}refresh(){throw new Error("use store.initialize() or store.update()")}update(){var l;return A(this,void 0,void 0,function*(){if(this.log.info("update()"),!this._readyCallbacks.isReady)return void this.log.warn("Do not call store.update() at startup! It is meant to reload the price of products (if needed) long after initialization.");const d=+new Date;if(this.lastUpdate>d-this.minTimeBetweenUpdates)this.log.info("Skipping store.update() as the last call occurred less than store.minTimeBetweenUpdates millis ago.");else{this.lastUpdate=d;for(const s of this.registeredProducts.byPlatform()){const t=yield null===(l=this.adapters.findReady(s.platform))||void 0===l?void 0:l.loadProducts(s.products);null==t||t.forEach(o=>{o instanceof e.Product&&this.updatedCallbacks.trigger(o,"update_has_loaded_products")})}}})}ready(l){this._readyCallbacks.add(l)}get isReady(){return this._readyCallbacks.isReady}when(){const l={productUpdated:(d,s)=>(this.updatedCallbacks.push(d,s),l),receiptUpdated:(d,s)=>(this.updatedReceiptsCallbacks.push(d,s),l),updated:(d,s)=>(this.updatedCallbacks.push(d,s),this.updatedReceiptsCallbacks.push(d,s),l),approved:(d,s)=>(this.approvedCallbacks.push(d,s),l),pending:(d,s)=>(this.pendingCallbacks.push(d,s),l),finished:(d,s)=>(this.finishedCallbacks.push(d,s),l),verified:(d,s)=>(this.verifiedCallbacks.push(d,s),l),unverified:(d,s)=>(this.unverifiedCallbacks.push(d,s),l),receiptsReady:(d,s)=>(this.receiptsReadyCallbacks.push(d,s),l),receiptsVerified:(d,s)=>(this.receiptsVerifiedCallbacks.push(d,s),l)};return l}off(l){this.updatedCallbacks.remove(l),this.updatedReceiptsCallbacks.remove(l),this.approvedCallbacks.remove(l),this.finishedCallbacks.remove(l),this.pendingCallbacks.remove(l),this.verifiedCallbacks.remove(l),this.unverifiedCallbacks.remove(l),this.receiptsReadyCallbacks.remove(l),this.receiptsVerifiedCallbacks.remove(l),this.errorCallbacks.remove(l),this._readyCallbacks.remove(l)}monitor(l,d,s){return this.transactionStateMonitors.start(l,e.Utils.safeCallback(this.log,"monitor()",d,s,"transactionStateMonitors_stateChanged"))}get products(){return[].concat(...this.adapters.list.map(l=>l.products))}get(l,d){var s;return null===(s=this.adapters.findReady(d))||void 0===s?void 0:s.products.find(t=>t.id===l)}get localReceipts(){return[].concat(...this.adapters.list.map(l=>l.receipts))}get localTransactions(){const l=[];for(const d of this.localReceipts)l.push(...d.transactions);return l}get verifiedReceipts(){return this._validator.verifiedReceipts}get verifiedPurchases(){return e.Internal.VerifiedReceipts.getVerifiedPurchases(this.verifiedReceipts)}findInVerifiedReceipts(l){return e.Internal.VerifiedReceipts.find(this.verifiedReceipts,l)}findInLocalReceipts(l){return e.Internal.LocalReceipts.find(this.localReceipts,l)}canPurchase(l){const d=l instanceof e.Offer?this.get(l.productId,l.platform):l,s=this.adapters.findReady(l.platform);return!(null==s||!s.checkSupport("order"))&&e.Internal.LocalReceipts.canPurchase(this.localReceipts,d)}owned(l){return e.Internal.owned({product:"string"==typeof l?{id:l}:l,verifiedReceipts:this.validator?this.verifiedReceipts:void 0,localReceipts:this.localReceipts})}order(l,d){return A(this,void 0,void 0,function*(){this.log.info(`order(${l.productId})`);const s=this.adapters.findReady(l.platform);if(!s)return e.storeError(e.ErrorCode.PAYMENT_NOT_ALLOWED,"Adapter not found or not ready ("+l.platform+")",l.platform,null);const t=yield s.order(l,d||{});return t&&"isError"in t&&e.store.triggerError(t),t})}requestPayment(l,d){var s,t,o,r,i;const c=this.adapters.findReady(l.platform);if(!c)return e.PaymentRequestPromise.failed(e.ErrorCode.PAYMENT_NOT_ALLOWED,"Adapter not found or not ready ("+l.platform+")",l.platform,null);if(!l.amountMicros){l.amountMicros=0;for(const a of l.items)l.amountMicros+=null!==(t=null===(s=null==a?void 0:a.pricing)||void 0===s?void 0:s.priceMicros)&&void 0!==t?t:0}if(l.currency)for(const a of l.items)if(null!==(r=null==a?void 0:a.pricing)&&void 0!==r&&r.currency){if(l.currency!==a.pricing.currency)return e.PaymentRequestPromise.failed(e.ErrorCode.PAYMENT_INVALID,"Currencies do not match",l.platform,a.id)}else null!=a&&a.pricing&&(a.pricing.currency=l.currency);else for(const a of l.items)null!==(o=null==a?void 0:a.pricing)&&void 0!==o&&o.currency&&(l.currency=a.pricing.currency);if(1===l.items.length){const a=l.items[0];a&&!a.pricing&&(a.pricing={priceMicros:null!==(i=l.amountMicros)&&void 0!==i?i:0,currency:l.currency})}const n=new e.PaymentRequestPromise;return c.requestPayment(l,d).then(a=>{if(n.trigger(a),a instanceof e.Transaction){const h=this.monitor(a,R=>{n.trigger(a),a.state===e.TransactionState.FINISHED&&h.stop()},"requestPayment_onStateChange")}}),n}checkSupport(l,d){const s=this.adapters.find(l);return!!s&&s.checkSupport(d)}verify(l){return A(this,void 0,void 0,function*(){this.log.info(`verify(${l.className})`),this._validator.add(l),setTimeout(()=>this._validator.run(),200)})}finish(l){return A(this,void 0,void 0,function*(){this.log.info(`finish(${l.className})`),(l instanceof e.VerifiedReceipt?l.sourceReceipt.transactions:l instanceof e.Receipt?l.transactions:[l]).forEach(s=>{var t;null===(t=this.adapters.findReady(s.platform))||void 0===t||t.finish(s)})})}restorePurchases(){return A(this,void 0,void 0,function*(){let l;for(const d of this.adapters.list)d.ready&&(l=null!=l?l:yield d.restorePurchases());return l})}manageSubscriptions(l){return A(this,void 0,void 0,function*(){this.log.info("manageSubscriptions()");const d=this.adapters.findReady(l);return d?d.manageSubscriptions():e.storeError(e.ErrorCode.SETUP,"Found no adapter ready to handle 'manageSubscription'",null!=l?l:null,null)})}manageBilling(l){return A(this,void 0,void 0,function*(){this.log.info("manageBilling()");const d=this.adapters.findReady(l);return d?d.manageBilling():e.storeError(e.ErrorCode.SETUP,"Found no adapter ready to handle 'manageBilling'",null!=l?l:null,null)})}defaultPlatform(){switch(window.cordova.platformId){case"android":return e.Platform.GOOGLE_PLAY;case"ios":return e.Platform.APPLE_APPSTORE;default:return e.Platform.TEST}}error(l){this.errorCallbacks.push(l)}triggerError(l){this.errorCallbacks.trigger(l,"triggerError")}}}(f||(f={})),window.cordova?setTimeout(U,0):U(),function(e){let T;var i;let p,l,d,s,t,o,r;(i=T=e.ProductType||(e.ProductType={})).CONSUMABLE="consumable",i.NON_CONSUMABLE="non consumable",i.FREE_SUBSCRIPTION="free subscription",i.PAID_SUBSCRIPTION="paid subscription",i.NON_RENEWING_SUBSCRIPTION="non renewing subscription",i.APPLICATION="application",function(i){i.NON_RECURRING="NON_RECURRING",i.FINITE_RECURRING="FINITE_RECURRING",i.INFINITE_RECURRING="INFINITE_RECURRING"}(p=e.RecurrenceMode||(e.RecurrenceMode={})),function(i){i.PAY_AS_YOU_GO="PayAsYouGo",i.UP_FRONT="UpFront",i.FREE_TRIAL="FreeTrial"}(l=e.PaymentMode||(e.PaymentMode={})),function(i){i.APPLE_APPSTORE="ios-appstore",i.GOOGLE_PLAY="android-playstore",i.WINDOWS_STORE="windows-store-transaction",i.BRAINTREE="braintree",i.TEST="test"}(d=e.Platform||(e.Platform={})),function(i){i.INITIATED="initiated",i.PENDING="pending",i.APPROVED="approved",i.CANCELLED="cancelled",i.FINISHED="finished",i.UNKNOWN_STATE=""}(s=e.TransactionState||(e.TransactionState={})),function(i){i.LAPSE="Lapse",i.RENEW="Renew"}(t=e.RenewalIntent||(e.RenewalIntent={})),function(i){i.NOTIFIED="Notified",i.AGREED="Agreed"}(o=e.PriceConsentStatus||(e.PriceConsentStatus={})),function(i){i.NOT_CANCELED="",i.DEVELOPER="Developer",i.SYSTEM="System",i.SYSTEM_REPLACED="System.Replaced",i.SYSTEM_PRODUCT_UNAVAILABLE="System.ProductUnavailable",i.SYSTEM_BILLING_ERROR="System.BillingError",i.SYSTEM_DELETED="System.Deleted",i.CUSTOMER="Customer",i.CUSTOMER_TECHNICAL_ISSUES="Customer.TechnicalIssues",i.CUSTOMER_PRICE_INCREASE="Customer.PriceIncrease",i.CUSTOMER_COST="Customer.Cost",i.CUSTOMER_FOUND_BETTER_APP="Customer.FoundBetterApp",i.CUSTOMER_NOT_USEFUL_ENOUGH="Customer.NotUsefulEnough",i.CUSTOMER_OTHER_REASON="Customer.OtherReason",i.UNKNOWN="Unknown"}(r=e.CancelationReason||(e.CancelationReason={}))}(f||(f={})),function(e){e.Offer=class T{constructor(l,d){this.className="Offer",this.id=l.id,this.pricingPhases=l.pricingPhases,Object.defineProperty(this,"productId",{enumerable:!0,get:()=>l.product.id}),Object.defineProperty(this,"productType",{enumerable:!0,get:()=>l.product.type}),Object.defineProperty(this,"productGroup",{enumerable:!0,get:()=>l.product.group}),Object.defineProperty(this,"platform",{enumerable:!0,get:()=>l.product.platform}),Object.defineProperty(this,"order",{enumerable:!1,get:()=>s=>d.order(this,s)}),Object.defineProperty(this,"canPurchase",{enumerable:!1,get:()=>d.canPurchase(this)})}get productId(){return""}get productType(){return e.ProductType.APPLICATION}get productGroup(){}get platform(){return e.Platform.TEST}order(l){return A(this,void 0,void 0,function*(){})}get canPurchase(){return!1}}}(f||(f={})),function(e){class T{constructor(){this.failedCallbacks=new e.Internal.PromiseLike,this.initiatedCallbacks=new e.Internal.PromiseLike,this.approvedCallbacks=new e.Internal.PromiseLike,this.finishedCallbacks=new e.Internal.PromiseLike,this.cancelledCallback=new e.Internal.PromiseLike}failed(l){return this.failedCallbacks.push(l),this}initiated(l){return this.initiatedCallbacks.push(l),this}approved(l){return this.approvedCallbacks.push(l),this}finished(l){return this.finishedCallbacks.push(l),this}cancelled(l){return this.cancelledCallback.push(l),this}trigger(l){if(l)if("isError"in l)this.failedCallbacks.resolve(l);else switch(l.state){case e.TransactionState.INITIATED:this.initiatedCallbacks.resolve(l);break;case e.TransactionState.APPROVED:this.approvedCallbacks.resolve(l);break;case e.TransactionState.FINISHED:this.finishedCallbacks.resolve(l)}else this.cancelledCallback.resolve();return this}static failed(l,d,s,t){return(new T).trigger(e.storeError(l,d,s,t))}static cancelled(){return(new T).trigger()}static initiated(l){return(new T).trigger(l)}}e.PaymentRequestPromise=T}(f||(f={})),function(e){e.Receipt=class T{constructor(l,d){this.className="Receipt",this.transactions=[],this.platform=l,Object.defineProperty(this,"verify",{enumerable:!1,get(){return()=>d.verify(this)}}),Object.defineProperty(this,"finish",{enumerable:!1,get(){return()=>d.finish(this)}})}verify(){return A(this,void 0,void 0,function*(){})}finish(){return A(this,void 0,void 0,function*(){})}hasTransaction(l){return!!this.transactions.find(d=>d===l)}lastTransaction(){return this.transactions[this.transactions.length-1]}}}(f||(f={})),function(e){e.Transaction=class T{constructor(l,d,s){this.className="Transaction",this.transactionId="",this.state=e.TransactionState.UNKNOWN_STATE,this.products=[],this.platform=l,Object.defineProperty(this,"finish",{enumerable:!1,get(){return()=>s.finish(this)}}),Object.defineProperty(this,"verify",{enumerable:!1,get(){return()=>s.verify(this)}}),Object.defineProperty(this,"parentReceipt",{enumerable:!1,get:()=>d})}finish(){return A(this,void 0,void 0,function*(){})}verify(){return A(this,void 0,void 0,function*(){})}get parentReceipt(){return{}}}}(f||(f={})),function(e){let T;!function(p){class l{static find(s,t){var o,r;if(!t)return;let i;for(const c of s)if(!t.platform||c.platform===t.platform)for(const n of c.transactions)for(const a of n.products)a.id===t.id&&(!i||(null!==(o=n.purchaseDate)&&void 0!==o?o:0)<(null!==(r=i.purchaseDate)&&void 0!==r?r:1))&&(i=n);return i}static isOwned(s,t){if(!t)return!1;const o=l.find(s,t);return!(!o||o.isConsumed||o.isPending)&&(!o.expirationDate||o.expirationDate.getTime()>+new Date)}static canPurchase(s,t){if(!t)return!1;const o=l.find(s,t);return!(o&&!o.isConsumed)||!o.expirationDate||o.expirationDate.getTime()<=+new Date}}p.LocalReceipts=l}(T=e.Internal||(e.Internal={}))}(f||(f={})),function(e){let T;var p;(p=T=e.Internal||(e.Internal={})).owned=function l(d){return void 0!==d.verifiedReceipts?p.VerifiedReceipts.isOwned(d.verifiedReceipts,d.product):void 0!==d.localReceipts&&p.LocalReceipts.isOwned(d.localReceipts,d.product)}}(f||(f={})),function(e){let T;(T=e.Internal||(e.Internal={})).PromiseLike=class l{constructor(){this.resolved=!1,this.callbacks=[]}push(s){this.resolved?setTimeout(s,0,this.resolvedArgument):this.callbacks.push(s)}resolve(s){this.resolved||(this.resolved=!0,this.resolvedArgument=s,this.callbacks.forEach(t=>setTimeout(t,0,s)),this.callbacks=[])}}}(f||(f={})),function(e){let T;(T=e.Internal||(e.Internal={})).Retry=class l{constructor(s=5e3,t=12e4){this.maxTimeout=12e4,this.minTimeout=5e3,this.retryTimeout=5e3,this.retries=[],this.minTimeout=s,this.maxTimeout=t,this.retryTimeout=s,document.addEventListener("online",()=>{const o=this.retries;this.retries=[],this.retryTimeout=this.minTimeout;for(var r=0;r<o.length;++r)clearTimeout(o[r].tid),o[r].fn.call(this)},!1)}retry(s){var t=setTimeout(()=>{this.retries=this.retries.filter(function(o){return t!==o.tid}),s()},this.retryTimeout);this.retries.push({tid:t,fn:s}),this.retryTimeout*=2,this.retryTimeout>this.maxTimeout&&(this.retryTimeout=this.maxTimeout)}}}(f||(f={})),function(e){let T;!function(p){class l{static find(s,t){var o,r;if(!t)return;let i;for(const c of s)if(!t.platform||c.platform===t.platform)for(const n of c.collection)n.id===t.id&&(null!==(o=null==i?void 0:i.purchaseDate)&&void 0!==o?o:0)<(null!==(r=n.purchaseDate)&&void 0!==r?r:1)&&(i=n);return i}static isOwned(s,t){if(!t)return!1;const o=l.find(s,t);return!(!o||null!=o&&o.isExpired)&&(null==o||!o.expiryDate||o.expiryDate>+new Date)}static getVerifiedPurchases(s){var t,o,r,i;const c={};for(const n of s)for(const a of n.collection){const u=n.platform+":"+a.id,h=c[u];(!h||h&&(null!==(o=null!==(t=h.lastRenewalDate)&&void 0!==t?t:h.purchaseDate)&&void 0!==o?o:0)<(null!==(i=null!==(r=a.lastRenewalDate)&&void 0!==r?r:a.purchaseDate)&&void 0!==i?i:0))&&(c[u]=Object.assign(Object.assign({},a),{platform:n.platform}))}return Object.keys(c).map(n=>c[n])}}p.VerifiedReceipts=l}(T=e.Internal||(e.Internal={}))}(f||(f={})),function(e){let T;!function(p){let l;var t;let d,s;(t=l=p.ContactField||(p.ContactField={})).Name="name",t.EmailAddress="emailAddress",t.PhoneNumber="phoneNumber",t.PostalAddress="postalAddress",t.PhoneticName="phoneticName",function(t){t.Amex="Amex",t.Barcode="Barcode",t.CartesBancaires="CartesBancaires",t.ChinaUnionPay="ChinaUnionPay",t.Dankort="Dankort",t.Discover="Discover",t.Eftpos="Eftpos",t.Electron="Electron",t.Elo="Elo",t.Girocard="Girocard",t.IDCredit="IDCredit",t.Interac="Interac",t.JCB="JCB",t.Mada="Mada",t.Maestro="Maestro",t.MasterCard="MasterCard",t.Mir="Mir",t.Nanaco="Nanaco",t.PrivateLabel="PrivateLabel",t.QuicPay="QuicPay",t.Suica="Suica",t.Visa="Visa",t.VPay="VPay",t.Waon="Waon"}(d=p.PaymentNetwork||(p.PaymentNetwork={})),function(t){t.ThreeDS="3DS",t.EMV="EMV",t.Credit="Credit",t.Debit="Debit"}(s=p.MerchantCapability||(p.MerchantCapability={}))}(T=e.ApplePay||(e.ApplePay={}))}(f||(f={})),function(e){let T;!function(p){function l(t){return`virtual.${t}`}function s(t,o,r){return e.storeError(t,o,e.Platform.APPLE_APPSTORE,r)}p.Adapter=class d{constructor(o,r){var i,c;this.id=e.Platform.APPLE_APPSTORE,this.name="AppStore",this.ready=!1,this._canMakePayments=!1,this.forceReceiptReload=!1,this._products=[],this.validProducts={},this._paymentMonitor=()=>{},this.supportsParallelLoading=!0,this._appStoreReceiptLoading=!1,this._appStoreReceiptCallbacks=[],this.context=o,this.bridge=new p.Bridge.Bridge,this.log=o.log.child("AppleAppStore"),this.discountEligibilityDeterminer=r.discountEligibilityDeterminer,this.needAppReceipt=null===(i=r.needAppReceipt)||void 0===i||i,this.autoFinish=null!==(c=r.autoFinish)&&void 0!==c&&c,this.pseudoReceipt=new e.Receipt(e.Platform.APPLE_APPSTORE,this.context.apiDecorators),this.receiptsUpdated=e.Utils.debounce(()=>{this._receiptsUpdated()},300)}get products(){return this._products}getProduct(o){return this._products.find(r=>r.id===o)}get receipts(){return this.isSupported?(this._receipt?[this._receipt]:[]).concat(this.pseudoReceipt?this.pseudoReceipt:[]):[]}addValidProducts(o,r){r.forEach(i=>{const c=o.find(n=>n.id===i.id);c&&(this.validProducts[i.id]=Object.assign(Object.assign({},i),c))})}get isSupported(){return"ios"===window.cordova.platformId}upsertTransactionInProgress(o,r){const i=l(o);return new Promise(c=>{const n=this.pseudoReceipt.transactions.find(a=>a.transactionId===i);if(n)n.state=r,n.refresh(o),c(n);else{const a=new p.SKTransaction(e.Platform.APPLE_APPSTORE,this.pseudoReceipt,this.context.apiDecorators);a.state=r,a.transactionId=i,a.refresh(o),this.pseudoReceipt.transactions.push(a),c(a)}})}removeTransactionInProgress(o){const r=l(o);this.pseudoReceipt.transactions=this.pseudoReceipt.transactions.filter(i=>i.transactionId!==r)}upsertTransaction(o,r,i){return A(this,void 0,void 0,function*(){return new Promise(c=>{this.initializeAppReceipt(()=>{var n;if(!this._receipt)return void this.log.warn("Failed to load the application receipt, cannot proceed with handling the purchase");const a=null===(n=this._receipt)||void 0===n?void 0:n.transactions.find(u=>u.transactionId===r);if(a)a.state=i,a.refresh(o),c(a);else{const u=new p.SKTransaction(e.Platform.APPLE_APPSTORE,this._receipt,this.context.apiDecorators);u.state=i,u.transactionId=r,u.refresh(o),this._receipt.transactions.push(u),c(u)}})})})}removeTransaction(o){this._receipt&&(this._receipt.transactions=this._receipt.transactions.filter(r=>r.transactionId!==o))}_receiptsUpdated(){this._receipt?(this.log.debug("receipt updated and ready."),this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[this._receipt,this.pseudoReceipt]),this.context.listener.receiptsReady(e.Platform.APPLE_APPSTORE)):(this.log.debug("receipt updated."),this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[this.pseudoReceipt]))}setPaymentMonitor(o){this._paymentMonitor=o}callPaymentMonitor(o,r,i){this._paymentMonitor(o)}initialize(){return new Promise(o=>{this.log.info("bridge.init");const r=this.log.child("Bridge");this.bridge.init({autoFinish:this.autoFinish,debug:this.context.verbosity===e.LogLevel.DEBUG,log:i=>r.debug(i),error:(i,c,n)=>{this.log.error("ERROR: "+i+" - "+c),i!==e.ErrorCode.PAYMENT_CANCELLED?this.context.error(s(i,c,(null==n?void 0:n.productId)||null)):this.callPaymentMonitor("cancelled",e.ErrorCode.PAYMENT_CANCELLED,c)},ready:()=>{this.log.info("ready")},purchased:(i,c,n,a,u)=>A(this,void 0,void 0,function*(){this.log.info("purchase: id:"+i+" product:"+c+" originalTransaction:"+n+" - date:"+a+" - discount:"+u),(yield this.upsertTransaction(c,i,e.TransactionState.APPROVED)).refresh(c,n,a,u),this.removeTransactionInProgress(c),this.receiptsUpdated(),this.callPaymentMonitor("purchased")}),purchaseEnqueued:(i,c)=>A(this,void 0,void 0,function*(){this.log.info("purchaseEnqueued: "+i+" - "+c),yield this.upsertTransactionInProgress(i,e.TransactionState.INITIATED),this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[this.pseudoReceipt])}),purchaseFailed:(i,c,n)=>{this.log.info("purchaseFailed: "+i+" - "+c+" - "+n),this.removeTransactionInProgress(i),this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[this.pseudoReceipt]),this.callPaymentMonitor("failed",c,n)},purchasing:i=>A(this,void 0,void 0,function*(){this.log.info("purchasing: "+i),yield this.upsertTransactionInProgress(i,e.TransactionState.INITIATED),this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[this.pseudoReceipt])}),deferred:i=>A(this,void 0,void 0,function*(){this.log.info("deferred: "+i),yield this.upsertTransactionInProgress(i,e.TransactionState.PENDING),this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[this.pseudoReceipt]),this.callPaymentMonitor("deferred")}),finished:(i,c)=>A(this,void 0,void 0,function*(){this.log.info("finish: "+i+" - "+c),this.removeTransactionInProgress(c),yield this.upsertTransaction(c,i,e.TransactionState.FINISHED),this.receiptsUpdated()}),restored:(i,c)=>A(this,void 0,void 0,function*(){this.log.info("restore: "+i+" - "+c),yield this.upsertTransaction(c,i,e.TransactionState.APPROVED),this.receiptsUpdated()}),receiptsRefreshed:i=>{this.log.info("receiptsRefreshed"),this._receipt&&this._receipt.refresh(i,this.needAppReceipt,this.context.apiDecorators)},restoreFailed:i=>{this.log.info("restoreFailed: "+i),this.onRestoreCompleted&&(this.onRestoreCompleted(s(i,"Restore purchases failed",null)),this.onRestoreCompleted=void 0)},restoreCompleted:()=>{this.log.info("restoreCompleted"),this.onRestoreCompleted&&(this.onRestoreCompleted(void 0),this.onRestoreCompleted=void 0)}},()=>A(this,void 0,void 0,function*(){this.log.info("bridge.init done"),yield this.canMakePayments(),o(void 0)}),(i,c)=>{this.log.info("bridge.init failed: "+i+" - "+c),o(s(i,c,null))})})}loadReceipts(){return new Promise(o=>{setTimeout(()=>{this.initializeAppReceipt(()=>{this.receiptsUpdated(),o(this._receipt?[this._receipt,this.pseudoReceipt]:[this.pseudoReceipt])})},300)})}canMakePayments(){return A(this,void 0,void 0,function*(){return new Promise(o=>{this.bridge.canMakePayments(()=>{this._canMakePayments=!0,o(!0)},r=>{this.log.warn(`canMakePayments: ${r}`),this._canMakePayments=!1,o(!1)})})})}initializeAppReceipt(o){return A(this,void 0,void 0,function*(){if(this._receipt)return this.log.debug("initializeAppReceipt() => already initialized."),o(void 0);if(this._appStoreReceiptCallbacks.push(o),this._appStoreReceiptLoading)return void this.log.debug("initializeAppReceipt() => already loading.");this._appStoreReceiptLoading=!0;const r=yield this.loadAppStoreReceipt(),i=c=>{const n=this._appStoreReceiptCallbacks;this._appStoreReceiptCallbacks=[],n.forEach(a=>{a(c)})};if(null==r||!r.appStoreReceipt)return this.log.warn("no appStoreReceipt"),this._appStoreReceiptLoading=!1,void i(s(e.ErrorCode.REFRESH,"No appStoreReceipt",null));this._receipt=new p.SKApplicationReceipt(r,this.needAppReceipt,this.context.apiDecorators),i(void 0)})}prepareReceipt(o){null!=o&&o.appStoreReceipt&&(this._receipt?this._receipt.refresh(o,this.needAppReceipt,this.context.apiDecorators):this._receipt=new p.SKApplicationReceipt(o,this.needAppReceipt,this.context.apiDecorators))}loadAppStoreReceipt(){return A(this,void 0,void 0,function*(){let o=!1;return new Promise(r=>{var i;if(null!==(i=this.bridge.appStoreReceipt)&&void 0!==i&&i.appStoreReceipt&&!this.forceReceiptReload)return this.log.debug("using cached appstore receipt"),r(this.bridge.appStoreReceipt);this.log.debug("loading appstore receipt..."),this.forceReceiptReload=!1,this.bridge.loadReceipts(c=>{this.log.debug("appstore receipt loaded"),o||r(c),o=!0},(c,n)=>{this.log.warn("Failed to load appStoreReceipt: "+c+" - "+n),o||r(void 0),o=!0}),setTimeout(function(){o||r(void 0),o=!0},5e3)}).then(r=>(this.context.listener.receiptsReady(e.Platform.APPLE_APPSTORE),r)).catch(r=>(this.context.listener.receiptsReady(e.Platform.APPLE_APPSTORE),r))})}loadEligibility(o){return A(this,void 0,void 0,function*(){if(this.log.debug("load eligibility: "+JSON.stringify(o)),!this.discountEligibilityDeterminer)return this.log.debug("No discount eligibility determiner, skipping..."),new p.Internal.DiscountEligibilities([],[]);const r=[];if(o.forEach(i=>{var c,n,a;null===(c=i.discounts)||void 0===c||c.forEach(u=>{r.push({productId:i.id,discountId:u.id,discountType:u.type})}),0===(null!==(a=null===(n=i.discounts)||void 0===n?void 0:n.length)&&void 0!==a?a:0)&&i.introPrice&&r.push({productId:i.id,discountId:"intro",discountType:"Introductory"})}),r.length>0){const i=yield this.loadAppStoreReceipt();if(!i||!i.appStoreReceipt)return this.log.debug("no receipt, assuming introductory price are available."),new p.Internal.DiscountEligibilities(r,r.map(c=>"Introductory"===c.discountType));{this.log.debug("calling discount eligibility determiner.");const c=yield this.callDiscountEligibilityDeterminer(i,r);return this.log.debug("response: "+JSON.stringify(c)),new p.Internal.DiscountEligibilities(r,c)}}return new p.Internal.DiscountEligibilities([],[])})}callDiscountEligibilityDeterminer(o,r){return new Promise(i=>{if(!this.discountEligibilityDeterminer)return i([]);this.discountEligibilityDeterminer(o,r,i)})}loadProducts(o){return new Promise(r=>{this.log.info("bridge.load"),this.bridge.load(o.map(i=>i.id),(i,c)=>A(this,void 0,void 0,function*(){this.log.info("bridge.loaded: "+JSON.stringify({validProducts:i,invalidProducts:c})),this.addValidProducts(o,i);const n=yield this.loadEligibility(i);this.log.info("eligibilities ready: "+JSON.stringify(n));const a=o.map(u=>{if(c.indexOf(u.id)>=0)return this.log.debug(`${u.id} is invalid`),s(e.ErrorCode.INVALID_PRODUCT_ID,"Product not found in AppStore. #400",u.id);{const h=i.find(_=>_.id===u.id);if(this.log.debug(`${u.id} is valid: ${JSON.stringify(h)}`),!h)return s(e.ErrorCode.INVALID_PRODUCT_ID,"Product not found in AppStore. #404",u.id);let R=this.getProduct(u.id);return R?(this.log.debug("refreshing existing product"),null==R||R.refresh(h,this.context.apiDecorators,n)):(this.log.debug("registering new product"),R=new p.SKProduct(h,u,this.context.apiDecorators,n),this._products.push(R)),R}});this.log.debug(`Products loaded: ${JSON.stringify(a)}`),r(a)}),(i,c)=>o.map(n=>s(i,c,null)))})}order(o,r){return A(this,void 0,void 0,function*(){let i=!1;return new Promise(c=>{var n;const a=g=>{i||(this.setPaymentMonitor(()=>{}),i=!0,c(g))};this.log.info("order");const u=o.id!==p.DEFAULT_OFFER_ID?o.id:void 0,h=null===(n=null==r?void 0:r.appStore)||void 0===n?void 0:n.discount;return u&&!h?a(s(e.ErrorCode.MISSING_OFFER_PARAMS,"Missing additionalData.appStore.discount when ordering a discount offer",o.productId)):u&&(null==h?void 0:h.id)!==u?a(s(e.ErrorCode.INVALID_OFFER_IDENTIFIER,"Offer identifier does not match additionalData.appStore.discount.id",o.productId)):(this.setPaymentMonitor((g,S,y)=>{if(this.log.info("order.paymentMonitor => "+g+" "+(null!=S?S:"")+" "+(null!=y?y:"")),!i)switch(g){case"cancelled":a(s(null!=S?S:e.ErrorCode.PAYMENT_CANCELLED,null!=y?y:"The user cancelled the order.",o.productId));break;case"failed":setTimeout(()=>{a(s(null!=S?S:e.ErrorCode.PURCHASE,null!=y?y:"Purchase failed",o.productId))},500);break;case"purchased":case"deferred":a(void 0)}}),this.forceReceiptReload=!0,void this.bridge.purchase(o.productId,1,this.context.getApplicationUsername(),h,()=>{this.log.info("order.success")},()=>{this.log.info("order.error"),a(s(e.ErrorCode.PURCHASE,"Failed to place order",o.productId))}))})})}finish(o){return new Promise(r=>{if(this.log.info("finish("+o.transactionId+")"),o.transactionId===p.APPLICATION_VIRTUAL_TRANSACTION_ID||o.transactionId===l(o.products[0].id))return o.state=e.TransactionState.FINISHED,this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[o.parentReceipt]),r(void 0);const i=()=>{o.state=e.TransactionState.FINISHED,this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[o.parentReceipt]),r(void 0)};this.bridge.finish(o.transactionId,i,n=>{var a,u;null!=n&&n.includes("[#CdvPurchase:100]")?i():r(s(e.ErrorCode.FINISH,"Failed to finish transaction",null!==(u=null===(a=o.products[0])||void 0===a?void 0:a.id)&&void 0!==u?u:null))})})}refreshReceipt(){return new Promise(o=>{this.bridge.refreshReceipts(c=>{o(c)},(c,n)=>{o(s(c,n,null))})})}receiptValidationBody(o){return A(this,void 0,void 0,function*(){if(o.platform!==e.Platform.APPLE_APPSTORE||o!==this._receipt)return;const r=o;let i=r.nativeData;if(this.forceReceiptReload){const n=yield this.loadAppStoreReceipt();this.forceReceiptReload=!1,n&&(i=n,this.prepareReceipt(n))}if(!r.nativeData.appStoreReceipt){this.log.info("Cannot prepare the receipt validation body, because appStoreReceipt is missing. Refreshing...");const n=yield this.refreshReceipt();if(!n||"isError"in n)return this.log.warn("Failed to refresh receipt, cannot run receipt validation."),void(n&&this.log.error(n));this.log.info("Receipt refreshed."),i=n}const c=r.transactions.slice(-1)[0];return{id:i.bundleIdentifier,type:e.ProductType.APPLICATION,products:e.Utils.objectValues(this.validProducts).map(n=>new p.SKProduct(n,n,this.context.apiDecorators,{isEligible:()=>!0})),transaction:{type:"ios-appstore",id:null==c?void 0:c.transactionId,appStoreReceipt:i.appStoreReceipt}}})}handleReceiptValidationResponse(o,r){var i,c;return A(this,void 0,void 0,function*(){let n=!1;if(r.ok){const a=null===(i=r.data)||void 0===i?void 0:i.transaction;"ios-appstore"===(null==a?void 0:a.type)&&"original_application_version"in a&&(null===(c=this._receipt)||void 0===c||c.transactions.forEach(u=>{u.transactionId===p.APPLICATION_VIRTUAL_TRANSACTION_ID&&a.original_purchase_date_ms&&(u.purchaseDate=new Date(parseInt(a.original_purchase_date_ms)),n=!0)}))}n&&this.context.listener.receiptsUpdated(e.Platform.APPLE_APPSTORE,[o])})}requestPayment(o,r){return A(this,void 0,void 0,function*(){return s(e.ErrorCode.UNKNOWN,"requestPayment not supported",null)})}manageSubscriptions(){return A(this,void 0,void 0,function*(){this.bridge.manageSubscriptions()})}manageBilling(){return A(this,void 0,void 0,function*(){this.bridge.manageBilling()})}checkSupport(o){return"order"===o?this._canMakePayments:["order","manageBilling","manageSubscriptions"].indexOf(o)>=0}restorePurchases(){return new Promise(o=>{this.onRestoreCompleted=r=>{this.onRestoreCompleted=void 0,this.bridge.refreshReceipts(i=>{o(r)},(i,c)=>{o(r||s(i,c,null))})},this.forceReceiptReload=!0,this.bridge.restore()})}presentCodeRedemptionSheet(){return new Promise(o=>{this.bridge.presentCodeRedemptionSheet(o)})}}}(T=e.AppleAppStore||(e.AppleAppStore={}))}(f||(f={})),function(e){let T;!function(p){let l;!function(d){const s=c=>{};let t=s;function o(c,n,a,u){window.cordova.exec(a,u,"InAppPurchase",c,n)}function r(c,n,...a){if(c)try{c.apply(this,a)}catch(u){t("exception in "+n+': "'+u+'"')}}d.Bridge=class i{constructor(){this.transactionsForProduct={},this.initialized=!1,this.registeredProducts=[],this.needRestoreNotification=!1,this.pendingUpdates=[],this.onPurchased=!1,this.onFailed=!1,this.onRestored=!1,window.storekit=this,this.options={error:s,ready:s,purchased:s,purchaseEnqueued:s,purchasing:s,purchaseFailed:s,deferred:s,finished:s,restored:s,receiptsRefreshed:s,restoreFailed:s,restoreCompleted:s}}init(n,a,u){this.options={error:n.error||s,ready:n.ready||s,purchased:n.purchased||s,purchaseEnqueued:n.purchaseEnqueued||s,purchasing:n.purchasing||s,purchaseFailed:n.purchaseFailed||s,deferred:n.deferred||s,finished:n.finished||s,restored:n.restored||s,receiptsRefreshed:n.receiptsRefreshed||s,restoreFailed:n.restoreFailed||s,restoreCompleted:n.restoreCompleted||s},n.debug&&(o("debug",[],s,s),t=n.log||function(_){console.log("[CdvPurchase.AppAppStore.Bridge] "+_)}),n.autoFinish&&o("autoFinish",[],s,s),o("setup",[],()=>{t("setup ok"),r(this.options.ready,"options.ready"),r(a,"init.success"),this.initialized=!0,setTimeout(()=>this.processPendingTransactions(),50)},_=>{t("setup failed"),r(u,"init.error",e.ErrorCode.SETUP,"Setup failed: "+_)})}processPendingTransactions(){t("processing pending transactions"),o("processPendingTransactions",[],()=>{this.finalizeTransactionUpdates()},void 0)}purchase(n,a,u,h,R,_){a=0|a||1;const g=this.options;if(this.registeredProducts.indexOf(n)<0)return t("Purchasing "+n+" failed.  Ensure the product was loaded first with Bridge.load(...)!"),void("function"==typeof g.error&&r(g.error,"options.error",e.ErrorCode.PURCHASE,"Trying to purchase a unknown product.",{productId:n,quantity:a}));o("purchase",[n,a,u,h||{}],()=>{t("Purchase enqueued "+n),"function"==typeof g.purchaseEnqueued&&r(g.purchaseEnqueued,"options.purchaseEnqueued",n,a),r(R,"purchase.success")},()=>{const I="Purchase failed: "+n;t(I),"function"==typeof g.error&&r(g.error,"options.error",e.ErrorCode.PURCHASE,I,{productId:n,quantity:a}),r(_,"purchase.error")})}canMakePayments(n,a){return o("canMakePayments",[],n,a)}restore(n){this.needRestoreNotification=!0,o("restoreCompletedTransactions",[],n,n)}manageSubscriptions(n){o("manageSubscriptions",[],n,n)}manageBilling(n){o("manageBilling",[],n,n)}presentCodeRedemptionSheet(n){o("presentCodeRedemptionSheet",[],n,n)}load(n,a,u){const h=this.options;if("string"==typeof n&&(n=[n]),n)if(n.length){if("string"!=typeof n[0]){const g="invalid productIds given to store.load: "+JSON.stringify(n);return t(g),r(h.error,"options.error",e.ErrorCode.LOAD,g),void r(u,"load.error",e.ErrorCode.LOAD,g)}t("load "+JSON.stringify(n));const R=g=>{const S=g[0],y=g[1];t("load ok: { valid:"+JSON.stringify(S)+" invalid:"+JSON.stringify(y)+" }"),r(a,"load.success",S,y)},_=g=>{t("load failed"),t(g);const S="Load failed: "+g;r(h.error,"options.error",e.ErrorCode.LOAD,S),r(u,"load.error",e.ErrorCode.LOAD,S)};this.registeredProducts=this.registeredProducts.concat(n),o("load",[n],R,_)}else r(a,"load.success",[],[]);else r(a,"load.success",[],[])}finish(n,a,u){o("finishTransaction",[n],a,u)}finalizeTransactionUpdates(){for(let n=0;n<this.pendingUpdates.length;++n){const a=this.pendingUpdates[n];this.transactionUpdated(a.state,a.errorCode,a.errorText,a.transactionIdentifier,a.productId,a.transactionReceipt,a.originalTransactionIdentifier,a.transactionDate,a.discountId)}this.pendingUpdates=[]}lastTransactionUpdated(){}transactionUpdated(n,a,u,h,R,_,g,S,y){if(this.initialized)switch(t("transaction updated:"+h+" state:"+n+" product:"+R),R&&h&&(this.transactionsForProduct[R]?this.transactionsForProduct[R].push(h):this.transactionsForProduct[R]=[h]),n){case"PaymentTransactionStatePurchasing":return void r(this.options.purchasing,"options.purchasing",R);case"PaymentTransactionStatePurchased":return void r(this.options.purchased,"options.purchase",h,R,g,S,y);case"PaymentTransactionStateDeferred":return void r(this.options.deferred,"options.deferred",R);case"PaymentTransactionStateFailed":return r(this.options.purchaseFailed,"options.purchaseFailed",R,a||e.ErrorCode.UNKNOWN,u||"ERROR"),void r(this.options.error,"options.error",a||e.ErrorCode.UNKNOWN,u||"ERROR",{productId:R});case"PaymentTransactionStateRestored":return void r(this.options.restored,"options.restore",h,R);case"PaymentTransactionStateFinished":return void r(this.options.finished,"options.finish",h,R)}else this.pendingUpdates.push({state:n,errorCode:a,errorText:u,transactionIdentifier:h,productId:R,transactionReceipt:_,originalTransactionIdentifier:g,transactionDate:S,discountId:y})}restoreCompletedTransactionsFinished(){this.needRestoreNotification&&(this.needRestoreNotification=!1,r(this.options.restoreCompleted,"options.restoreCompleted"))}restoreCompletedTransactionsFailed(n){this.needRestoreNotification&&(this.needRestoreNotification=!1,r(this.options.restoreFailed,"options.restoreFailed",n))}parseReceiptArgs(n){const a=n[0],u=n[1],h=n[2],R=n[3],_=n[4];return t("infoPlist: "+u+","+h+","+R+","+_),{appStoreReceipt:a,bundleIdentifier:u,bundleShortVersion:h,bundleNumericVersion:R,bundleSignature:_}}refreshReceipts(n,a){this.appStoreReceipt=null,t("refreshing appStoreReceipt"),o("appStoreRefreshReceipt",[],R=>{const _=this.parseReceiptArgs(R);this.appStoreReceipt=_,r(this.options.receiptsRefreshed,"options.receiptsRefreshed",_),r(n,"refreshReceipts.success",_)},R=>{t("refresh receipt failed: "+R),R.includes("(@AMSErrorDomain:100)")&&t('authentication failed, indicated by the string "(@AMSErrorDomain:100)"'),r(this.options.error,"options.error",e.ErrorCode.REFRESH_RECEIPTS,"Failed to refresh receipt: "+R),r(a,"refreshReceipts.error",e.ErrorCode.REFRESH_RECEIPTS,"Failed to refresh receipt: "+R)})}loadReceipts(n,a){t("loading appStoreReceipt"),o("appStoreReceipt",[],R=>{const _=this.parseReceiptArgs(R);this.appStoreReceipt=_,r(n,"loadReceipts.callback",_)},R=>{})}}}(l=p.Bridge||(p.Bridge={}))}(T=e.AppleAppStore||(e.AppleAppStore={}))}(f||(f={})),function(e){let T;!function(p){let l;(l=p.Internal||(p.Internal={})).DiscountEligibilities=class s{constructor(o,r){this.request=o,this.response=r}isEligible(o,r,i){var c;for(let n=0;n<this.request.length;++n){const a=this.request[n];if(a.productId===o&&a.discountId===i&&a.discountType===r)return null!==(c=this.response[n])&&void 0!==c&&c}return!0}}}(T=e.AppleAppStore||(e.AppleAppStore={}))}(f||(f={})),function(e){let T;!function(p){p.DEFAULT_OFFER_ID="$";class l extends e.Offer{constructor(t,o){super(t,o),this.offerType=t.offerType}}p.SKOffer=l,p.SKProduct=class d extends e.Product{constructor(t,o,r,i){super(o,r),this.raw=t,this.refresh(t,r,i)}removeIneligibleDiscounts(t){this.offers=this.offers.filter(o=>"Default"===o.offerType||t.isEligible(this.id,o.offerType,o.id))}refresh(t,o,r){var i;this.raw=t,this.title=t.title,this.description=t.description,this.countryCode=t.countryCode,t.group&&(this.group=t.group),this.removeIneligibleDiscounts(r);const c={price:t.price,priceMicros:t.priceMicros,currency:t.currency,billingPeriod:a(t.billingPeriod,t.billingPeriodUnit),paymentMode:this.type===e.ProductType.PAID_SUBSCRIPTION?e.PaymentMode.PAY_AS_YOU_GO:e.PaymentMode.UP_FRONT,recurrenceMode:this.type===e.ProductType.PAID_SUBSCRIPTION?e.RecurrenceMode.INFINITE_RECURRING:e.RecurrenceMode.NON_RECURRING};if(null===(i=t.discounts)||void 0===i||i.forEach(u=>{if(r.isEligible(t.id,u.type,u.id)){const h=[],R=u.paymentMode===e.PaymentMode.PAY_AS_YOU_GO?u.period:1,g={price:u.price,priceMicros:u.priceMicros,currency:t.currency,billingPeriod:a(u.paymentMode===e.PaymentMode.PAY_AS_YOU_GO?1:u.period,u.periodUnit),billingCycles:R,paymentMode:u.paymentMode,recurrenceMode:e.RecurrenceMode.FINITE_RECURRING};h.push(g),h.push(c),this.addOffer(new l({id:u.id,product:this,pricingPhases:h,offerType:u.type},o))}}),!function n(u){return u.offers.filter(h=>"Introductory"===h.offerType||"Default"===h.offerType&&h.pricingPhases.length>1).length>0}(this)){const u=[];if(t.introPrice&&void 0!==t.introPriceMicros&&r.isEligible(t.id,"Introductory","intro")){const h={price:t.introPrice,priceMicros:t.introPriceMicros,currency:t.currency,billingPeriod:a(t.introPricePeriod,t.introPricePeriodUnit),paymentMode:t.introPricePaymentMode,recurrenceMode:e.RecurrenceMode.FINITE_RECURRING,billingCycles:1};u.push(h)}u.push(c),this.addOffer(new l({id:p.DEFAULT_OFFER_ID,product:this,pricingPhases:u,offerType:"Default"},o))}function a(u,h){if(u&&h)return`P${u}${h[0]}`}}}}(T=e.AppleAppStore||(e.AppleAppStore={}))}(f||(f={})),function(e){let T;var p;(p=T=e.AppleAppStore||(e.AppleAppStore={})).APPLICATION_VIRTUAL_TRANSACTION_ID="appstore.application",p.SKApplicationReceipt=class l extends e.Receipt{constructor(t,o,r){super(e.Platform.APPLE_APPSTORE,r),this.nativeData=t,this.refresh(this.nativeData,o,r)}refresh(t,o,r){if(this.nativeData=t,o){if(this.transactions.find(n=>n.transactionId===p.APPLICATION_VIRTUAL_TRANSACTION_ID))return;const c=new e.Transaction(e.Platform.APPLE_APPSTORE,this,r);c.transactionId=p.APPLICATION_VIRTUAL_TRANSACTION_ID,c.state=e.TransactionState.APPROVED,c.products.push({id:t.bundleIdentifier}),this.transactions.push(c)}}},p.SKTransaction=class d extends e.Transaction{refresh(t,o,r,i){t&&(this.products=[{id:t,offerId:i}]),o&&(this.originalTransactionId=o),r&&(this.purchaseDate=new Date(+r))}}}(f||(f={})),function(e){let T;!function(p){let l;!function(d){let s;var t;(t=s=d.AppleExpirationIntent||(d.AppleExpirationIntent={})).CANCELED="1",t.BILLING_ERROR="2",t.PRICE_INCREASE="3",t.PRODUCT_NOT_AVAILABLE="4",t.UNKNOWN="5"}(l=p.VerifyReceipt||(p.VerifyReceipt={}))}(T=e.AppleAppStore||(e.AppleAppStore={}))}(f||(f={})),function(e){let T;!function(p){class l extends e.Receipt{constructor(n,a,u){var h,R,_;super(e.Platform.BRAINTREE,u);const g=new e.Transaction(e.Platform.BRAINTREE,this,u);g.purchaseDate=new Date,g.products=(null===(h=n.items)||void 0===h?void 0:h.filter(S=>S).map(S=>({id:(null==S?void 0:S.id)||""})))||[],g.state=e.TransactionState.APPROVED,g.transactionId=null!==(_=null===(R=a.paymentMethodNonce)||void 0===R?void 0:R.nonce)&&void 0!==_?_:`UNKNOWN_${a.paymentMethodType}_${a.paymentDescription}`,this.transactions=[g],this.dropInResult=a,this.paymentRequest=n,this.refresh(n,a,u)}refresh(n,a,u){var h,R;this.dropInResult=a,this.paymentRequest=n;const _=new e.Transaction(e.Platform.BRAINTREE,this,u);_.products=n.items.filter(g=>g).map(g=>({id:(null==g?void 0:g.id)||""})),_.state=e.TransactionState.APPROVED,_.transactionId=null!==(R=null===(h=a.paymentMethodNonce)||void 0===h?void 0:h.nonce)&&void 0!==R?R:`UNKNOWN_${a.paymentMethodType}_${a.paymentDescription}`,_.amountMicros=n.amountMicros,_.currency=n.currency,this.transactions=[_]}}p.BraintreeReceipt=l,p.Adapter=class d{constructor(n,a){this.id=e.Platform.BRAINTREE,this.name="BrainTree",this.ready=!1,this.products=[],this._receipts=[],this.supportsParallelLoading=!1,this.context=n,this.log=n.log.child("Braintree"),this.options=a}get receipts(){return this._receipts}get isSupported(){return p.IosBridge.Bridge.isSupported()||p.AndroidBridge.Bridge.isSupported()}initialize(){return new Promise(n=>{this.log.info("initialize()"),p.IosBridge.Bridge.isSupported()?(this.log.info("instantiating ios bridge..."),this.iosBridge=new p.IosBridge.Bridge(this.log,a=>{this.options.tokenizationKey?a(this.options.tokenizationKey):this.options.clientTokenProvider?this.options.clientTokenProvider(a):a(i(e.ErrorCode.CLIENT_INVALID,"Braintree iOS Bridge requires a clientTokenProvider or tokenizationKey"))},this.options.applePay),this.iosBridge.initialize(this.context,n)):p.AndroidBridge.Bridge.isSupported()&&!this.androidBridge?(this.log.info("instantiating android bridge..."),this.androidBridge=new p.AndroidBridge.Bridge(this.log),this.log.info("calling android bridge -> initialize..."),this.androidBridge.initialize(this.options.tokenizationKey?this.options.tokenizationKey:this.options.clientTokenProvider?this.options.clientTokenProvider:"",n)):(this.log.info("platform not supported..."),n(void 0)),this.context.listener.receiptsReady(e.Platform.BRAINTREE)})}loadProducts(n){return A(this,void 0,void 0,function*(){return n.map(a=>i(e.ErrorCode.PRODUCT_NOT_AVAILABLE,"N/A"))})}loadReceipts(){return A(this,void 0,void 0,function*(){return this.context.listener.receiptsReady(e.Platform.BRAINTREE),[]})}order(n){return A(this,void 0,void 0,function*(){return i(e.ErrorCode.UNKNOWN,"N/A: Not implemented with Braintree")})}finish(n){return A(this,void 0,void 0,function*(){n.state=e.TransactionState.FINISHED,this.context.listener.receiptsUpdated(e.Platform.TEST,[n.parentReceipt])})}manageSubscriptions(){return A(this,void 0,void 0,function*(){this.log.info("N/A: manageSubscriptions() is not available with Braintree")})}manageBilling(){return A(this,void 0,void 0,function*(){this.log.info("N/A: manageBilling() is not available with Braintree")})}launchDropIn(n,a){return A(this,void 0,void 0,function*(){return this.androidBridge?this.androidBridge.launchDropIn(a):this.iosBridge?this.iosBridge.launchDropIn(n,a):i(e.ErrorCode.PURCHASE,"Braintree is not available")})}requestPayment(n,a){var u,h,R,_,g,S,y,I,E;return A(this,void 0,void 0,function*(){this.log.info("requestPayment()"+JSON.stringify(n));const m=(null===(u=null==a?void 0:a.braintree)||void 0===u?void 0:u.dropInRequest)||{};if((yield p.IosBridge.ApplePayPlugin.isSupported(this.log))||(this.log.info("Apple Pay is not supported."),m.applePayDisabled=!0),this.options.googlePay||m.googlePayRequest){const N=Object.assign(Object.assign({},null!==(h=this.options.googlePay)&&void 0!==h?h:{}),null!==(R=m.googlePayRequest)&&void 0!==R?R:{});N.transactionInfo||(N.transactionInfo={currencyCode:null!==(_=n.currency)&&void 0!==_?_:"",totalPrice:(null!==(g=n.amountMicros)&&void 0!==g?g:0)/1e6,totalPriceStatus:p.GooglePay.TotalPriceStatus.FINAL}),m.googlePayRequest=N}if(this.options.threeDSecure||m.threeDSecureRequest){const N=Object.assign(Object.assign({},null!==(S=this.options.threeDSecure)&&void 0!==S?S:{}),null!==(y=m.threeDSecureRequest)&&void 0!==y?y:{});N.amount||(N.amount=function s(c){const n=""+c/1e4;return(n.slice(0,-2)||"0")+"."+(n.slice(-2,-1)||"0")+(n.slice(-1)||"0")}(null!==(I=n.amountMicros)&&void 0!==I?I:0)),!N.billingAddress&&n.billingAddress&&(N.billingAddress={givenName:n.billingAddress.givenName,surname:n.billingAddress.surname,countryCodeAlpha2:n.billingAddress.countryCode,postalCode:n.billingAddress.postalCode,locality:n.billingAddress.locality,streetAddress:n.billingAddress.streetAddress1,extendedAddress:n.billingAddress.streetAddress2,line3:n.billingAddress.streetAddress3,phoneNumber:n.billingAddress.phoneNumber,region:n.billingAddress.region}),N.email||(N.email=n.email),m.threeDSecureRequest=N}const P=yield this.launchDropIn(n,m);if(!o(P))return r(this.log,P);const O=P;if(this.log.info("launchDropIn success: "+JSON.stringify({paymentRequest:n,dropInResult:O})),null===(E=O.paymentMethodNonce)||void 0===E||!E.nonce)return i(e.ErrorCode.BAD_RESPONSE,"launchDropIn returned no paymentMethodNonce");let b=this._receipts.find(N=>{var v,D;return(null===(v=N.dropInResult.paymentMethodNonce)||void 0===v?void 0:v.nonce)===(null===(D=O.paymentMethodNonce)||void 0===D?void 0:D.nonce)});return b?b.refresh(n,O,this.context.apiDecorators):(b=new l(n,O,this.context.apiDecorators),this.receipts.push(b)),this.context.listener.receiptsUpdated(e.Platform.BRAINTREE,[b]),b.transactions[0]})}receiptValidationBody(n){var a,u,h,R,_;return A(this,void 0,void 0,function*(){if(function t(c){return c.platform===e.Platform.BRAINTREE}(n))return this.log.info("create receiptValidationBody for: "+JSON.stringify(n)),{id:null!==(h=null===(u=null===(a=n.paymentRequest.items)||void 0===a?void 0:a[0])||void 0===u?void 0:u.id)&&void 0!==h?h:"unknown",type:e.ProductType.CONSUMABLE,priceMicros:n.paymentRequest.amountMicros,currency:n.paymentRequest.currency,products:[],transaction:{type:e.Platform.BRAINTREE,deviceData:n.dropInResult.deviceData,id:"nonce",paymentMethodNonce:null!==(_=null===(R=n.dropInResult.paymentMethodNonce)||void 0===R?void 0:R.nonce)&&void 0!==_?_:"",paymentDescription:n.dropInResult.paymentDescription,paymentMethodType:n.dropInResult.paymentMethodType}};this.log.error("Unexpected error, expecting a BraintreeReceipt: "+JSON.stringify(n))})}handleReceiptValidationResponse(n,a){var u;return A(this,void 0,void 0,function*(){if(this.log.info("receipt validation response: "+JSON.stringify(a)),null!=a&&a.data&&"transaction"in a.data&&"braintree"===a.data.transaction.type){const h=null===(u=a.data.transaction.data.transaction)||void 0===u?void 0:u.customer.id;h&&!p.customerId&&(this.log.info("customerId updated: "+h),p.customerId=h)}})}checkSupport(n){return"requestPayment"===n}restorePurchases(){return A(this,void 0,void 0,function*(){})}};const o=c=>!(!c||"code"in c&&"message"in c),r=(c,n)=>n?n.code===e.ErrorCode.PAYMENT_CANCELLED?void c.info("User cancelled the payment request"):(c.warn("launchDropIn failed: "+JSON.stringify(n)),n):(c.warn("launchDropIn failed: no response"),i(e.ErrorCode.BAD_RESPONSE,"Braintree failed to launch drop in"));function i(c,n){return e.storeError(c,n,e.Platform.BRAINTREE,null)}p.braintreeError=i}(T=e.Braintree||(e.Braintree={}))}(f||(f={})),function(e){let T;!function(p){const l="BraintreePlugin";let d;(d=p.AndroidBridge||(p.AndroidBridge={})).Bridge=class t{constructor(r){this.log=r.child("AndroidBridge")}listener(r){this.log.debug("listener: "+JSON.stringify(r)),r&&r.type&&"getClientToken"===r.type&&this.getClientToken()}initialize(r,i){try{if("string"==typeof r){const n=r;this.clientTokenProvider=a=>{a(n)}}else this.clientTokenProvider=r;this.log.info("exec.setListener()");const c=this.listener.bind(this);window.cordova.exec(c,null,l,"setListener",[]),i(void 0)}catch(c){this.log.warn("initialization failed: "+(null==c?void 0:c.message)),i(p.braintreeError(e.ErrorCode.SETUP,"Failed to initialize Braintree Android Bridge: "+(null==c?void 0:c.message)))}}getClientToken(){this.log.info("getClientToken()"),this.clientTokenProvider?(this.log.debug("clientTokenProvider set, calling."),this.clientTokenProvider(r=>{"string"==typeof r?window.cordova.exec(null,null,l,"onClientTokenSuccess",[r]):window.cordova.exec(null,null,l,"onClientTokenFailure",[r.code,r.message])})):(this.log.debug("clientTokenProvider not set, retrying later..."),setTimeout(()=>this.getClientToken(),1e3))}static isSupported(){return"android"===window.cordova.platformId}isApplePaySupported(){return A(this,void 0,void 0,function*(){return!1})}launchDropIn(r){return new Promise(i=>{window.cordova.exec(c=>{this.log.info("dropInSuccess: "+JSON.stringify(c)),i(c)},c=>{this.log.info("dropInFailure: "+c);const n=c.split("|")[0],a=c.split("|").slice(1).join("");i("UserCanceledException"===n?p.braintreeError(e.ErrorCode.PAYMENT_CANCELLED,a):"AuthorizationException"===n?p.braintreeError(e.ErrorCode.UNAUTHORIZED_REQUEST_DATA,a):p.braintreeError(e.ErrorCode.UNKNOWN,c))},l,"launchDropIn",[r])})}}}(T=e.Braintree||(e.Braintree={}))}(f||(f={})),function(e){let T;!function(p){let l;!function(d){const s="BraintreeApplePayPlugin";class t{static get(){return window.CdvPurchaseBraintreeApplePay}static requestPayment(r){return new Promise(i=>{var c;if(null===(c=t.get())||void 0===c||!c.installed)return i(p.braintreeError(e.ErrorCode.SETUP,"cordova-plugin-purchase-braintree-applepay does not appear to be installed."));window.cordova.exec(u=>{i(u)},u=>{i(p.braintreeError(e.ErrorCode.PURCHASE,"Braintree+ApplePay ERROR: "+(null!=u?u:"payment request failed")))},s,"presentDropInPaymentUI",[r])})}static isSupported(r){return new Promise(i=>{var c;if("ios"!==window.cordova.platformId)return r.info("BraintreeApplePayPlugin is only available for ios."),i(!1);if(null===(c=t.get())||void 0===c||!c.installed)return r.info("BraintreeApplePayPlugin does not appear to be installed."),i(!1);try{window.cordova.exec(n=>{i(n)},()=>{r.info("BraintreeApplePayPlugin is not available."),i(!1)},s,"isApplePaySupported",[])}catch{r.info("BraintreeApplePayPlugin is not installed."),i(!1)}})}}d.ApplePayPlugin=t}(l=p.IosBridge||(p.IosBridge={}))}(T=e.Braintree||(e.Braintree={}))}(f||(f={})),function(e){let T;!function(p){let d;var s;(s=d=p.IosBridge||(p.IosBridge={})).Bridge=class t{constructor(r,i,c){this.log=r.child("IosBridge"),this.clientTokenProvider=i,this.applePayOptions=c}initialize(r,i){window.cordova.exec(null,null,"BraintreePlugin","setVerbosity",[r.verbosity]),window.cordova.exec(c=>this.log.debug("(Native) "+c),null,"BraintreePlugin","setLogger",[]),setTimeout(()=>i(void 0),0)}continueDropInForApplePay(r,i,c){var n,a,u,h,R,_,g,S,y;return A(this,void 0,void 0,function*(){const I=(null===(a=null===(n=this.applePayOptions)||void 0===n?void 0:n.preparePaymentRequest)||void 0===a?void 0:a.call(n,r))||{merchantCapabilities:[e.ApplePay.MerchantCapability.ThreeDS]};if(!I.paymentSummaryItems){const m=r.items.filter(O=>O).map((O,b)=>{var N,v,D;return{type:"final",label:(null==O?void 0:O.title)||(null==O?void 0:O.id)||`Item #${b+1}`,amount:""+Math.round((null!==(D=null!==(v=null===(N=null==O?void 0:O.pricing)||void 0===N?void 0:N.priceMicros)&&void 0!==v?v:r.amountMicros)&&void 0!==D?D:0)/1e4)/100}}),P={type:"final",label:null!==(h=null===(u=this.applePayOptions)||void 0===u?void 0:u.companyName)&&void 0!==h?h:"Total",amount:""+Math.round((null!==(R=r.amountMicros)&&void 0!==R?R:0)/1e4)/100};I.paymentSummaryItems=[...m,P]}const E=yield s.ApplePayPlugin.requestPayment(I);return this.log.info("Result from Apple Pay: "+JSON.stringify(E)),"isError"in E?E:E.userCancelled?p.braintreeError(e.ErrorCode.PAYMENT_CANCELLED,"User cancelled the payment request"):{paymentMethodNonce:{isDefault:!1,nonce:null!==(g=null===(_=E.applePayCardNonce)||void 0===_?void 0:_.nonce)&&void 0!==g?g:"",type:null!==(y=null===(S=E.applePayCardNonce)||void 0===S?void 0:S.type)&&void 0!==y?y:""},paymentMethodType:c.paymentMethodType,deviceData:c.deviceData,paymentDescription:c.paymentDescription}})}launchDropIn(r,i){return new Promise(c=>A(this,void 0,void 0,function*(){const n=u=>{this.log.info("dropInSuccess: "+JSON.stringify(u)),u.paymentMethodType===p.DropIn.PaymentMethod.APPLE_PAY?(this.log.info("it's an ApplePay request, we have to process it."),this.continueDropInForApplePay(r,i,u).then(c)):c(u)},a=u=>{this.log.info("dropInFailure: "+u);const[h,R]=u.split("|");c("UserCanceledException"===h?p.braintreeError(e.ErrorCode.PAYMENT_CANCELLED,R):p.braintreeError(e.ErrorCode.UNKNOWN,"ERROR "+h+": "+R))};this.clientTokenProvider(u=>{"string"==typeof u?window.cordova.exec(n,a,"BraintreePlugin","launchDropIn",[u,i]):c(u)})}))}braintreePlugin(){return window.CdvPurchaseBraintree}static isSupported(){return"ios"===window.cordova.platformId}}}(T=e.Braintree||(e.Braintree={}))}(f||(f={})),function(e){let T;!function(p){let l;!function(d){let s;var t;(t=s=d.CardFormFieldStatus||(d.CardFormFieldStatus={}))[t.DISABLED=0]="DISABLED",t[t.OPTIONAL=1]="OPTIONAL",t[t.REQUIRED=2]="REQUIRED"}(l=p.DropIn||(p.DropIn={}))}(T=e.Braintree||(e.Braintree={}))}(f||(f={})),function(e){let T;!function(p){let l;!function(d){let s;var t;(t=s=d.PaymentMethod||(d.PaymentMethod={})).GOOGLE_PAY="GOOGLE_PAY",t.LASER="LASER",t.UK_MAESTRO="UK_MAESTRO",t.SWITCH="SWITCH",t.SOLOR="SOLO",t.APPLE_PAY="APPLE_PAY",t.AMEX="AMEX",t.DINERS_CLUB="DINERS_CLUB",t.DISCOVER="DISCOVER",t.JCB="JCB",t.MAESTRO="MAESTRO",t.MASTERCARD="MASTERCARD",t.PAYPAL="PAYPAL",t.VISA="VISA",t.VENMO="VENMO",t.UNIONPAY="UNIONPAY",t.HIPER="HIPER",t.HIPERCARD="HIPERCARD",t.UNKNOWN="UNKNOWN"}(l=p.DropIn||(p.DropIn={}))}(T=e.Braintree||(e.Braintree={}))}(f||(f={})),function(e){let T;!function(p){let l;!function(d){let s;var o;let t;(o=s=d.BillingAddressFormat||(d.BillingAddressFormat={}))[o.MIN=0]="MIN",o[o.FULL=1]="FULL",function(o){o[o.NOT_CURRENTLY_KNOWN=1]="NOT_CURRENTLY_KNOWN",o[o.ESTIMATED=2]="ESTIMATED",o[o.FINAL=3]="FINAL"}(t=d.TotalPriceStatus||(d.TotalPriceStatus={}))}(l=p.GooglePay||(p.GooglePay={}))}(T=e.Braintree||(e.Braintree={}))}(f||(f={})),function(e){let T;!function(p){let l;!function(d){let s;var r;let t,o;(r=s=d.AccountType||(d.AccountType={})).UNSPECIFIED="00",r.CREDIT="01",r.DEBIT="02",function(r){r[r.UNSPECIFIED=0]="UNSPECIFIED",r[r.SAME_DAY=1]="SAME_DAY",r[r.EXPEDITED=2]="EXPEDITED",r[r.PRIORITY=3]="PRIORITY",r[r.GROUND=4]="GROUND",r[r.ELECTRONIC_DELIVERY=5]="ELECTRONIC_DELIVERY",r[r.SHIP_TO_STORE=6]="SHIP_TO_STORE"}(t=d.ShippingMethod||(d.ShippingMethod={})),function(r){r[r.V1=0]="V1",r[r.V2=1]="V2"}(o=d.Version||(d.Version={}))}(l=p.ThreeDSecure||(p.ThreeDSecure={}))}(T=e.Braintree||(e.Braintree={}))}(f||(f={})),function(e){let T;!function(p){class l extends e.Transaction{constructor(r,i,c){super(e.Platform.GOOGLE_PLAY,i,c),this.nativePurchase=r,this.refresh(r)}static toState(r,i,c){switch(r){case p.Bridge.PurchaseState.PENDING:return e.TransactionState.INITIATED;case p.Bridge.PurchaseState.PURCHASED:return c?e.TransactionState.FINISHED:e.TransactionState.APPROVED;case p.Bridge.PurchaseState.UNSPECIFIED_STATE:return e.TransactionState.UNKNOWN_STATE}}refresh(r){var i,c;this.nativePurchase=r,this.transactionId=`${r.orderId||r.purchaseToken}`,this.purchaseId=`${r.purchaseToken}`,this.products=r.productIds.map(n=>({id:n})),r.purchaseTime&&(this.purchaseDate=new Date(r.purchaseTime)),this.isPending=r.getPurchaseState===p.Bridge.PurchaseState.PENDING,typeof r.acknowledged<"u"&&(this.isAcknowledged=r.acknowledged),typeof r.consumed<"u"&&(this.isConsumed=r.consumed),typeof r.autoRenewing<"u"&&(this.renewalIntent=r.autoRenewing?e.RenewalIntent.RENEW:e.RenewalIntent.LAPSE),this.state=l.toState(r.getPurchaseState,null!==(i=this.isAcknowledged)&&void 0!==i&&i,null!==(c=this.isConsumed)&&void 0!==c&&c)}}p.Transaction=l;class d extends e.Receipt{constructor(r,i){super(e.Platform.GOOGLE_PLAY,i),this.transactions=[new l(r,this,i)],this.purchaseToken=r.purchaseToken,this.orderId=r.orderId}refreshPurchase(r){var i;null===(i=this.transactions[0])||void 0===i||i.refresh(r),this.orderId=r.orderId}}p.Receipt=d;let s=(()=>{class o{constructor(i,c=864e5){if(this.id=e.Platform.GOOGLE_PLAY,this.name="GooglePlay",this.ready=!1,this.supportsParallelLoading=!1,this._receipts=[],this.bridge=new p.Bridge.Bridge,this.initialized=!1,this.retry=new e.Internal.Retry,this.autoRefreshIntervalMillis=0,o._instance)throw new Error("GooglePlay adapter already initialized");this._products=new p.Products(i.apiDecorators),this.autoRefreshIntervalMillis=c,this.context=i,this.log=i.log.child("GooglePlay"),o._instance=this}get products(){return this._products.products}get receipts(){return this._receipts}get isSupported(){return"android"===window.cordova.platformId}initialize(){return A(this,void 0,void 0,function*(){return this.log.info("Initialize"),this.initializationPromise?this.initializationPromise:this.initializationPromise=new Promise(i=>{const c=this.log.child("Bridge"),n={onSetPurchases:this.onSetPurchases.bind(this),onPurchasesUpdated:this.onPurchasesUpdated.bind(this),onPurchaseConsumed:this.onPurchaseConsumed.bind(this),showLog:this.context.verbosity>=e.LogLevel.DEBUG,log:h=>c.info(h)};this.bridge.init(()=>{this.log.debug("Ready"),this.autoRefreshIntervalMillis>0&&window.setInterval(()=>this.getPurchases(),this.autoRefreshIntervalMillis),i(void 0)},h=>{this.initialized=!1,this.context.error(t(e.ErrorCode.SETUP,"Init failed - "+h,null)),this.retry.retry(()=>this.initialize())},n)})})}getSkusOf(i){const c=[],n=[];for(const a of i)a.type===e.ProductType.PAID_SUBSCRIPTION?n.push(a.id):c.push(a.id);return{inAppSkus:c,subsSkus:n}}loadReceipts(){return new Promise(i=>{this.getPurchases().then(c=>{i(this._receipts)})})}loadProducts(i){return new Promise(c=>{this.log.debug("Load: "+JSON.stringify(i));const n=u=>{this.log.debug("Loaded: "+JSON.stringify(u));const h=i.map(R=>{const _=u.find(g=>g.productId===R.id);return _&&_.productId?this._products.addProduct(R,_):t(e.ErrorCode.INVALID_PRODUCT_ID,`Product with id ${R.id} not found.`,R.id)});c(h)},a=()=>{const{inAppSkus:u,subsSkus:h}=this.getSkusOf(i);this.log.debug("getAvailableProducts: "+JSON.stringify(u)+" | "+JSON.stringify(h)),this.bridge.getAvailableProducts(u,h,n,R=>{this.retry.retry(a),this.context.error(t(e.ErrorCode.LOAD,"Loading product info failed - "+R+" - retrying later...",null))})};a()})}finish(i){return new Promise(c=>{const n=()=>{i.state!==e.TransactionState.FINISHED&&(i.state=e.TransactionState.FINISHED,this.context.listener.receiptsUpdated(e.Platform.GOOGLE_PLAY,[i.parentReceipt])),c(void 0)},a=i.products[0];if(!a)return c(t(e.ErrorCode.FINISH,"Cannot finish a transaction with no product",null));const u=this._products.getProduct(a.id);if(!u)return c(t(e.ErrorCode.FINISH,"Cannot finish transaction, unknown product "+a.id,a.id));const h=this._receipts.find(_=>_.hasTransaction(i));if(!h)return c(t(e.ErrorCode.FINISH,"Cannot finish transaction, linked receipt not found.",u.id));if(!h.purchaseToken)return c(t(e.ErrorCode.FINISH,"Cannot finish transaction, linked receipt contains no purchaseToken.",u.id));const R=(_,g)=>c(t(g||e.ErrorCode.UNKNOWN,_,u.id));if(u.type===e.ProductType.NON_RENEWING_SUBSCRIPTION||u.type===e.ProductType.CONSUMABLE){if(!i.isConsumed)return this.bridge.consumePurchase(n,R,h.purchaseToken)}else if(!i.isAcknowledged)return this.bridge.acknowledgePurchase(n,R,h.purchaseToken);c(void 0)})}onPurchaseConsumed(i){this.log.debug("onPurchaseConsumed: "+i.orderId),i.acknowledged=!0,i.consumed=!0,this.onPurchasesUpdated([i])}onPurchasesUpdated(i){this.log.debug("onPurchaseUpdated: "+i.map(c=>c.orderId).join(", ")),i.forEach(c=>{const n=this.receipts.find(a=>a.purchaseToken===c.purchaseToken);if(n)n.refreshPurchase(c),this.context.listener.receiptsUpdated(e.Platform.GOOGLE_PLAY,[n]);else{const a=new d(c,this.context.apiDecorators);this.receipts.push(a),this.context.listener.receiptsUpdated(e.Platform.GOOGLE_PLAY,[a])}})}onSetPurchases(i){this.log.debug("onSetPurchases: "+JSON.stringify(i)),this.onPurchasesUpdated(i),this.context.listener.receiptsReady(e.Platform.GOOGLE_PLAY)}onPriceChangeConfirmationResult(i){}getPurchases(){return new Promise(i=>{this.log.debug("getPurchases"),this.bridge.getPurchases(()=>{this.log.debug("getPurchases success"),setTimeout(()=>i(void 0),0)},(a,u)=>{this.log.warn("getPurchases failed: "+a+" ("+u+")"),setTimeout(()=>i(t(u||e.ErrorCode.UNKNOWN,a,null)),0)})})}order(i,c){return A(this,void 0,void 0,function*(){return new Promise(n=>{this.log.info("Order - "+JSON.stringify(i));const a=()=>n(void 0),u=(h,R)=>{this.log.warn("Order failed: "+JSON.stringify({message:h,code:R})),n(t(null!=R?R:e.ErrorCode.UNKNOWN,h,i.productId))};if(i.productType===e.ProductType.PAID_SUBSCRIPTION){const h="token"in i?i.productId+"@"+i.token:i.productId,R=this.findOldPurchaseToken(i.productId,i.productGroup);R&&(c.googlePlay?c.googlePlay.oldPurchaseToken||(c.googlePlay.oldPurchaseToken=R):c.googlePlay={oldPurchaseToken:R}),this.bridge.subscribe(a,u,h,c)}else this.bridge.buy(a,u,i.productId,c)})})}findOldPurchaseToken(i,c){if(!c)return;const n=this._receipts.find(a=>!!a.transactions.find(u=>!!u.products.find(h=>{const R=this._products.getProduct(h.id);return!(!R||!e.Internal.LocalReceipts.isOwned([a],R))&&(h.id===i||c&&R.group===c)})));return null==n?void 0:n.purchaseToken}receiptValidationBody(i){var c;return A(this,void 0,void 0,function*(){const n=i.transactions[0];if(!n)return;const a=null===(c=n.products[0])||void 0===c?void 0:c.id;if(!a)return;const u=this._products.getProduct(a);if(!u)return;const h=n.nativePurchase;return{id:a,type:u.type,offers:u.offers,products:this._products.products,transaction:{type:e.Platform.GOOGLE_PLAY,id:i.transactions[0].transactionId,purchaseToken:h.purchaseToken,signature:h.signature,receipt:h.receipt}}})}handleReceiptValidationResponse(i,c){var n;return A(this,void 0,void 0,function*(){if(null!=c&&c.ok){const a=null===(n=null==c?void 0:c.data)||void 0===n?void 0:n.transaction;if((null==a?void 0:a.type)!==e.Platform.GOOGLE_PLAY)return}})}requestPayment(i,c){return A(this,void 0,void 0,function*(){return t(e.ErrorCode.UNKNOWN,"requestPayment not supported",null)})}manageSubscriptions(){return A(this,void 0,void 0,function*(){this.bridge.manageSubscriptions()})}manageBilling(){return A(this,void 0,void 0,function*(){this.bridge.manageBilling()})}checkSupport(i){return["order","manageBilling","manageSubscriptions"].indexOf(i)>=0}restorePurchases(){return new Promise(i=>{this.bridge.getPurchases(()=>i(void 0),(c,n)=>{this.log.warn("getPurchases() failed: "+(null!=n?n:"ERROR")+": "+c),i(t(null!=n?n:e.ErrorCode.UNKNOWN,c,null))})})}}return o.trimProductTitles=!0,o})();function t(o,r,i){return e.storeError(o,r,e.Platform.GOOGLE_PLAY,i)}p.Adapter=s}(T=e.GooglePlay||(e.GooglePlay={}))}(f||(f={})),function(e){let T;!function(p){let l;!function(d){let s;var t;(t=s=d.RecurrenceMode||(d.RecurrenceMode={})).FINITE_RECURRING="FINITE_RECURRING",t.INFINITE_RECURRING="INFINITE_RECURRING",t.NON_RECURRING="NON_RECURRING"}(l=p.Bridge||(p.Bridge={}))}(T=e.GooglePlay||(e.GooglePlay={}))}(f||(f={})),function(e){let T;!function(p){let l;var s;let d;(s=l=p.ProrationMode||(p.ProrationMode={})).IMMEDIATE_WITH_TIME_PRORATION="IMMEDIATE_WITH_TIME_PRORATION",s.IMMEDIATE_AND_CHARGE_PRORATED_PRICE="IMMEDIATE_AND_CHARGE_PRORATED_PRICE",s.IMMEDIATE_WITHOUT_PRORATION="IMMEDIATE_WITHOUT_PRORATION",s.DEFERRED="DEFERRED",s.IMMEDIATE_AND_CHARGE_FULL_PRICE="IMMEDIATE_AND_CHARGE_FULL_PRICE",function(s){let o,t=function(u){console.log("InAppBilling[js]: "+u)};var a;function i(a){return function(u){if(!a)return;const h="string"==typeof u?u.split("|"):[];h.length>1&&/^[-+]?(\d+)$/.test(h[0])?a(h[1],+h[0]):a(u)}}function n(a){const u=function c(a){return a&&a.constructor===Object?a:{}}(null==a?void 0:a.googlePlay);return!u.accountId&&null!=a&&a.applicationUsername&&(u.accountId=e.Utils.md5(a.applicationUsername)),u}(a=o=s.PurchaseState||(s.PurchaseState={}))[a.UNSPECIFIED_STATE=0]="UNSPECIFIED_STATE",a[a.PURCHASED=1]="PURCHASED",a[a.PENDING=2]="PENDING",s.Bridge=class r{constructor(){this.options={}}init(u,h,R){R||(R={}),R.log&&(t=R.log),this.options={showLog:!1!==R.showLog,onPurchaseConsumed:R.onPurchaseConsumed,onPurchasesUpdated:R.onPurchasesUpdated,onSetPurchases:R.onSetPurchases},this.options.showLog&&t("setup ok");const _=this.listener.bind(this);window.cordova.exec(_,function(g){},"InAppBillingPlugin","setListener",[]),window.cordova.exec(u,i(h),"InAppBillingPlugin","init",[])}load(u,h,R,_,g){if(typeof R<"u"&&("string"==typeof R&&(R=[R]),R.length>0)){if("string"!=typeof R[0]){var y="invalid productIds: "+JSON.stringify(R);return this.options.showLog&&t(y),void h(y,e.ErrorCode.INVALID_PRODUCT_ID)}this.options.showLog&&t("load "+JSON.stringify(R))}window.cordova.exec(u,i(h),"InAppBillingPlugin","load",[R,_,g])}listener(u){this.options.showLog&&t("listener: "+JSON.stringify(u)),u&&u.type&&("setPurchases"===u.type&&this.options.onSetPurchases&&this.options.onSetPurchases(u.data.purchases),"purchasesUpdated"===u.type&&this.options.onPurchasesUpdated&&this.options.onPurchasesUpdated(u.data.purchases),"purchaseConsumed"===u.type&&this.options.onPurchaseConsumed&&this.options.onPurchaseConsumed(u.data.purchase),"onPriceChangeConfirmationResultOK"===u.type&&this.options.onPriceChangeConfirmationResult&&this.options.onPriceChangeConfirmationResult("OK"),"onPriceChangeConfirmationResultUserCanceled"===u.type&&this.options.onPriceChangeConfirmationResult&&this.options.onPriceChangeConfirmationResult("UserCanceled"),"onPriceChangeConfirmationResultUnknownSku"===u.type&&this.options.onPriceChangeConfirmationResult&&this.options.onPriceChangeConfirmationResult("UnknownProduct"))}getPurchases(u,h){return this.options.showLog&&t("getPurchases()"),window.cordova.exec(u,i(h),"InAppBillingPlugin","getPurchases",["null"])}buy(u,h,R,_){return this.options.showLog&&t("buy()"),window.cordova.exec(u,i(h),"InAppBillingPlugin","buy",[R,n(_)])}subscribe(u,h,R,_){var g;return this.options.showLog&&t("subscribe()"),!(null===(g=_.googlePlay)||void 0===g)&&g.oldPurchaseToken&&this.options.showLog&&t("subscribe() -> upgrading from an old purchase"),window.cordova.exec(u,i(h),"InAppBillingPlugin","subscribe",[R,n(_)])}consumePurchase(u,h,R){return this.options.showLog&&t("consumePurchase()"),window.cordova.exec(u,i(h),"InAppBillingPlugin","consumePurchase",[R])}acknowledgePurchase(u,h,R){return this.options.showLog&&t("acknowledgePurchase()"),window.cordova.exec(u,i(h),"InAppBillingPlugin","acknowledgePurchase",[R])}getAvailableProducts(u,h,R,_){return this.options.showLog&&t("getAvailableProducts()"),window.cordova.exec(R,i(_),"InAppBillingPlugin","getAvailableProducts",[u,h])}manageSubscriptions(){return window.cordova.exec(function(){},function(){},"InAppBillingPlugin","manageSubscriptions",[])}manageBilling(){return window.cordova.exec(function(){},function(){},"InAppBillingPlugin","manageBilling",[])}launchPriceChangeConfirmationFlow(u){return window.cordova.exec(function(){},function(){},"InAppBillingPlugin","launchPriceChangeConfirmationFlow",[u])}}}(d=p.Bridge||(p.Bridge={}))}(T=e.GooglePlay||(e.GooglePlay={}))}(f||(f={})),function(e){let T;!function(p){class l extends e.Product{}p.GProduct=l;class d extends e.Offer{constructor(){super(...arguments),this.type="inapp"}}p.InAppOffer=d;class s extends e.Offer{constructor(r,i){super(r,i),this.type="subs",this.tags=r.tags,this.token=r.token}}p.SubscriptionOffer=s,p.Products=class t{constructor(r){this.products=[],this.offers=[],this.decorator=r}getProduct(r){return this.products.find(i=>i.id===r)}getOffer(r){return this.offers.find(i=>i.id===r)}addProduct(r,i){const c=this.getProduct(r.id),n=null!=c?c:new l(r,this.decorator);return n.title=i.title||i.name||n.title,p.Adapter.trimProductTitles&&(n.title=n.title.replace(/ \(.*\)$/,"")),n.description=i.description||n.description,"product_format"in i&&"v12.0"===i.product_format&&"subs"===i.product_type?this.onSubsV12Loaded(n,i):this.onInAppLoaded(n,i),c||this.products.push(n),n}onSubsV12Loaded(r,i){return i.offers.forEach(n=>{const a=n.pricing_phases.slice(-1)[0];if((null==a?void 0:a.recurrence_mode)===e.RecurrenceMode.FINITE_RECURRING){const h=function c(n){if(!n)return null;for(const a of i.offers)if(a.base_plan_id===n&&!a.offer_id)return a;return null}(n.base_plan_id);h&&h!==n&&n.pricing_phases.push(...h.pricing_phases)}const u=this.iabSubsOfferV12Loaded(r,i,n);r.addOffer(u)}),r}makeOfferId(r,i){return i.base_plan_id?i.offer_id?r+"@"+i.base_plan_id+"@"+i.offer_id:r+"@"+i.base_plan_id:r+"@"+i.token}iabSubsOfferV12Loaded(r,i,c){const n=this.makeOfferId(i.productId,c),a=this.getOffer(n),u=c.pricing_phases.map(h=>this.toPricingPhase(h));if(a)return a.pricingPhases=u,a;{const h=new s({id:n,product:r,pricingPhases:u,token:c.token,tags:c.tags},this.decorator);return this.offers.push(h),h}}onInAppLoaded(r,i){var c,n,a,u;const h=this.getOffer(i.productId),R=[{price:null!==(n=null!==(c=i.formatted_price)&&void 0!==c?c:i.price)&&void 0!==n?n:`${(null!==(a=i.price_amount_micros)&&void 0!==a?a:0)/1e6} ${i.price_currency_code}`,priceMicros:null!==(u=i.price_amount_micros)&&void 0!==u?u:0,currency:i.price_currency_code,recurrenceMode:e.RecurrenceMode.NON_RECURRING}];if(h)h.pricingPhases=R,r.offers=[h];else{const _=new d({id:i.productId,product:r,pricingPhases:R},this.decorator);this.offers.push(_),r.offers=[_]}return r}toPaymentMode(r){return 0===r.price_amount_micros?e.PaymentMode.FREE_TRIAL:r.recurrence_mode===p.Bridge.RecurrenceMode.NON_RECURRING?e.PaymentMode.UP_FRONT:e.PaymentMode.PAY_AS_YOU_GO}toRecurrenceMode(r){switch(r){case p.Bridge.RecurrenceMode.FINITE_RECURRING:return e.RecurrenceMode.FINITE_RECURRING;case p.Bridge.RecurrenceMode.INFINITE_RECURRING:return e.RecurrenceMode.INFINITE_RECURRING;case p.Bridge.RecurrenceMode.NON_RECURRING:return e.RecurrenceMode.NON_RECURRING}}toPricingPhase(r){return{price:r.formatted_price,priceMicros:r.price_amount_micros,currency:r.price_currency_code,billingPeriod:r.billing_period,billingCycles:r.billing_cycle_count,recurrenceMode:this.toRecurrenceMode(r.recurrence_mode),paymentMode:this.toPaymentMode(r)}}}}(T=e.GooglePlay||(e.GooglePlay={}))}(f||(f={})),function(e){let T;!function(p){let l;!function(d){let s;var o;let t;(o=s=d.GoogleErrorReason||(d.GoogleErrorReason={})).SUBSCRIPTION_NO_LONGER_AVAILABLE="subscriptionPurchaseNoLongerAvailable",o.PURCHASE_TOKEN_NO_LONGER_VALID="purchaseTokenNoLongerValid",function(o){o[o.GONE=410]="GONE"}(t=d.ErrorCode||(d.ErrorCode={}))}(l=p.PublisherAPI||(p.PublisherAPI={}))}(T=e.GooglePlay||(e.GooglePlay={}))}(f||(f={})),function(e){let T;!function(p){const l=e.Platform.TEST;let d=[];function s(r){r.products.forEach(i=>{var c,n,a,u;const h=d.find(_=>i.id===_.id),R={id:i.id,purchaseDate:null===(c=r.purchaseDate)||void 0===c?void 0:c.getTime(),expiryDate:null===(n=r.expirationDate)||void 0===n?void 0:n.getTime(),lastRenewalDate:null===(a=r.lastRenewalDate)||void 0===a?void 0:a.getTime(),renewalIntent:r.renewalIntent,renewalIntentChangeDate:null===(u=r.renewalIntentChangeDate)||void 0===u?void 0:u.getTime()};h?Object.assign(h,R):d.push(R)})}function o(r,i,c){return e.storeError(r,i,e.Platform.TEST,c)}p.Adapter=class t{constructor(i){this.id=e.Platform.TEST,this.name="Test",this.ready=!1,this.products=[],this.receipts=[],this.supportsParallelLoading=!0,this.context=i,this.log=i.log.child("Test")}get isSupported(){return!0}initialize(){return A(this,void 0,void 0,function*(){})}loadReceipts(){return A(this,void 0,void 0,function*(){return new Promise(i=>{setTimeout(()=>{this.context.listener.receiptsReady(e.Platform.TEST),i(this.receipts)},600)})})}loadProducts(i){return A(this,void 0,void 0,function*(){return i.map(c=>{if(!p.testProductsArray.find(u=>u.id===c.id&&u.type===c.type))return o(e.ErrorCode.PRODUCT_NOT_AVAILABLE,"This product is not available",c.id);const n=this.products.find(u=>u.id===c.id);if(n)return n;c.id===p.testProducts.PAID_SUBSCRIPTION_ACTIVE.id&&setTimeout(()=>{this.reportActiveSubscription()},500);const a=p.initTestProduct(c.id,this.context.apiDecorators);return a?(this.products.push(a),this.context.listener.productsUpdated(e.Platform.TEST,[a]),a):o(e.ErrorCode.PRODUCT_NOT_AVAILABLE,"Could not load this product",c.id)})})}order(i){return A(this,void 0,void 0,function*(){if(i.id.indexOf("-fail-")>0)return o(e.ErrorCode.PURCHASE,"Purchase failed.",i.productId);const c=this.products.find(h=>h.id===i.productId);if(!e.Internal.LocalReceipts.canPurchase(this.receipts,c))return o(e.ErrorCode.PURCHASE,"Product already owned",i.productId);const n=prompt(`Do you want to purchase ${i.productId} for ${i.pricingPhases[0].price}?\nEnter "Y" to confirm.\nEnter "E" to fail with an error.Anything else to cancel.`);if("E"===(null==n?void 0:n.toUpperCase()))return o(e.ErrorCode.PURCHASE,"Purchase failed",i.productId);if("Y"!==(null==n?void 0:n.toUpperCase()))return o(e.ErrorCode.PAYMENT_CANCELLED,"Purchase flow has been cancelled by the user",i.productId);const a=new e.Receipt(l,this.context.apiDecorators),u=new e.Transaction(l,a,this.context.apiDecorators);a.transactions=[u],u.products=[{id:i.productId,offerId:i.id}],u.state=e.TransactionState.APPROVED,u.purchaseDate=new Date,u.transactionId=i.productId+"-"+(new Date).getTime(),u.isAcknowledged=!1,i.productType===e.ProductType.PAID_SUBSCRIPTION&&(u.expirationDate=new Date(+new Date+6048e5),u.renewalIntent=e.RenewalIntent.RENEW),s(u),this.receipts.push(a),this.context.listener.receiptsUpdated(e.Platform.TEST,[a])})}finish(i){return new Promise(c=>{setTimeout(()=>{i.state=e.TransactionState.FINISHED,i.isAcknowledged=!0,s(i);const n=this.products.find(u=>i.products[0].id===u.id);(null==n?void 0:n.type)===e.ProductType.CONSUMABLE&&(i.isConsumed=!0);const a=this.receipts.filter(u=>u.hasTransaction(i));this.context.listener.receiptsUpdated(l,a),c(void 0)},500)})}receiptValidationBody(i){return A(this,void 0,void 0,function*(){})}handleReceiptValidationResponse(i,c){return A(this,void 0,void 0,function*(){})}requestPayment(i,c){var n;return A(this,void 0,void 0,function*(){yield e.Utils.asyncDelay(100);const a=prompt(`Mock payment of ${(null!==(n=i.amountMicros)&&void 0!==n?n:0)/1e6} ${i.currency}. Enter "Y" to confirm. Enter "E" to trigger an error.`);if("E"===(null==a?void 0:a.toUpperCase()))return o(e.ErrorCode.PAYMENT_NOT_ALLOWED,"Payment not allowed",null);if("Y"!==(null==a?void 0:a.toUpperCase()))return;const u=new e.Receipt(l,this.context.apiDecorators),h=new e.Transaction(e.Platform.TEST,u,this.context.apiDecorators);return h.purchaseDate=new Date,h.products=i.items.filter(R=>R).map(R=>({id:(null==R?void 0:R.id)||""})),h.state=e.TransactionState.APPROVED,h.transactionId="payment-"+(new Date).getTime(),h.amountMicros=i.amountMicros,h.currency=i.currency,u.transactions=[h],this.receipts.push(u),setTimeout(()=>{this.context.listener.receiptsUpdated(l,[u])},400),h})}manageSubscriptions(){return A(this,void 0,void 0,function*(){alert("Pseudo subscription management interface. Close it when you are done.")})}manageBilling(){return A(this,void 0,void 0,function*(){alert("Pseudo billing management interface. Close it when you are done.")})}reportActiveSubscription(){if(this.receipts.find(h=>h.transactions[0].transactionId===a(1)))return;const i=12e4,c=new e.Receipt(l,this.context.apiDecorators),n=h=>{var R,_;const g=new e.Transaction(l,c,this.context.apiDecorators);g.products=[{id:p.testProducts.PAID_SUBSCRIPTION_ACTIVE.id,offerId:p.testProducts.PAID_SUBSCRIPTION_ACTIVE.extra.offerId}],g.state=e.TransactionState.APPROVED,g.transactionId=a(h),g.isAcknowledged=1==h,g.renewalIntent=e.RenewalIntent.RENEW;const S=+((null===(_=null===(R=null==c?void 0:c.transactions)||void 0===R?void 0:R[0])||void 0===_?void 0:_.purchaseDate)||new Date);return g.purchaseDate=new Date(S),g.lastRenewalDate=new Date(S+i*(h-1)),g.expirationDate=new Date(S+i*h),s(g),g};function a(h){return"test-active-subscription-transaction-"+h}c.transactions.push(n(1)),this.receipts.push(c),this.context.listener.receiptsUpdated(e.Platform.TEST,[c]);let u=1;setInterval(()=>{this.log.info("auto-renewing the mock subscription"),u+=1,c.transactions.push(n(u)),this.context.listener.receiptsUpdated(e.Platform.TEST,[c])},i)}static verify(i,c){setTimeout(()=>{var n,a;c({receipt:i,payload:{ok:!0,data:{id:null===(a=null===(n=i.transactions[0])||void 0===n?void 0:n.products[0])||void 0===a?void 0:a.id,latest_receipt:!0,transaction:{type:"test"},collection:d}}})},500)}checkSupport(i){return!0}restorePurchases(){return A(this,void 0,void 0,function*(){})}}}(T=e.Test||(e.Test={}))}(f||(f={})),function(e){let T;!function(p){const l=e.Platform.TEST;p.testProducts={CONSUMABLE:{platform:l,id:"test-consumable",type:e.ProductType.CONSUMABLE},CONSUMABLE_FAILING:{platform:l,id:"test-consumable-fail",type:e.ProductType.CONSUMABLE},NON_CONSUMABLE:{platform:l,id:"test-non-consumable",type:e.ProductType.NON_CONSUMABLE},PAID_SUBSCRIPTION:{platform:l,id:"test-subscription",type:e.ProductType.PAID_SUBSCRIPTION},PAID_SUBSCRIPTION_ACTIVE:{platform:l,id:"test-subscription-active",type:e.ProductType.PAID_SUBSCRIPTION,extra:{offerId:"test-paid-subscription-active-offer1"}}},p.testProductsArray=e.Utils.objectValues(p.testProducts),p.initTestProduct=function d(s,t){const o=Object.keys(p.testProducts).find(i=>p.testProducts[i]&&p.testProducts[i].id===s);if(!o)return;const r=new e.Product(p.testProducts[o],t);switch(o){case"CONSUMABLE":r.title="Test Consumable",r.description="A consumable product that you can purchase",r.addOffer(new e.Offer({id:"test-consumable-offer1",pricingPhases:[{price:"$4.99",currency:"USD",priceMicros:499e4,paymentMode:e.PaymentMode.UP_FRONT,recurrenceMode:e.RecurrenceMode.NON_RECURRING}],product:r},t));break;case"CONSUMABLE_FAILING":r.title="Failing Consumable",r.description="A consumable product that cannot be purchased",r.addOffer(new e.Offer({id:"test-consumable-fail-offer1",pricingPhases:[{price:"$1.99",currency:"USD",priceMicros:199e4,paymentMode:e.PaymentMode.UP_FRONT,recurrenceMode:e.RecurrenceMode.NON_RECURRING}],product:r},t));break;case"NON_CONSUMABLE":r.title="Non Consumable",r.description="A non consumable product",r.addOffer(new e.Offer({id:"test-non-consumable-offer1",pricingPhases:[{price:"$9.99",currency:"USD",priceMicros:999e4,paymentMode:e.PaymentMode.UP_FRONT,recurrenceMode:e.RecurrenceMode.NON_RECURRING}],product:r},t));break;case"PAID_SUBSCRIPTION":r.title="A subscription product",r.description="An auto-renewing paid subscription with a trial period",r.addOffer(new e.Offer({id:"test-paid-subscription-offer1",product:r,pricingPhases:[{price:"$0.00",currency:"USD",priceMicros:0,paymentMode:e.PaymentMode.FREE_TRIAL,recurrenceMode:e.RecurrenceMode.FINITE_RECURRING,billingCycles:3,billingPeriod:"P1W"},{price:"$4.99",currency:"USD",priceMicros:499e4,paymentMode:e.PaymentMode.PAY_AS_YOU_GO,recurrenceMode:e.RecurrenceMode.INFINITE_RECURRING,billingPeriod:"P1M"}]},t));break;case"PAID_SUBSCRIPTION_ACTIVE":r.title="An owned subscription product",r.description="An active paid subscription",r.addOffer(new e.Offer({id:p.testProducts.PAID_SUBSCRIPTION_ACTIVE.extra.offerId,product:r,pricingPhases:[{price:"$19.99",currency:"USD",priceMicros:1999e4,paymentMode:e.PaymentMode.PAY_AS_YOU_GO,recurrenceMode:e.RecurrenceMode.INFINITE_RECURRING,billingPeriod:"P1Y"}]},t));break;default:throw new Error(`Unhandled enum case: ${o}`)}return r}}(T=e.Test||(e.Test={}))}(f||(f={})),function(e){let T;!function(p){function d(s,t,o){return e.storeError(s,t,e.Platform.WINDOWS_STORE,o)}p.Adapter=class l{constructor(){this.id=e.Platform.WINDOWS_STORE,this.name="WindowsStore",this.ready=!1,this.supportsParallelLoading=!1,this.products=[],this.receipts=[]}initialize(){return A(this,void 0,void 0,function*(){})}get isSupported(){return!1}loadProducts(t){return A(this,void 0,void 0,function*(){return t.map(o=>d(e.ErrorCode.PRODUCT_NOT_AVAILABLE,"TODO",o.id))})}loadReceipts(){return A(this,void 0,void 0,function*(){return[]})}order(t){return A(this,void 0,void 0,function*(){return d(e.ErrorCode.UNKNOWN,"TODO: Not implemented",t.productId)})}finish(t){return A(this,void 0,void 0,function*(){return d(e.ErrorCode.UNKNOWN,"TODO: Not implemented",null)})}handleReceiptValidationResponse(t,o){return A(this,void 0,void 0,function*(){})}receiptValidationBody(t){return A(this,void 0,void 0,function*(){})}requestPayment(t,o){return A(this,void 0,void 0,function*(){return d(e.ErrorCode.UNKNOWN,"requestPayment not supported",null)})}manageSubscriptions(){return A(this,void 0,void 0,function*(){return d(e.ErrorCode.UNKNOWN,"manageSubscriptions not supported",null)})}manageBilling(){return A(this,void 0,void 0,function*(){return d(e.ErrorCode.UNKNOWN,"manageBilling not supported",null)})}checkSupport(t){return!1}restorePurchases(){return A(this,void 0,void 0,function*(){})}}}(T=e.WindowsStore||(e.WindowsStore={}))}(f||(f={})),function(e){let T;!function(p){let l;(l=p.Ajax||(p.Ajax={})).HTTP_REQUEST_TIMEOUT=408,p.ajax=function d(t,o){if(typeof window<"u"&&window.cordova&&window.cordova.plugin&&window.cordova.plugin.http)return function s(t,o){let r=function(){};const i={method:(o.method||"get").toLowerCase(),data:o.data,serializer:"json"};o.customHeaders&&(t.debug("ajax[http] -> adding custom headers: "+JSON.stringify(o.customHeaders)),i.headers=o.customHeaders),t.debug("ajax[http] -> send request to "+o.url);const c=n=>{try{200==n.status?p.callExternal(t,"ajax.success",o.success,JSON.parse(n.data)):(t.warn("ajax[http] -> request to "+o.url+" failed with status "+n.status+" ("+n.error+")"),p.callExternal(t,"ajax.error",o.error,n.status,n.error))}catch(a){t.warn("ajax[http] -> request to "+o.url+" failed with an exception: "+a.message),o.error&&p.callExternal(t,"ajax.error",o.error,417,a.message)}p.callExternal(t,"ajax.done",r)};return window.cordova.plugin.http.sendRequest(o.url,i,c,c),{done:function(n){return r=n,this}}}(t,o);var r=function(){},i=new XMLHttpRequest;o.timeout&&(i.timeout=o.timeout,i.ontimeout=function(){t.warn("ajax -> request to "+o.url+" timeout"),p.callExternal(t,"ajax.error",o.error,l.HTTP_REQUEST_TIMEOUT,"Timeout")}),i.open(o.method||"POST",o.url,!0),i.onreadystatechange=function(){try{4===i.readyState&&(200===i.status?p.callExternal(t,"ajax.success",o.success,JSON.parse(i.responseText)):(t.warn("ajax -> request to "+o.url+" failed with status "+i.status+" ("+i.statusText+")"),p.callExternal(t,"ajax.error",o.error,i.status,i.statusText)))}catch(n){t.warn("ajax -> request to "+o.url+" failed with an exception: "+n.message),o.error&&o.error(417,n.message,null)}4===i.readyState&&p.callExternal(t,"ajax.done",r)};const c=o.customHeaders;return c&&Object.keys(c).forEach(function(n){t.debug("ajax -> adding custom header: "+n),i.setRequestHeader(n,c[n])}),i.setRequestHeader("Accept","application/json"),t.debug("ajax -> send request to "+o.url),o.data?(i.setRequestHeader("Content-Type","application/json;charset=UTF-8"),i.send(JSON.stringify(o.data))):i.send(),{done:function(n){return r=n,this}}}}(T=e.Utils||(e.Utils={}))}(f||(f={})),function(e){let T;(T=e.Utils||(e.Utils={})).callExternal=function l(d,s,t,...o){try{const r=Array.prototype.slice.call(arguments,3);t&&t.apply(e.store,r)}catch(r){d.logCallbackException(s,r)}}}(f||(f={})),function(e){let T;var p;(p=T=e.Utils||(e.Utils={})).delay=function l(t,o){return setTimeout(t,o)},p.debounce=function d(t,o){let r=null;const i=function(n,a){r=null,t()};return function(){r&&window.clearTimeout(r),r=setTimeout(i,o)}},p.asyncDelay=function s(t){return new Promise(o=>setTimeout(o,t))}}(f||(f={})),function(e){let T;var p;(p=T=e.Utils||(e.Utils={})).formatBillingCycleEN=function l(s){switch(function d(s){var t;const o=null!==(t=s.billingCycles)&&void 0!==t?t:0;if(s.recurrenceMode===e.RecurrenceMode.FINITE_RECURRING){if(1==o)return e.RecurrenceMode.NON_RECURRING;if(o<=0)return e.RecurrenceMode.INFINITE_RECURRING}return s.recurrenceMode}(s)){case e.RecurrenceMode.FINITE_RECURRING:return`${s.billingCycles}x ${p.formatDurationEN(s.billingPeriod)}`;case e.RecurrenceMode.NON_RECURRING:return"for "+p.formatDurationEN(s.billingPeriod);default:return"every "+p.formatDurationEN(s.billingPeriod,{omitOne:!0})}}}(f||(f={})),function(e){let T;(T=e.Utils||(e.Utils={})).formatDurationEN=function l(d,s){if(!d)return"";const t=d.length,o=d.slice(1,t-1);return"1"===o?null!=s&&s.omitOne?{D:"day",W:"week",M:"month",Y:"year"}[d[t-1]]||d[t-1]:{D:"1 day",W:"1 week",M:"1 month",Y:"1 year"}[d[t-1]]||d[t-1]:`${o} ${{D:"days",W:"weeks",M:"months",Y:"years"}[d[t-1]]||d[t-1]}`}}(f||(f={})),function(e){let T;!function(p){const l="0123456789abcdef".split("");function d(_){for(var g="",S=0;S<4;S++)g+=l[_>>8*S+4&15]+l[_>>8*S&15];return g}function s(_){const g=[];for(var S=_.length,y=0;y<S;y++)g.push(d(_[y]));return g.join("")}function t(_,g){return _+g&4294967295}function o(_,g,S,y,I,E,m){return function P(b,N,v){return t(b<<N|b>>>32-N,v)}(function O(b,N,v,D){return t(t(N,b),t(v,D))}(_,g,y,E),I,S)}var r=function(_,g,S,y,I,E,m,P){return o(S&y|~S&I,g,S,E,m,P)},i=function(_,g,S,y,I,E,m,P){return o(S&I|y&~I,g,S,E,m,P)},c=function(_,g,S,y,I,E,m,P){return o(S^y^I,g,S,E,m,P)},n=function(_,g,S,y,I,E,m,P){return o(y^(S|~I),g,S,E,m,P)};function a(_,g,S){S||(S=t);let y=_[0],I=_[1],E=_[2],m=_[3];var P=r.bind(null,S);y=P(y,I,E,m,g[0],7,-680876936),m=P(m,y,I,E,g[1],12,-389564586),E=P(E,m,y,I,g[2],17,606105819),I=P(I,E,m,y,g[3],22,-1044525330),y=P(y,I,E,m,g[4],7,-176418897),m=P(m,y,I,E,g[5],12,1200080426),E=P(E,m,y,I,g[6],17,-1473231341),I=P(I,E,m,y,g[7],22,-45705983),y=P(y,I,E,m,g[8],7,1770035416),m=P(m,y,I,E,g[9],12,-1958414417),E=P(E,m,y,I,g[10],17,-42063),I=P(I,E,m,y,g[11],22,-1990404162),y=P(y,I,E,m,g[12],7,1804603682),m=P(m,y,I,E,g[13],12,-40341101),E=P(E,m,y,I,g[14],17,-1502002290),I=P(I,E,m,y,g[15],22,1236535329);var O=i.bind(null,S);y=O(y,I,E,m,g[1],5,-165796510),m=O(m,y,I,E,g[6],9,-1069501632),E=O(E,m,y,I,g[11],14,643717713),I=O(I,E,m,y,g[0],20,-373897302),y=O(y,I,E,m,g[5],5,-701558691),m=O(m,y,I,E,g[10],9,38016083),E=O(E,m,y,I,g[15],14,-660478335),I=O(I,E,m,y,g[4],20,-405537848),y=O(y,I,E,m,g[9],5,568446438),m=O(m,y,I,E,g[14],9,-1019803690),E=O(E,m,y,I,g[3],14,-187363961),I=O(I,E,m,y,g[8],20,1163531501),y=O(y,I,E,m,g[13],5,-1444681467),m=O(m,y,I,E,g[2],9,-51403784),E=O(E,m,y,I,g[7],14,1735328473),I=O(I,E,m,y,g[12],20,-1926607734);var b=c.bind(null,S);y=b(y,I,E,m,g[5],4,-378558),m=b(m,y,I,E,g[8],11,-2022574463),E=b(E,m,y,I,g[11],16,1839030562),I=b(I,E,m,y,g[14],23,-35309556),y=b(y,I,E,m,g[1],4,-1530992060),m=b(m,y,I,E,g[4],11,1272893353),E=b(E,m,y,I,g[7],16,-155497632),I=b(I,E,m,y,g[10],23,-1094730640),y=b(y,I,E,m,g[13],4,681279174),m=b(m,y,I,E,g[0],11,-358537222),E=b(E,m,y,I,g[3],16,-722521979),I=b(I,E,m,y,g[6],23,76029189),y=b(y,I,E,m,g[9],4,-640364487),m=b(m,y,I,E,g[12],11,-421815835),E=b(E,m,y,I,g[15],16,530742520),I=b(I,E,m,y,g[2],23,-995338651);var N=n.bind(null,S);y=N(y,I,E,m,g[0],6,-198630844),m=N(m,y,I,E,g[7],10,1126891415),E=N(E,m,y,I,g[14],15,-1416354905),I=N(I,E,m,y,g[5],21,-57434055),y=N(y,I,E,m,g[12],6,1700485571),m=N(m,y,I,E,g[3],10,-1894986606),E=N(E,m,y,I,g[10],15,-1051523),I=N(I,E,m,y,g[1],21,-2054922799),y=N(y,I,E,m,g[8],6,1873313359),m=N(m,y,I,E,g[15],10,-30611744),E=N(E,m,y,I,g[6],15,-1560198380),I=N(I,E,m,y,g[13],21,1309151649),y=N(y,I,E,m,g[4],6,-145523070),m=N(m,y,I,E,g[11],10,-1120210379),E=N(E,m,y,I,g[2],15,718787259),I=N(I,E,m,y,g[9],21,-343485551),_[0]=S(y,_[0]),_[1]=S(I,_[1]),_[2]=S(E,_[2]),_[3]=S(m,_[3])}function u(_){for(var g=[],S=0;S<64;S+=4)g[S>>2]=_.charCodeAt(S)+(_.charCodeAt(S+1)<<8)+(_.charCodeAt(S+2)<<16)+(_.charCodeAt(S+3)<<24);return g}function h(_,g){let S;const y=_.length,I=[1732584193,-271733879,-1732584194,271733878];for(S=64;S<=y;S+=64)a(I,u(_.substring(S-64,S)),g);const E=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],m=(_=_.substring(S-64)).length;let P;for(P=0;P<m;P++)E[P>>2]|=_.charCodeAt(P)<<(P%4<<3);if(E[P>>2]|=128<<(P%4<<3),P>55)for(a(I,E,g),P=16;P--;)E[P]=0;return E[14]=8*y,a(I,E,g),I}p.md5=function R(_){if(!_)return"";let g;return"5d41402abc4b2a76b9719d911017c592"!==s(h("hello"))&&(g=function(S,y){const I=(65535&S)+(65535&y);return(S>>16)+(y>>16)+(I>>16)<<16|65535&I}),s(h(_,g))}}(T=e.Utils||(e.Utils={}))}(f||(f={})),function(e){let T;!function(p){function d(s,t,o,r,i,c){i||(i=o.name||"#"+p.md5(o.toString())),setTimeout(()=>{try{s.debug(`Calling callback: type=${t} name=${i} reason=${c}`),o(r)}catch(n){s.error(`Error in callback: type=${t} name=${i} reason=${c}`),s.debug(o.toString());const a=n;"message"in a&&s.error(a.message),"fileName"in n&&s.error("in "+n.fileName+":"+n.lineNumber),"stack"in a&&s.error(a.stack)}},0)}p.safeCallback=function l(s,t,o,r,i){return function(c){d(s,t,o,c,r,i)}},p.safeCall=d}(T=e.Utils||(e.Utils={}))}(f||(f={})),function(e){let T;(T=e.Utils||(e.Utils={})).uuidv4=function d(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(s){return(s^function l(){return window.crypto||window.msCrypto}().getRandomValues(new Uint8Array(1))[0]&15>>s/4).toString(16)})}}(f||(f={})),function(e){let T;!function(p){let l;(l=p.Internal||(p.Internal={})).getDeviceInfo=function r(i){const c=function o(i){return"string"==typeof i.validator_privacy_policy?i.validator_privacy_policy.split(","):function s(i){return"[object Array]"===Object.prototype.toString.call(i)}(i.validator_privacy_policy)?i.validator_privacy_policy:["analytics","support","fraud"]}(i);function n(_){return c.indexOf(_)>=0}const a={plugin:"cordova-plugin-purchase/"+e.PLUGIN_VERSION},u=window,h=function t(i){return"[object Object]"===Object.prototype.toString.call(i)}(u.device)?u.device:{};if(n("analytics")||n("support")){const _=u.Ionic||u.ionic;_&&_.version&&(a.ionic=_.version),h.cordova&&(a.cordova=h.cordova),h.model&&(a.model=h.model),h.platform&&(a.platform=h.platform),h.version&&(a.version=h.version),h.manufacturer&&(a.manufacturer=h.manufacturer)}if(n("tracking")&&(h.serial&&(a.serial=h.serial),h.uuid&&(a.uuid=h.uuid)),h.isVirtual&&(a.isVirtual=h.isVirtual),n("fraud")){var R="";h.serial?R="serial:"+h.serial:h.uuid?R="uuid:"+h.uuid:(h.model&&(R+="/"+h.model),h.manufacturer&&(R="/"+h.manufacturer)),R&&(a.fingerprint=e.Utils.md5(R))}return a}}(T=e.Validator||(e.Validator={}))}(f||(f={})),function(e){let T;!function(p){let l;l=p.Request||(p.Request={})}(T=e.Validator||(e.Validator={}))}(f||(f={})),function(e){e.VerifiedReceipt=class T{constructor(l,d,s){var t;this.className="VerifiedReceipt",this.id=d.id,this.sourceReceipt=l,this.collection=null!==(t=d.collection)&&void 0!==t?t:[],this.latestReceipt=d.latest_receipt,this.nativeTransactions=[d.transaction],this.warning=d.warning,Object.defineProperty(this,"raw",{enumerable:!1,get:()=>d}),Object.defineProperty(this,"finish",{enumerable:!1,get(){return()=>s.finish(this)}})}get platform(){return this.sourceReceipt.platform}get raw(){return{}}set(l,d){var s;this.id=d.id,this.sourceReceipt=l,this.collection=null!==(s=d.collection)&&void 0!==s?s:[],this.latestReceipt=d.latest_receipt,this.nativeTransactions=[d.transaction],this.warning=d.warning}finish(){return A(this,void 0,void 0,function*(){})}}}(f||(f={}))}}]);