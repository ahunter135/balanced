"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[8204],{6865:(b,E,n)=>{n.d(E,{A_:()=>v,Dw:()=>m,ML:()=>c,YV:()=>u,_W:()=>T,bE:()=>t,bQ:()=>g,h0:()=>_,iS:()=>p,ty:()=>h});var o=n(553);const a=o.N.useFunctionsEmulator&&!o.N.production?"http://localhost:5001/balanced-budget-90f1f/us-central1/":"https://us-central1-balanced-budget-90f1f.cloudfunctions.net/",_=a+"getTransactionData",g=a+"createPlaidLinkToken",m=a+"relinkPlaidLinkToken",u=a+"exchangePublicToken",t=a+"removeLinkedAccount",c=a+"createFinicityLinkToken",T=a+"getFinicityAcccountsByUser",h=a+"getFinicityInstitutionById",p=a+"getFinicityTransactions",v=a+"getFinicityCustomerId"},3554:(b,E,n)=>{n.d(E,{e:()=>m});var o=n(6814),a=n(95),_=n(5548),g=n(6689);let m=(()=>{class u{}return u.\u0275fac=function(t){return new(t||u)},u.\u0275mod=g.oAB({type:u}),u.\u0275inj=g.cJS({imports:[o.ez,a.u5,_.Pc]}),u})()},2846:(b,E,n)=>{function o(a){const _=a.datetime?new Date(a.datetime):new Date(a.date);return{id:a.transaction_id,amount:a.amount,subcategoryId:"",date:_,merchant_name:a.merchant_name,name:a.name,pending:a.pending}}n.d(E,{d:()=>o})},8452:(b,E,n)=>{n.d(E,{q:()=>u});var o=n(5861),a=n(4092),_=n(182),g=n(15),m=n(6689);let u=(()=>{class d extends a.q{constructor(){super(_.lN)}get(c,T){var h=()=>super._get,p=this;return(0,o.Z)(function*(){const v=yield h().call(p,d.makeCollectionRef(c),T);return p.convertTimestampToDate(v)})()}getAll(){var c=()=>super._getAll,T=this;return(0,o.Z)(function*(){const h=yield c().call(T);return h.docs&&(h.docs=h.docs.map(p=>T.convertTimestampToDate(p))),h})()}getAllFromParent(c){var T=()=>super._getAllFromParent,h=this;return(0,o.Z)(function*(){const p=yield T().call(h,d.makeCollectionRef(c));return p.docs&&(p.docs=p.docs.map(v=>h.convertTimestampToDate(v))),p})()}getByQuery(c){var T=()=>super._getByQuery,h=this;return(0,o.Z)(function*(){const p=yield T().call(h,c);return p.docs&&(p.docs=p.docs.map(v=>h.convertTimestampToDate(v))),p})()}add(c,T,h){var p=()=>super._add,v=this;return(0,o.Z)(function*(){return p().call(v,d.makeCollectionRef(c),T,h)})()}update(c,T,h){var p=()=>super._update,v=this;return(0,o.Z)(function*(){return p().call(v,d.makeCollectionRef(c),T,h)})()}delete(c,T,h=!1){var p=()=>super._delete,v=this;return(0,o.Z)(function*(){return p().call(v,d.makeCollectionRef(c),T,h)})()}static makeCollectionRef(c){return(0,g.hJ)((0,g.ad)(),_.YP,c,_.lN)}convertTimestampToDate(c){if(!c)return c;const T=c.last_transaction_retrieval;return T&&(c.last_transaction_retrieval=T.toDate()),c}}return d.\u0275fac=function(c){return new(c||d)},d.\u0275prov=m.Yz7({token:d,factory:d.\u0275fac,providedIn:"root"}),d})()},1269:(b,E,n)=>{n.d(E,{O:()=>_});var o=n(6689),a=n(9862);let _=(()=>{class g{constructor(u){this.http=u}post(u,d){return this.http.post(u,d,{headers:this.getHeaders()})}getHeaders(){return{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"}}}return g.\u0275fac=function(u){return new(u||g)(o.LFG(a.eN))},g.\u0275prov=o.Yz7({token:g,factory:g.\u0275fac,providedIn:"root"}),g})()},1914:(b,E,n)=>{n.d(E,{O:()=>R});var o=n(5861),a=n(6306),_=n(6973);function g(y,O){const s="object"==typeof O;return new Promise((e,i)=>{let l,r=!1;y.subscribe({next:f=>{l=f,r=!0},error:i,complete:()=>{r?e(l):s?e(O.defaultValue):i(new _.K)}})})}var m=n(6865),u=n(2846),d=n(6689),t=n(1269),c=n(8452),T=n(7195),h=n(6635),p=n(5548),v=n(3076);let R=(()=>{class y{get plaidAvailable(){return this.userService.isPremium}constructor(s,e,i,r,l,f){this.http=s,this.linkedAccountsRepository=e,this.userRepository=i,this.transactionPublisher=r,this.loadingController=l,this.userService=f}linkPlaidToUser(){var s=this;return(0,o.Z)(function*(){if(!s.plaidAvailable)return;const e=yield s.loadingController.create();yield e.present(),s.http.post(m.bQ,{user_id:s.userRepository.getCurrentUserId()}).pipe((0,a.K)(i=>(console.log(i),e.dismiss(),i))).subscribe(i=>{console.log(i);const r=s.createPlaidHandlerLink(i.link_token);e.dismiss(),r.open()})})()}syncPlaidTransactions(){var s=this;return(0,o.Z)(function*(){if(!s.plaidAvailable)return;const e=s.userRepository.getCurrentUserId();if(!e)throw new Error("User is not logged in");const i=(yield s.linkedAccountsRepository.getAllFromParent(e)).docs;if(0===i.length)return;const r=[];for(let C of i)if(C.isPlaid){if(!(yield s.shouldSyncTransactions(C)))continue;r.push(g(s.http.post(m.h0,{userId:e,linkedAccount:C,linkedAccountId:C.id})))}const l=yield Promise.all(r);let f=[],P=[],I=[];for(let C=0;C<l.length;C++){const A=l[C];f=f.concat(A.added),P=P.concat(A.removed),I=I.concat(A.modified)}s.plaidTransactionSyncHandler(f,P,I,!0)})()}removePlaidLinkedAccount(s){var e=this;return(0,o.Z)(function*(){const i=e.userRepository.getCurrentUserId();if(!i)throw new Error("User is not logged in");e.http.post(m.bE,{user_id:i,linked_account_id:s.id}).subscribe(r=>{console.log(r)})})()}relinkPlaidLinkedAccount(s,e){var i=this;return(0,o.Z)(function*(){if(!i.plaidAvailable)return;const r=yield i.loadingController.create();yield r.present(),i.http.post(m.Dw,{user_id:i.userRepository.getCurrentUserId(),linked_account_id:s.id}).pipe((0,a.K)(l=>(console.log(l),r.dismiss(),l))).subscribe(l=>{console.log(l);const f=i.createPlaidHandlerRelink(l.link_token,i.userRepository.getCurrentUserId(),s.id,e);r.dismiss(),f.open()})})()}createPlaidHandlerLink(s){return Plaid.create({token:s,onSuccess:this.plaidHandlerOnSuccessCallback.bind(this),onExit:this.plaidHandlerOnExitCallback.bind(this),onLoad:this.plaidHandlerOnLoadCallback.bind(this),onEvent:this.plaidHandlerOnEventCallback.bind(this),receivedRedirectUri:null})}createPlaidHandlerRelink(s,e,i,r){return Plaid.create({token:s,onSuccess:(l,f)=>{i&&this.linkedAccountsRepository.update(e,i,{link_status:{required_action:"NONE"}}).then(P=>{P&&r&&r(i)})},onExit:this.plaidHandlerOnExitCallback.bind(this),onLoad:this.plaidHandlerOnLoadCallback.bind(this),onEvent:this.plaidHandlerOnEventCallback.bind(this),receivedRedirectUri:null})}plaidHandlerOnSuccessCallback(s,e){this.http.post(m.YV,{publicToken:s,institutionName:e.institution.name,userId:this.userRepository.getCurrentUserId()}).subscribe(i=>{console.log(i);const{added:r,removed:l,modified:f}=i;this.plaidTransactionSyncHandler(r,l,f,!0)})}plaidHandlerOnExitCallback(s,e){return(0,o.Z)(function*(){console.log(s)})()}plaidHandlerOnLoadCallback(){return(0,o.Z)(function*(){})()}plaidHandlerOnEventCallback(s,e){return(0,o.Z)(function*(){})()}plaidTransactionSyncHandler(s,e,i,r=!0){var l=this;return(0,o.Z)(function*(){const C={from:"plaid",addedTransactions:s.map(u.d),removedTransactions:e.map(u.d),modifiedTransactions:i.map(u.d)};return r&&l.transactionPublisher.publishEvent(C),C})()}shouldSyncTransactions(s){return(0,o.Z)(function*(){if(!s.last_transaction_retrieval)return!0;const i=s.last_transaction_retrieval;return(new Date).getTime()-i.getTime()>3e5})()}}return y.\u0275fac=function(s){return new(s||y)(d.LFG(t.O),d.LFG(c.q),d.LFG(T.E),d.LFG(h.u),d.LFG(p.HT),d.LFG(v.K))},y.\u0275prov=d.Yz7({token:y,factory:y.\u0275fac,providedIn:"root"}),y})()},6635:(b,E,n)=>{n.d(E,{u:()=>a});var o=n(6689);let a=(()=>{class _{constructor(){this.subscribers=new Set}publishEvent(m){this.subscribers.forEach(u=>{u.onTransactionEvent(m)})}subscribe(m){this.subscribers.add(m)}unsubscribe(m){this.subscribers.delete(m)}}return _.\u0275fac=function(m){return new(m||_)},_.\u0275prov=o.Yz7({token:_,factory:_.\u0275fac,providedIn:"root"}),_})()},8204:(b,E,n)=>{n.r(E),n.d(E,{Tab2PageModule:()=>s});var o=n(5548),a=n(6814),_=n(95),g=n(3554),m=n(4798),u=n(5861),d=n(98),t=n(6689),c=n(1269),T=n(7195),h=n(1914);function p(e,i){if(1&e&&(t.TgZ(0,"ion-select-option",7),t._uU(1),t.qZA()),2&e){const r=i.$implicit;t.Q6J("value",r),t.xp6(1),t.Oqu(r.name)}}function v(e,i){if(1&e){const r=t.EpF();t.TgZ(0,"ion-card",2),t.NdJ("click",function(){const P=t.CHM(r).index,I=t.oxw();return t.KtG(I.openTransactionSorter(P))}),t.TgZ(1,"ion-card-header")(2,"ion-card-subtitle"),t._uU(3),t.qZA()(),t.TgZ(4,"ion-card-content"),t._uU(5),t.ALo(6,"currency"),t._UZ(7,"br"),t._uU(8),t.qZA()()}if(2&e){const r=i.$implicit;t.xp6(3),t.hij(" ",r.name," "),t.xp6(2),t.hij(" ",t.lcZ(6,3,r.amount),""),t.xp6(3),t.hij("",r.date," ")}}const y=[{path:"",component:(()=>{class e{constructor(r,l,f,P){this.http=r,this.modalCtrl=l,this.userRepository=f,this.plaidService=P,this.user={},this.transactions=[],this.institutions=[],this.institutionName=""}ngOnInit(){}sortTransactions(){var r=this;return(0,u.Z)(function*(){r.transactions.sort((l,f)=>{const P=new Date(l.date);return new Date(f.date).getTime()-P.getTime()})})()}openTransactionSorter(r){var l=this;return(0,u.Z)(function*(){(yield l.modalCtrl.create({component:d.m,componentProps:{transaction:l.transactions[r]},initialBreakpoint:.6,breakpoints:[0,.6,.8,1]})).present()})()}link(){var r=this;return(0,u.Z)(function*(){r.plaidService.linkPlaidToUser()})()}}return e.\u0275fac=function(r){return new(r||e)(t.Y36(c.O),t.Y36(o.IN),t.Y36(T.E),t.Y36(h.O))},e.\u0275cmp=t.Xpm({type:e,selectors:[["app-tab2"]],decls:13,vars:5,consts:[[3,"translucent"],["slot","end"],[3,"click"],[3,"fullscreen"],["label","Institution","label-placement","floating",3,"ngModel","ngModelChange"],[3,"value",4,"ngFor","ngForOf"],[3,"click",4,"ngFor","ngForOf"],[3,"value"]],template:function(r,l){1&r&&(t.TgZ(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),t._uU(3," Tab 2 "),t.qZA(),t.TgZ(4,"ion-buttons",1)(5,"ion-button",2),t.NdJ("click",function(){return l.link()}),t._uU(6,"Link"),t.qZA()()()(),t.TgZ(7,"ion-content",3)(8,"ion-item")(9,"ion-select",4),t.NdJ("ngModelChange",function(P){return l.selectedInstitute=P}),t.YNc(10,p,2,2,"ion-select-option",5),t.qZA()(),t.TgZ(11,"ion-list"),t.YNc(12,v,9,5,"ion-card",6),t.qZA()()),2&r&&(t.Q6J("translucent",!0),t.xp6(7),t.Q6J("fullscreen",!0),t.xp6(2),t.Q6J("ngModel",l.selectedInstitute),t.xp6(1),t.Q6J("ngForOf",l.institutions),t.xp6(2),t.Q6J("ngForOf",l.transactions))},dependencies:[o.YG,o.Sm,o.PM,o.FN,o.Zi,o.tO,o.W2,o.Gu,o.Ie,o.q_,o.t9,o.n0,o.wd,o.sr,o.QI,a.sg,_.JJ,_.On,a.H9]}),e})()}];let O=(()=>{class e{}return e.\u0275fac=function(r){return new(r||e)},e.\u0275mod=t.oAB({type:e}),e.\u0275inj=t.cJS({imports:[m.Bz.forChild(y),m.Bz]}),e})(),s=(()=>{class e{}return e.\u0275fac=function(r){return new(r||e)},e.\u0275mod=t.oAB({type:e}),e.\u0275inj=t.cJS({imports:[o.Pc,a.ez,_.u5,g.e,O]}),e})()}}]);